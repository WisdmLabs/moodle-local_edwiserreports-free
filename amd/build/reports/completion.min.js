"use strict";define("local_edwiserreports/reports/completion",["jquery","core/ajax","core/notification","local_edwiserreports/common","local_edwiserreports/defaultconfig","local_edwiserreports/jquery","local_edwiserreports/select2","local_edwiserreports/flatpickr"],function(e,t,o,n,r,a){var l={PAGE:".report-content",EXPORT:".report-export",COHORT:".report-content .cohort-select",COURSE:".report-content .course-select",GROUP:".report-content .group-select",EXCLUDE:".report-content .exclude-select",INACTIVE:".report-content .inactive-select",PROGRESS:".report-content .progress-select",GRADE:".report-content .grade-select",LENGTH:".report-content .length-select",SEARCH:".report-content .table-search-input input",PAGETITLE:".report-header .page-title h2",FORMFILTER:'.report-content .download-links [name="filter"]',DATE:".edwiserreports-calendar",DATEMENU:".edwiserreports-calendar + .dropdown-menu",DATEITEM:".edwiserreports-calendar + .dropdown-menu .dropdown-item",DATEPICKER:".edwiserreports-calendar + .dropdown-menu .dropdown-calendar",DATEPICKERINPUT:".edwiserreports-calendar + .dropdown-menu .flatpickr",SUMMARY:"#wdm-completion-individual .summary-card"},s={cohort:0,course:null,group:0,exclude:[],enrolment:"all",inactive:"all",progress:"all",grade:"all"};let c=null;var i=null;let d={GET_DATA:function(){return e.ajax({url:r.requestUrl,type:r.requestType,dataType:r.requestDataType,data:{action:"get_completion_data_ajax",sesskey:M.local_edwiserreports.secret,lang:e("html").attr("lang"),data:JSON.stringify(s)}})},GET_SUMMARY_CARD_DATA:function(e,o,n){return t.call([{methodname:"local_edwiserreports_get_summary_card_data",args:{report:"completionblock",course:e,cohort:o,group:n}}],!1)[0]}};function u(){n.loader.show(l.PAGE),e(l.PAGE).find('.download-links input[name="filter"]').val(JSON.stringify(s)),d.GET_DATA(s).done(function(t){null!==i&&i.destroy(),e(l.PAGETITLE).text(t.name),(i=e(l.PAGE).find(".table").DataTable({dom:'<"edwiserreports-table"<"table-filter d-flex"i><t><"table-pagination"p>>',data:t.data,pageLength:e(l.LENGTH).val(),deferRendering:!0,language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nostudentsenrolled","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:" ",next:" "}},columnDefs:[{className:"fixed-column",targets:0},{className:"text-left",targets:[0,1,2]},{className:"text-right",targets:"_all"}],columns:[{data:"username"},{data:"enrolledon"},{data:"enrolltype"},{data:"noofvisits"},{data:"completion"},{data:"compleiontime"},{data:"grade"},{data:"lastaccess"}],drawCallback:function(){n.stylePaginationButton(this)},initComplete:function(){n.loader.hide(l.PAGE)}})).columns(0).search(e(l.SEARCH).val()),i.page.len(e(l.LENGTH).val()).draw()}).fail(function(e){o.exception(e),n.loader.hide(l.PAGE)})}function p(e,t,o,r){n.loader.show(l.PAGE),n.reloadFilter(l.PAGE,e,t,o,0,r)}function E(t){n.updateTimeLabel("all"),n.handleSearchInput(),e(l.PAGE).find(".singleselect").not(l.EXCLUDE).select2(),e(l.EXCLUDE).select2({placeholder:M.util.get_string("exclude","local_edwiserreports"),allowClear:!0}),c=a(l.DATEPICKERINPUT).flatpickr({mode:"range",altInput:!0,altFormat:"d M Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:e(l.DATEPICKER).get(0),onOpen:function(){e(l.DATEMENU).addClass("withcalendar"),setTimeout(function(){e(l.DATEMENU).offset().left<e(l.PAGE).parent().offset().left&&e(l.DATEMENU).css("left",e(l.DATEMENU).closest(".filter-selector").css("padding-left"))},500)},onChange:function(){e(l.DATEMENU).offset().left<e(l.PAGE).parent().offset().left&&e(l.DATEMENU).css("left",e(l.DATEMENU).closest(".filter-selector").css("padding-left"))},onClose:function(){e(l.DATEMENU).removeClass("withcalendar"),function(){let t=e(l.DATEPICKERINPUT).val(),o=e(l.DATEPICKERINPUT).next().val().replace("to","-");e(l.DATEPICKERINPUT).next().val(o),t.includes(" to ")?(e(l.DATEITEM).removeClass("active"),e(l.DATEITEM+".custom").addClass("active"),e(l.DATE).html(o),s.enrolment=t,u(),n.updateTimeLabel(t)):c.clear()}()}}),e("body").on("click",l.DATEITEM+":not(.custom)",function(){e(l.DATEITEM).removeClass("active"),e(this).addClass("active"),e(l.DATE).html(e(this).text()),c.clear(),s.enrolment=e(this).data("value"),u(),n.updateTimeLabel(s.enrolment)}),s.course=e(l.COURSE).val(),e("body").on("change",l.COHORT,function(){s.cohort=e(this).val(),s.group=0,p(["course","noallcourses"],s.cohort,s.course,function(){0==e(l.COURSE).find(`option[value="${s.course}"]`).length&&(s.course=e(l.COURSE).find("option:first").attr("value")),p(["group"],s.cohort,s.course,function(){u()})})}),e("body").on("change",l.COURSE,function(){s.course=e(this).val(),s.group=0,d.GET_SUMMARY_CARD_DATA(s.course,s.cohort,s.group).done(function(e){e=JSON.parse(e),n.refreshSummarycard("group",e,l.SUMMARY,function(){})}),p(["group"],s.cohort,s.course,function(){u()})}),e("body").on("change",l.GROUP,function(){s.group=e(this).val(),u()}),e("body").on("change",l.LENGTH,function(){i.page.len(this.value).draw()}),e("body").on("input",l.SEARCH,function(){i.column(0).search(this.value).draw()}),e("body").on("change",l.EXCLUDE,function(){s.exclude=e(this).val(),e(this).toggleClass("notselected",0==s.exclude.length),e(this).toggleClass("selected",0!=s.exclude.length),e(l.INACTIVE).closest(".filter-selector").toggle(-1==s.exclude.indexOf("2")&&-1==s.exclude.indexOf("3")),u()}),e("body").on("change",l.PROGRESS,function(){s.progress=e(this).val(),u()}),e("body").on("change",l.INACTIVE,function(){s.inactive=e(this).val(),u()}),e("body").on("change",l.GRADE,function(){s.grade=e(this).val(),u()}),u()}return{init:function(t){e(document).ready(function(){E()})}}});
//# sourceMappingURL=completion.min.js.map
