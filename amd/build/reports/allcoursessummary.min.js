define("local_edwiserreports/reports/allcoursessummary",["jquery","core/ajax","core/notification","core/modal_factory","core/modal_events","core/fragment","local_edwiserreports/defaultconfig","local_edwiserreports/common","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4","local_edwiserreports/select2","local_edwiserreports/flatpickr"],function(e,t,a,r,o,l,s,n){var i={PAGE:"#allcoursessummary",TABLE:"#allcoursessummary table",FORMFILTER:'#allcoursessummary .download-links [name="filter"]',COHORT:"#allcoursessummary .cohort-select",EXCLUDE:"#allcoursessummary .exclude-select",GROUP:"#allcoursessummary .group-select",SEARCH:"#allcoursessummary .table-search-input input",LENGTH:"#allcoursessummary .length-select",MODALTRIGGER:"#allcoursessummary table a.modal-trigger",MODALSEARCH:".allcoursessummary-modal .table-search-input input",DATE:".edwiserreports-calendar",DATEMENU:".edwiserreports-calendar + .dropdown-menu",DATEITEM:".edwiserreports-calendar + .dropdown-menu .dropdown-item",DATEPICKER:".edwiserreports-calendar + .dropdown-menu .dropdown-calendar",DATEPICKERINPUT:".edwiserreports-calendar + .dropdown-menu .flatpickr"};let d=null;var c=null,u={cohort:0,coursegroup:0,exclude:[],enrolment:"all"},m={GET_DATA:function(){return e.ajax({url:s.requestUrl,type:s.requestType,dataType:s.requestDataType,data:{action:"get_allcoursessummary_data",secret:M.local_edwiserreports.secret,lang:e("html").attr("lang"),data:JSON.stringify(u)}})},GET_FILTER_DATA:function(e,a){return t.call([{methodname:"local_edwiserreports_get_filter_data",args:{types:e,cohort:a}}],!1)[0]}};function p(){e(i.FORMFILTER).val(JSON.stringify(u)),n.loader.show(i.PAGE),null!==c&&c.destroy(),m.GET_DATA(u).then(function(t){(c=e(i.TABLE).DataTable({data:t,dom:'<"edwiserreports-table"<"p-2"i><t><"table-pagination"p>>',columnDefs:[{className:"fixed-column",targets:0},{className:"text-left",targets:[0,1,2]},{className:"text-right",targets:"_all"}],columns:[{data:"coursename",width:"14rem"},{data:"category",width:"14rem"},{data:"enrolments"},{data:"completed"},{data:"notstarted"},{data:"inprogress"},{data:"atleastoneactivitystarted",width:"8rem"},{data:"totalactivities",width:"5rem"},{data:"avgprogress",width:"6rem"},{data:"avggrade",width:"4rem"},{data:"highestgrade",width:"4rem"},{data:"lowestgrade",width:"4rem"},{data:"totaltimespent",render:function(e){return n.timeFormatter(e)},width:"5rem"},{data:"avgtimespent",render:function(e){return n.timeFormatter(e)},width:"5rem"}],columnDefs:[{className:"fixed-column",targets:0},{className:"text-left",targets:[0,1]},{className:"text-right",targets:"_all"}],language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nocourses","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:"&#9666",next:"&#9656"}},drawCallback:function(){n.stylePaginationButton(this)},initComplete:function(){n.loader.hide(i.PAGE)}})).columns(0).search(e(i.SEARCH).val()),c.page.len(e(i.LENGTH).val()).draw()}).fail(function(e){a.exception(e),n.loader.hide(i.PAGE)})}var g=null;return{init:function(){e(document).ready(function(){e(i.PAGE).find(".singleselect").not(i.EXCLUDE).select2(),e(i.EXCLUDE).select2({placeholder:M.util.get_string("exclude","local_edwiserreports"),allowClear:!0}),n.handleSearchInput(),p(),e("body").on("change",i.LENGTH,function(){c.page.len(this.value).draw()}),e("body").on("input",i.SEARCH,function(){c.column(0).search(this.value).draw()}),e("body").on("input",i.MODALSEARCH,function(){g.search(this.value).draw()}),e("body").on("change",i.COHORT,function(){u.cohort=e(this).val(),u.coursegroup=0,m.GET_FILTER_DATA(["coursegroup"],u.cohort).done(function(e){e=JSON.parse(e),n.refreshFilter("group",e,i.PAGE,function(){p()})})}),e("body").on("change",i.EXCLUDE,function(){u.exclude=e(this).val(),e(this).toggleClass("notselected",0==u.exclude.length),e(this).toggleClass("selected",0!=u.exclude.length),p()}),d=e(i.DATEPICKERINPUT).flatpickr({mode:"range",altInput:!0,altFormat:"d M Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:e(i.DATEPICKER).get(0),onOpen:function(){e(i.DATEMENU).addClass("withcalendar"),setTimeout(function(){e(i.DATEMENU).offset().left<e(i.PAGE).parent().offset().left&&e(i.DATEMENU).css("left",e(i.DATEMENU).closest(".filter-selector").css("padding-left"))},500)},onChange:function(){e(i.DATEMENU).offset().left<e(i.PAGE).parent().offset().left&&e(i.DATEMENU).css("left",e(i.DATEMENU).closest(".filter-selector").css("padding-left"))},onClose:function(){e(i.DATEMENU).removeClass("withcalendar"),function t(){let a=e(i.DATEPICKERINPUT).val(),r=e(i.DATEPICKERINPUT).next().val().replace("to","-");if(e(i.DATEPICKERINPUT).next().val(r),!a.includes(" to ")){d.clear();return}e(i.DATEITEM).removeClass("active"),e(i.DATEITEM+".custom").addClass("active"),e(i.DATE).html(r),u.enrolment=a,p()}()}}),e("body").on("click",i.DATEITEM+":not(.custom)",function(){e(i.DATEITEM).removeClass("active"),e(this).addClass("active"),e(i.DATE).html(e(this).text()),d.clear(),u.enrolment=e(this).data("value"),p()}),e("body").on("change",i.GROUP,function(){u.coursegroup=e(this).val(),p()}),e("body").on("click",i.MODALTRIGGER,function(){let t=e(this),a=null,s=0!=e(i.GROUP).length?e(i.GROUP).val():"0,0",d=0;d=0==s?0:(s=s.split(","))[1],r.create({body:l.loadFragment("local_edwiserreports","userslist",1,{page:"allcoursessummary",minval:t.data("minvalue"),maxval:t.data("maxvalue"),course:t.data("courseid"),cohortid:u.cohort,group:d})}).then(function(e){a=e.getRoot(),e.getBody().addClass("allcoursessummary-modal"),a.find(".modal-dialog").addClass("modal-lg"),e.setTitle(t.data("coursename")),e.show(),a.on(o.hidden,function(){e.destroy()}),a.on(o.bodyRendered,function(){var e=a.find(".modal-table");e.find("tbody").hasClass("empty")&&e.find("tbody").empty(),g=e.DataTable({language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nousers","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:"&#9666",next:"&#9656"}},dom:'<"edwiserreports-table"i<t><"table-pagination"p>>',drawCallback:function(){n.stylePaginationButton(this)},lengthChange:!1})})})})})}}});
