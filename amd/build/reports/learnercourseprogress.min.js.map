{"version":3,"sources":["reports/learnercourseprogress.js"],"names":["define","$","Notification","common","CFG","SELECTOR","PAGE","SEARCH","LENGTH","LEARNER","TABLE","FORMFILTER","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","flatpickr","dataTable","filter","enrolment","PROMISE","GET_DATA","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","JSON","stringify","initializeDatatable","loader","show","learner","val","statuses","concat","util","get_string","done","response","destroy","never","DataTable","paging","deferRendering","columnDefs","className","targets","columns","width","render","formatDate","Date","timeFormatter","dom","language","info","infoEmpty","emptyTable","zeroRecords","paginate","previous","next","drawCallback","stylePaginationButton","this","hide","search","page","len","draw","fail","ex","exception","_init","updateTimeLabel","parse","find","select2","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","addClass","setTimeout","offset","left","parent","css","closest","onChange","onClose","date","dateAlternate","removeClass","replace","includes","html","clear","on","text","column","value","handleSearchInput","handleReportCapability","init","document","ready"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Learner course progress report page.\n *\n * @package     local_edwiserreports\n * @author      Yogesh Shirsath\n * @copyright   2022 Wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine('local_edwiserreports/reports/learnercourseprogress', [\n    'jquery',\n    'core/notification',\n    'local_edwiserreports/common',\n    'local_edwiserreports/defaultconfig',\n    'local_edwiserreports/select2',\n    'local_edwiserreports/flatpickr'\n], function(\n    $,\n    Notification,\n    common,\n    CFG\n) {\n\n    /**\n     * Selector\n     */\n    var SELECTOR = {\n        PAGE: '#learnercourseprogress',\n        SEARCH: '#learnercourseprogress .table-search-input input',\n        LENGTH: '#learnercourseprogress .length-select',\n        LEARNER: '#learnercourseprogress .student-select',\n        TABLE: '#learnercourseprogress table',\n        FORMFILTER: '#learnercourseprogress .download-links [name=\"filter\"]',\n        DATE: '.edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Flat picker object.\n     */\n    let flatpickr = null;\n\n    /**\n     * Datatable object.\n     */\n    var dataTable = null;\n\n    /**\n     * Filter object.\n     */\n    var filter = {\n        enrolment: 'all'\n    };\n\n    /**\n     * All promises.\n     */\n    var PROMISE = {\n        /**\n         * Get learner course progress table data based on filters.\n         * @param {Object} filter Filter data\n         * @returns {PROMISE}\n         */\n        GET_DATA: function(filter) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_learnercourseprogress_data',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify(filter)\n                },\n            });\n        },\n    }\n\n    /**\n     * Initialize datable.\n     */\n    function initializeDatatable() {\n        common.loader.show(SELECTOR.PAGE);\n\n        if (!learner) {\n            // Updated export filter values.\n            $(SELECTOR.FORMFILTER).val(JSON.stringify(filter));\n        }\n        let statuses = [\n            `<span class=\"warning-tag\">${M.util.get_string('notyetstarted', 'core_completion')}</span>`,\n            `<span class=\"success-tag\">${M.util.get_string('completed', 'core_completion')}</span>`,\n            `<span class=\"danger-tag\">${M.util.get_string('inprogress', 'core_completion')}</span>`\n        ];\n        PROMISE.GET_DATA(filter)\n            .done(function(response) {\n                if (dataTable !== null) {\n                    dataTable.destroy();\n                    dataTable = null;\n                }\n                let never = M.util.get_string('never', 'local_edwiserreports');\n                dataTable = $(SELECTOR.TABLE).DataTable({\n                    data: response,\n                    paging: true,\n                    deferRendering: true,\n                    columnDefs: [\n                        { className: \"fixed-column\", targets: 0 },\n                        { className: \"text-left\", targets: [0, 1] },\n                        { className: \"text-right\", targets: \"_all\" }\n                    ],\n                    columns: [\n                        { data: \"course\", width: \"7rem\" },\n                        {\n                            data: \"status\",\n                            render: function(data) {\n                                return statuses[data];\n                            },\n                            width: \"4rem\"\n                        },\n                        {\n                            data: \"enrolledon\",\n                            render: function(data) {\n                                return `<span class=\"d-none\">${data}</span>` +\n                                    (data == 0 ? '-' : common.formatDate(new Date(data * 1000), \"d MMM yyyy\"));\n                            }\n                        },\n                        {\n                            data: \"completedon\",\n                            render: function(data) {\n                                return `<span class=\"d-none\">${data}</span>` +\n                                    (data == 0 ? '-' : common.formatDate(new Date(data * 1000), \"d MMM yyyy\"));\n                            }\n                        },\n                        {\n                            data: \"lastaccess\",\n                            render: function(data) {\n                                return `<span class=\"d-none\">${data}</span>` +\n                                    (data == 0 ? never : common.formatDate(new Date(data * 1000), \"d MMM yyyy hh:mm TT\"));\n                            },\n                            width: \"6rem\"\n                        },\n                        { data: 'progress' },\n                        { data: \"grade\" },\n                        { data: \"totalactivities\", width: \"5rem\" },\n                        { data: \"completedactivities\", width: \"6rem\" },\n                        { data: \"attemptedactivities\", width: \"6rem\" },\n                        { data: \"visits\" },\n                        {\n                            data: \"timespent\",\n                            render: function(data) {\n                                return common.timeFormatter(data);\n                            }\n                        }\n                    ],\n                    dom: '<\"edwiserreports-table\"i<t><\"table-pagination\"p>>',\n                    language: {\n                        info: M.util.get_string('tableinfo', 'local_edwiserreports'),\n                        infoEmpty: M.util.get_string('infoempty', 'local_edwiserreports'),\n                        emptyTable: M.util.get_string('emptytable', 'local_edwiserreports'),\n                        zeroRecords: M.util.get_string('zerorecords', 'local_edwiserreports'),\n                        paginate: {\n                            previous: \"◀\",\n                            next: \"▶\"\n                        }\n                    },\n                    drawCallback: function() {\n                        common.stylePaginationButton(this);\n                        common.loader.hide(SELECTOR.PAGE);\n                    }\n                });\n                dataTable.columns(0).search($(SELECTOR.SEARCH).val());\n                dataTable.page.len($(SELECTOR.LENGTH).val()).draw();\n            })\n            .fail(function(ex) {\n                Notification.exception(ex);\n                common.loader.hide(SELECTOR.PAGE);\n            });\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function customDateSelected() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // d M Y format\n        $(SELECTOR.DATEPICKERINPUT).next().val(dateAlternate);\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        filter.enrolment = date;\n        initializeDatatable();\n        common.updateTimeLabel(date);\n    }\n\n    /**\n     * Initialize\n     */\n    function init() {\n\n        // Show time period in table info.\n        common.updateTimeLabel('all');\n\n        if (!learner) {\n            filter = JSON.parse($(SELECTOR.FORMFILTER).val());\n        }\n\n        $(SELECTOR.PAGE).find('.singleselect').select2();\n\n        flatpickr = $(SELECTOR.DATEPICKERINPUT).flatpickr({\n            mode: 'range',\n            altInput: true,\n            altFormat: \"d M Y\",\n            dateFormat: \"Y-m-d\",\n            maxDate: \"today\",\n            appendTo: $(SELECTOR.DATEPICKER).get(0),\n            onOpen: function() {\n                $(SELECTOR.DATEMENU).addClass('withcalendar');\n                setTimeout(function() {\n                    if ($(SELECTOR.DATEMENU).offset().left < $(SELECTOR.PAGE).parent().offset().left) {\n                        $(SELECTOR.DATEMENU).css('left', $(SELECTOR.DATEMENU).closest('.filter-selector').css('padding-left'));\n                    }\n                }, 500);\n            },\n            onChange: function() {\n                if ($(SELECTOR.DATEMENU).offset().left < $(SELECTOR.PAGE).parent().offset().left) {\n                    $(SELECTOR.DATEMENU).css('left', $(SELECTOR.DATEMENU).closest('.filter-selector').css('padding-left'));\n                }\n            },\n            onClose: function() {\n                $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                customDateSelected();\n            }\n        });\n\n        /* Date selector listener */\n        $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n            // Set custom selected item as active.\n            $(SELECTOR.DATEITEM).removeClass('active');\n            $(this).addClass('active');\n\n            // Show selected item on dropdown button.\n            $(SELECTOR.DATE).html($(this).text());\n\n            // Clear custom date.\n            flatpickr.clear();\n\n            filter.enrolment = $(this).data('value');\n            initializeDatatable();\n            common.updateTimeLabel(filter.enrolment);\n        });\n\n        if (!learner) {\n            // Observer learner change.\n            $('body').on('change', SELECTOR.LEARNER, function() {\n                filter.learner = $(this).val();\n                initializeDatatable();\n            });\n        }\n\n        // Search in table.\n        $('body').on('input', SELECTOR.SEARCH, function() {\n            dataTable.column(0).search(this.value).draw();\n        });\n\n        // Observer length change.\n        $('body').on('change', SELECTOR.LENGTH, function() {\n            dataTable.page.len(this.value).draw();\n        });\n\n        initializeDatatable();\n        common.handleSearchInput();\n\n        // Handle report page capability manager.\n        common.handleReportCapability();\n    }\n\n    return {\n        init: function() {\n            $(document).ready(function() {\n                init();\n            });\n        }\n    };\n\n});"],"file":"learnercourseprogress.min.js"}