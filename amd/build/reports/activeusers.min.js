"use strict";define("local_edwiserreports/reports/activeusers",["jquery","core/modal_factory","core/modal_events","core/notification","core/fragment","core/templates","local_edwiserreports/variables","local_edwiserreports/common","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4","local_edwiserreports/flatpickr"],function($,ModalFactory,ModalEvents,Notification,Fragment,Templates,V,common){var SELECTOR={PAGE:"#activeusers",COHORT:".cohort-select",LENGTH:".length-select",SEARCH:".table-search-input input",TABLE:"#activeusers .table",DOWNLOADCOHORTID:".download-links input[name='cohortid']",DOWNLOADFILTER:".download-links input[name='filter']",MODALTRIGGER:"#activeusers .table a",DATE:".edwiserreports-calendar",DATEMENU:".edwiserreports-calendar + .dropdown-menu",DATEITEM:".edwiserreports-calendar + .dropdown-menu .dropdown-item",DATEPICKER:".edwiserreports-calendar + .dropdown-menu .dropdown-calendar",DATEPICKERINPUT:".edwiserreports-calendar + .dropdown-menu .flatpickr"},filter="last7days",dataTable=null,modalTable=null,flatpickr=null;function createModalOfUsersList(CONTEXTID){$(document).on("click",SELECTOR.MODALTRIGGER,function(){var title="",action=$(this).data("action"),modalFilter=$(this).data("filter"),ModalRoot=null,titleDate=common.formatDate(new Date(eval(86400*modalFilter*1e3)),"d MMM yyyy");title=M.util.get_string("".concat(action,"modaltitle"),V.component,{date:titleDate}),ModalFactory.create({body:Fragment.loadFragment("local_edwiserreports","userslist",CONTEXTID,{page:"activeusers",filter:modalFilter,cohortid:$(SELECTOR.COHORT).val(),action:action})}).then(function(e){(ModalRoot=e.getRoot()).find(".modal-dialog").addClass("modal-lg"),e.setTitle(title),e.show(),ModalRoot.on(ModalEvents.hidden,function(){e.destroy()}),ModalRoot.on(ModalEvents.bodyRendered,function(){var e=ModalRoot.find(".modal-table");e.find("tbody").hasClass("empty")&&e.find("tbody").empty(),modalTable=ModalRoot.find(".modal-table").DataTable({dom:'<"edwiserreports-table"<"p-2"i><t><"table-pagination"p>>',language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nousers","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:"&#9666",next:"&#9656"}},drawCallback:function(){common.stylePaginationButton(this)}}),ModalRoot.find(".table-search-input input").on("input",function(){modalTable.search(this.value).draw()})})}).fail(Notification.exception)})}function createDropdownCalendar(){flatpickr=$(SELECTOR.DATEPICKERINPUT).flatpickr({mode:"range",altInput:!0,altFormat:"d M Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:$(SELECTOR.DATEPICKER).get(0),onOpen:function(){$(SELECTOR.DATEMENU).addClass("withcalendar"),$(SELECTOR.DATE).dropdown("update")},onClose:function(){$(SELECTOR.DATEMENU).removeClass("withcalendar"),selectedCustomDate()}})}function selectedCustomDate(){var e=$(SELECTOR.DATEPICKERINPUT).val(),t=$(SELECTOR.DATEPICKERINPUT).next().val().replace("to","-");$(SELECTOR.DATEPICKERINPUT).next().val(t),e.includes(" to ")?($(SELECTOR.DATEITEM).removeClass("active"),$(SELECTOR.DATEITEM+".custom").addClass("active"),$(SELECTOR.DATE).html(t),filter=e,$(SELECTOR.DATEMENU).removeClass("show"),createActiveUsersTable()):flatpickr.clear()}function createActiveUsersTable(){$(SELECTOR.DOWNLOADFILTER).val(filter),$(SELECTOR.DOWNLOADCOHORTID).val($(SELECTOR.COHORT).val()),common.loader.show("#activeusers"),$.ajax({url:V.requestUrl,data:{action:"get_activeusers_graph_data_ajax",secret:M.local_edwiserreports.secret,data:JSON.stringify({filter:filter,cohortid:$(SELECTOR.COHORT).val()})}}).done(function(response){var ActiveUsers=[];response=JSON.parse(response),$.each(response.dates,function(idx,val){ActiveUsers[idx]={date:common.formatDate(new Date(eval(86400*val*1e3)),"d MMM yyyy"),filter:response.dates[idx],activeusers:response.data.activeUsers[idx],courseenrolment:response.data.enrolments[idx],coursecompletion:response.data.completionRate[idx]}});var context={activeusers:ActiveUsers,sesskey:M.cfg.sesskey};Templates.render("local_edwiserreports/activeuserstable",context).then(function(e,t){dataTable&&dataTable.destroy(),Templates.replaceNode(SELECTOR.TABLE,e,t),(dataTable=$(SELECTOR.TABLE).DataTable({responsive:!0,dom:'<"edwiserreports-table"<"p-2"i><t><"table-pagination"p>>',order:[[0,"desc"]],language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("noactiveusers","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:"&#9666",next:"&#9656"}},columnDefs:[{targets:0,className:"text-left"},{targets:"_all",className:"text-center"}],drawCallback:function(){common.stylePaginationButton(this)}})).page.len($(SELECTOR.LENGTH).val()),dataTable.column(0).search($(SELECTOR.SEARCH).val()).draw(),common.loader.hide("#activeusers")}).fail(function(e){Notification.exception(e),common.loader.hide("#activeusers")})}).fail(function(e){Notification.exception(e),common.loader.hide("#activeusers")})}function _init(e){$(SELECTOR.PAGE).find(".singleselect").select2(),common.handleSearchInput(),$(SELECTOR.DATEITEM+":not(.custom)").on("click",function(){filter=$(this).data("value"),$(SELECTOR.DATEITEM).removeClass("active"),$(this).addClass("active"),$(SELECTOR.DATE).html($(this).text()),$(SELECTOR.DATEMENU).removeClass("show"),flatpickr.clear(),createActiveUsersTable()}),$(SELECTOR.COHORT).on("change",function(){createActiveUsersTable()}),$(SELECTOR.LENGTH).on("change",function(){dataTable.page.len(this.value).draw()}),$(SELECTOR.SEARCH).on("input",function(){dataTable.column(0).search(this.value).draw()}),createActiveUsersTable(),createModalOfUsersList(e),createDropdownCalendar()}return{init:function(e){$(document).ready(function(){_init(e)})}}});
//# sourceMappingURL=activeusers.min.js.map
