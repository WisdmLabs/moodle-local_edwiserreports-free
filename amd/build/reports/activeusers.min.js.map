{"version":3,"sources":["reports/activeusers.js"],"names":["define","$","ModalFactory","ModalEvents","Notification","Fragment","Templates","V","common","SELECTOR","PAGE","COHORT","LENGTH","SEARCH","TABLE","DOWNLOADCOHORTID","DOWNLOADFILTER","MODALTRIGGER","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","filter","dataTable","modalTable","flatpickr","createModalOfUsersList","CONTEXTID","document","on","title","action","this","data","modalFilter","ModalRoot","titleDate","formatDate","Date","eval","M","util","get_string","concat","component","date","create","body","loadFragment","page","cohortid","val","then","modal","getRoot","find","addClass","setTitle","show","hidden","destroy","bodyRendered","ModalTable","hasClass","empty","DataTable","dom","language","info","infoEmpty","emptyTable","zeroRecords","paginate","previous","next","drawCallback","stylePaginationButton","search","value","draw","fail","exception","createDropdownCalendar","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","dropdown","onClose","removeClass","selectedCustomDate","dateAlternate","replace","includes","html","createActiveUsersTable","clear","loader","ajax","url","requestUrl","secret","local_edwiserreports","JSON","stringify","done","response","ActiveUsers","parse","each","dates","idx","activeusers","activeUsers","courseenrolment","enrolments","coursecompletion","completionRate","context","sesskey","cfg","render","js","replaceNode","responsive","order","columnDefs","targets","className","len","column","hide","ex","error","_init","select2","handleSearchInput","text","init","ready"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Site Overview Status Report page.\n *\n * @package     local_edwiserreports\n * @author      Yogesh Shirsath\n * @copyright   2022 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine('local_edwiserreports/reports/activeusers', [\n    'jquery',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/notification',\n    'core/fragment',\n    'core/templates',\n    'local_edwiserreports/variables',\n    'local_edwiserreports/common',\n    'local_edwiserreports/jquery.dataTables',\n    'local_edwiserreports/dataTables.bootstrap4',\n    'local_edwiserreports/flatpickr'\n], function($, ModalFactory, ModalEvents, Notification, Fragment, Templates, V, common) {\n\n    /**\n     * Selector list.\n     */\n    var SELECTOR = {\n        PAGE: '#activeusers',\n        COHORT: \".cohort-select\",\n        LENGTH: \".length-select\",\n        SEARCH: \".table-search-input input\",\n        TABLE: \"#activeusers .table\",\n        DOWNLOADCOHORTID: \".download-links input[name='cohortid']\",\n        DOWNLOADFILTER: \".download-links input[name='filter']\",\n        MODALTRIGGER: \"#activeusers .table a\",\n        DATE: '.edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Filter\n     */\n    var filter = 'last7days';\n\n    /**\n     * Datatable object.\n     */\n    var dataTable = null;\n\n    /**\n     * Modal table object.\n     */\n    var modalTable = null;\n\n    /**\n     * Flat picker object.\n     */\n    var flatpickr = null;\n\n    /**\n     * Create modal of Users list\n     * @param {number} CONTEXTID Context id\n     */\n    function createModalOfUsersList(CONTEXTID) {\n        $(document).on('click', SELECTOR.MODALTRIGGER, function() {\n            var title = \"\";\n            var action = $(this).data(\"action\");\n            var modalFilter = $(this).data(\"filter\");\n            var ModalRoot = null;\n\n            // eslint-disable-next-line no-eval\n            var titleDate = common.formatDate(new Date(eval(modalFilter * 86400 * 1000)), \"d MMM yyyy\");\n            title = M.util.get_string(`${action}modaltitle`, V.component, {\n                \"date\": titleDate\n            });\n\n            ModalFactory.create({\n                body: Fragment.loadFragment(\n                    'local_edwiserreports',\n                    'userslist',\n                    CONTEXTID, {\n                        page: 'activeusers',\n                        filter: modalFilter,\n                        cohortid: $(SELECTOR.COHORT).val(),\n                        action: action\n                    }\n                )\n            }).then(function(modal) {\n                ModalRoot = modal.getRoot();\n                ModalRoot.find('.modal-dialog').addClass('modal-lg');\n                modal.setTitle(title);\n                modal.show();\n                ModalRoot.on(ModalEvents.hidden, function() {\n                    modal.destroy();\n                });\n\n                ModalRoot.on(ModalEvents.bodyRendered, function() {\n                    var ModalTable = ModalRoot.find(\".modal-table\");\n\n                    // If empty then remove colspan\n                    if (ModalTable.find(\"tbody\").hasClass(\"empty\")) {\n                        ModalTable.find(\"tbody\").empty();\n                    }\n\n                    // Create dataTable for userslist\n                    modalTable = ModalRoot.find(\".modal-table\").DataTable({\n                        dom: '<\"edwiserreports-table\"<\"p-2\"i><t><\"table-pagination\"p>>',\n                        language: {\n                            info: M.util.get_string('tableinfo', 'local_edwiserreports'),\n                            infoEmpty: M.util.get_string('infoempty', 'local_edwiserreports'),\n                            emptyTable: M.util.get_string('nousers', 'local_edwiserreports'),\n                            zeroRecords: M.util.get_string('zerorecords', 'local_edwiserreports'),\n                            paginate: {\n                                previous: \"&#9666\",\n                                next: \"&#9656\"\n                            }\n                        },\n                        drawCallback: function() {\n                            common.stylePaginationButton(this);\n                        }\n                    });\n\n                    ModalRoot.find('.table-search-input input').on('input', function() {\n                        modalTable.search(this.value).draw();\n                    });\n                });\n                return;\n            }).fail(Notification.exception);\n        });\n    }\n\n    /**\n     * Create Calender in dropdown tp select range.\n     */\n    function createDropdownCalendar() {\n        flatpickr = $(SELECTOR.DATEPICKERINPUT).flatpickr({\n            mode: 'range',\n            altInput: true,\n            altFormat: \"d M Y\",\n            dateFormat: \"Y-m-d\",\n            maxDate: \"today\",\n            appendTo: $(SELECTOR.DATEPICKER).get(0),\n            onOpen: function() {\n                $(SELECTOR.DATEMENU).addClass('withcalendar');\n                $(SELECTOR.DATE).dropdown('update');\n            },\n            onClose: function() {\n                $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                selectedCustomDate();\n            }\n        });\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function selectedCustomDate() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // d M Y format\n        $(SELECTOR.DATEPICKERINPUT).next().val(dateAlternate);\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        filter = date;\n\n        // Hide dropdown.\n        $(SELECTOR.DATEMENU).removeClass('show');\n        createActiveUsersTable();\n    }\n\n    /**\n     * Create Active Users Table.\n     */\n    function createActiveUsersTable() {\n        $(SELECTOR.DOWNLOADFILTER).val(filter);\n        $(SELECTOR.DOWNLOADCOHORTID).val($(SELECTOR.COHORT).val());\n\n        // Show loader.\n        common.loader.show(\"#activeusers\");\n\n        $.ajax({\n            url: V.requestUrl,\n            data: {\n                action: 'get_activeusers_graph_data_ajax',\n                secret: M.local_edwiserreports.secret,\n                data: JSON.stringify({\n                    filter: filter,\n                    cohortid: $(SELECTOR.COHORT).val()\n                })\n            },\n        }).done(function(response) {\n            var ActiveUsers = [];\n            response = JSON.parse(response);\n\n            $.each(response.dates, function(idx, val) {\n                ActiveUsers[idx] = {\n                    date: common.formatDate(new Date(eval(val * 86400 * 1000)), \"d MMM yyyy\"),\n                    filter: response.dates[idx],\n                    activeusers: response.data.activeUsers[idx],\n                    courseenrolment: response.data.enrolments[idx],\n                    coursecompletion: response.data.completionRate[idx]\n                };\n            });\n\n            var context = {\n                activeusers: ActiveUsers,\n                sesskey: M.cfg.sesskey\n            };\n\n            // eslint-disable-next-line promise/catch-or-return\n            Templates.render('local_edwiserreports/activeuserstable', context)\n                .then(function(html, js) {\n                    /* If datatable is already created then destroy the table */\n                    if (dataTable) {\n                        dataTable.destroy();\n                    }\n                    Templates.replaceNode(SELECTOR.TABLE, html, js);\n                    dataTable = $(SELECTOR.TABLE).DataTable({\n                        responsive: true,\n                        dom: '<\"edwiserreports-table\"<\"p-2\"i><t><\"table-pagination\"p>>',\n                        order: [\n                            [0, 'desc']\n                        ],\n                        language: {\n                            info: M.util.get_string('tableinfo', 'local_edwiserreports'),\n                            infoEmpty: M.util.get_string('infoempty', 'local_edwiserreports'),\n                            emptyTable: M.util.get_string('noactiveusers', 'local_edwiserreports'),\n                            zeroRecords: M.util.get_string('zerorecords', 'local_edwiserreports'),\n                            paginate: {\n                                previous: \"&#9666\",\n                                next: \"&#9656\"\n                            }\n                        },\n                        columnDefs: [{\n                                \"targets\": 0,\n                                \"className\": \"text-left\"\n                            },\n                            {\n                                \"targets\": \"_all\",\n                                \"className\": \"text-center\",\n                            }\n                        ],\n                        drawCallback: function() {\n                            common.stylePaginationButton(this);\n                        }\n                    });\n                    dataTable.page.len($(SELECTOR.LENGTH).val());\n                    dataTable.column(0).search($(SELECTOR.SEARCH).val()).draw();\n\n                    // Hide loader.\n                    common.loader.hide(\"#activeusers\");\n                }).fail(function(ex) {\n                    Notification.exception(ex);\n\n                    // Hide loader.\n                    common.loader.hide(\"#activeusers\");\n                });\n        }).fail(function(error) {\n            Notification.exception(error);\n            // Hide loader.\n            common.loader.hide(\"#activeusers\");\n        });\n    }\n\n    /**\n     * Initialize\n     * @param {integer} CONTEXTID Current page context id\n     */\n    function init(CONTEXTID) {\n\n        // Initialize select2.\n        $(SELECTOR.PAGE).find('.singleselect').select2();\n\n        // Handle table search highlight.\n        common.handleSearchInput();\n\n        /* Select filter for active users block */\n        $(SELECTOR.DATEITEM + \":not(.custom)\").on('click', function() {\n            filter = $(this).data('value');\n\n            // Set custom selected item as active.\n            $(SELECTOR.DATEITEM).removeClass('active');\n            $(this).addClass('active');\n\n            // Show selected item on dropdown button.\n            $(SELECTOR.DATE).html($(this).text());\n\n            // Hide dropdown.\n            $(SELECTOR.DATEMENU).removeClass('show');\n\n            // Clear custom date.\n            flatpickr.clear();\n            createActiveUsersTable();\n        });\n\n        // Cohort filter.\n        $(SELECTOR.COHORT).on('change', function() {\n            createActiveUsersTable();\n        });\n\n        // Observer length change.\n        $(SELECTOR.LENGTH).on('change', function() {\n            dataTable.page.len(this.value).draw();\n        });\n\n        // Search in table.\n        $(SELECTOR.SEARCH).on('input', function() {\n            dataTable.column(0).search(this.value).draw();\n        });\n\n        createActiveUsersTable();\n        createModalOfUsersList(CONTEXTID);\n        createDropdownCalendar();\n    }\n\n    return {\n        init: function(CONTEXTID) {\n            $(document).ready(function() {\n                init(CONTEXTID);\n            });\n        }\n    };\n\n});"],"file":"activeusers.min.js"}