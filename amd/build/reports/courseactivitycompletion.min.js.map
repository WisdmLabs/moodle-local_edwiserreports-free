{"version":3,"sources":["reports/courseactivitycompletion.js"],"names":["define","$","ajax","Notification","common","CFG","Oldjquery","SELECTOR","PAGE","SEARCH","LENGTH","COURSE","SUMMARY","CM","GROUP","TABLE","FORMFILTER","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","flatpickr","dataTable","filter","course","cm","group","enrolment","PROMISE","GET_DATA","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","JSON","stringify","GET_SUMMARY_CARD_DATA","call","methodname","args","report","filters","initializeDatatable","loader","show","val","statuses","util","get_string","done","response","destroy","DataTable","paging","deferRendering","columnDefs","className","targets","columns","width","render","dom","language","info","infoEmpty","emptyTable","zeroRecords","paginate","previous","next","drawCallback","stylePaginationButton","this","hide","search","page","len","draw","fail","ex","exception","init","parse","updateTimeLabel","select2","templateResult","state","id","text","find","not","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","addClass","setTimeout","offset","left","parent","css","closest","onChange","onClose","removeClass","date","dateAlternate","replace","includes","html","clear","customDateSelected","on","types","refreshSummarycard","reloadFilter","value","handleSearchInput","handleReportCapability","document","ready"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Course Activity Completion report page.\n *\n * @package     local_edwiserreports\n * @author      Yogesh Shirsath\n * @copyright   2022 Wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine('local_edwiserreports/reports/courseactivitycompletion', [\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'local_edwiserreports/common',\n    'local_edwiserreports/defaultconfig',\n    'local_edwiserreports/jquery',\n    'local_edwiserreports/select2',\n    'local_edwiserreports/flatpickr'\n], function(\n    $,\n    ajax,\n    Notification,\n    common,\n    CFG,\n    Oldjquery\n) {\n\n    /**\n     * Selector\n     */\n    var SELECTOR = {\n        PAGE: '#courseactivitycompletion',\n        SEARCH: '#courseactivitycompletion .table-search-input input',\n        LENGTH: '#courseactivitycompletion .length-select',\n        COURSE: '#courseactivitycompletion .course-select',\n        SUMMARY: '#courseactivitycompletion .summary-card',\n        CM: '#courseactivitycompletion .cm-select',\n        GROUP: '#courseactivitycompletion .group-select',\n        TABLE: '#courseactivitycompletion table',\n        FORMFILTER: '#courseactivitycompletion .download-links [name=\"filter\"]',\n        DATE: '.edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Flat picker object.\n     */\n    let flatpickr = null;\n\n    /**\n     * Datatable object.\n     */\n    var dataTable = null;\n\n    /**\n     * Filter object.\n     */\n    var filter = {\n        course: null,\n        cm: 0,\n        group: 0,\n        enrolment: 'all'\n    };\n\n    /**\n     * All promises.\n     */\n    var PROMISE = {\n        /**\n         * Get course activities summary table data based on filters.\n         * @param {Object} filter Filter data\n         * @returns {PROMISE}\n         */\n        GET_DATA: function(filter) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_courseactivitycompletion_data',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify(filter)\n                },\n            });\n        },\n        /**\n         * Get summary card data.\n         *\n         * @param   {object}   filter    Filter object\n         * @returns {PROMISE}\n         */\n        GET_SUMMARY_CARD_DATA: function(filter) {\n            return ajax.call([{\n                methodname: 'local_edwiserreports_get_summary_card_data',\n                args: {\n                    report: \"\\\\local_edwiserreports\\\\reports\\\\courseactivitycompletion\",\n                    filters: JSON.stringify(filter)\n                }\n            }], false)[0];\n        }\n    };\n\n    /**\n     * Initialize datable.\n     */\n    function initializeDatatable() {\n        common.loader.show(SELECTOR.PAGE);\n\n        // Updated export filter values.\n        $(SELECTOR.FORMFILTER).val(JSON.stringify(filter));\n        let statuses = [\n            `<span class=\"danger-tag\">${M.util.get_string('notyetstarted', 'core_completion')}</span>`,\n            `<span class=\"success-tag\">${M.util.get_string('completed', 'core_completion')}</span>`,\n            `<span class=\"warning-tag\">${M.util.get_string('inprogress', 'core_completion')}</span>`\n        ];\n        PROMISE.GET_DATA(filter)\n            .done(function(response) {\n                if (dataTable !== null) {\n                    dataTable.destroy();\n                    dataTable = null;\n                }\n                dataTable = $(SELECTOR.TABLE).DataTable({\n                    data: response,\n                    paging: true,\n                    deferRendering: true,\n                    columnDefs: [\n                        {className: \"fixed-column\", targets: 0},\n                        {className: \"text-left\", targets: [0, 1, 2]},\n                        {className: \"text-right\", targets: \"_all\"}\n                    ],\n                    columns: [\n                        {data: 'learner',\n                        width: \"4rem\"\n                    },\n                        {data: 'email'},\n                        {\n                            data: 'status',\n                            render: function(data) {\n                                return statuses[data];\n                            },\n                            width: \"4rem\"\n                        },\n                        {\n                            data: 'completedon',\n                            width: \"10rem\"\n                        },\n                        {data: 'grade'},\n                        {\n                            data: 'gradedon',\n                            width: \"10rem\"\n                        },\n                        {\n                            data: 'firstaccess',\n                            width: \"10rem\"\n                        },\n                        {\n                            data: 'lastaccess',\n                            width: \"10rem\"\n                        },\n                        {data: 'visits'},\n                        {\n                            data: 'timespent',\n                        }\n                    ],\n                    dom: '<\"edwiserreports-table\"i<t><\"table-pagination\"p>>',\n                    language: {\n                        info: M.util.get_string('tableinfo', 'local_edwiserreports'),\n                        infoEmpty: M.util.get_string('infoempty', 'local_edwiserreports'),\n                        emptyTable: M.util.get_string('emptytable', 'local_edwiserreports'),\n                        zeroRecords: M.util.get_string('zerorecords', 'local_edwiserreports'),\n                        paginate: {\n                            previous: \" \",\n                            next: \" \"\n                        }\n                    },\n                    drawCallback: function() {\n                        common.stylePaginationButton(this);\n                        common.loader.hide(SELECTOR.PAGE);\n                    }\n                });\n                dataTable.columns(0).search($(SELECTOR.SEARCH).val());\n                dataTable.page.len($(SELECTOR.LENGTH).val()).draw();\n            })\n            .fail(function(ex) {\n                Notification.exception(ex);\n                common.loader.hide(SELECTOR.PAGE);\n            });\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function customDateSelected() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // D M Y format\n        $(SELECTOR.DATEPICKERINPUT).next().val(dateAlternate);\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        filter.enrolment = date;\n        initializeDatatable();\n        common.updateTimeLabel(date);\n    }\n\n    /**\n     * Reload filters.\n     * @param {array} types Types\n     * @param {number} course Course id\n     */\n    function reloadFilter(types, course) {\n        common.loader.show(SELECTOR.PAGE);\n        common.reloadFilter(\n            SELECTOR.PAGE,\n            types,\n            0,\n            course,\n            0,\n            function() {\n                setTimeout(function() {\n                    filter.cm = $(SELECTOR.CM).find(`option:first`).attr('value');\n                    initializeDatatable();\n                }, 500);\n            });\n    }\n\n    /**\n     * Initialize\n     */\n    function init() {\n\n        filter = JSON.parse($(SELECTOR.FORMFILTER).val());\n\n        // Show time period in table info.\n        common.updateTimeLabel('all');\n\n        // Initialize select2.\n        $(SELECTOR.COURSE).select2({\n            templateResult: function(state) {\n                if (!state.id) {\n                    return state.text;\n                }\n                var $state = $(\n                    '<span class=\"pl-3 d-block\">' + state.text + '</span>'\n                );\n                return $state;\n            }\n        });\n        $(SELECTOR.PAGE).find('.singleselect').not(SELECTOR.COURSE).select2();\n\n        flatpickr = Oldjquery(SELECTOR.DATEPICKERINPUT).flatpickr({\n            mode: 'range',\n            altInput: true,\n            altFormat: \"d M Y\",\n            dateFormat: \"Y-m-d\",\n            maxDate: \"today\",\n            appendTo: $(SELECTOR.DATEPICKER).get(0),\n            onOpen: function() {\n                $(SELECTOR.DATEMENU).addClass('withcalendar');\n                setTimeout(function() {\n                    if ($(SELECTOR.DATEMENU).offset().left < $(SELECTOR.PAGE).parent().offset().left) {\n                        $(SELECTOR.DATEMENU).css('left', $(SELECTOR.DATEMENU).closest('.filter-selector').css('padding-left'));\n                    }\n                }, 500);\n            },\n            onChange: function() {\n                if ($(SELECTOR.DATEMENU).offset().left < $(SELECTOR.PAGE).parent().offset().left) {\n                    $(SELECTOR.DATEMENU).css('left', $(SELECTOR.DATEMENU).closest('.filter-selector').css('padding-left'));\n                }\n            },\n            onClose: function() {\n                $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                customDateSelected();\n            }\n        });\n\n        /* Date selector listener */\n        $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n            // Set custom selected item as active.\n            $(SELECTOR.DATEITEM).removeClass('active');\n            $(this).addClass('active');\n\n            // Show selected item on dropdown button.\n            $(SELECTOR.DATE).html($(this).text());\n\n            // Clear custom date.\n            flatpickr.clear();\n\n            filter.enrolment = $(this).data('value');\n            initializeDatatable();\n            common.updateTimeLabel(filter.enrolment);\n        });\n\n        // Observer course change.\n        $('body').on('change', SELECTOR.COURSE, function() {\n            filter.course = $(this).val();\n            // Fetching summary card data here\n            PROMISE.GET_SUMMARY_CARD_DATA(filter)\n                .done(function(response) {\n                    response = JSON.parse(response);\n                    common.refreshSummarycard('group', response, SELECTOR.SUMMARY, function() {\n                        //     InitializeDatatable();\n                    });\n                });\n\n            filter.group = 0;\n            reloadFilter(['cm', 'group'], filter.course);\n        });\n\n        // Observer cm change.\n        $('body').on('change', SELECTOR.CM, function() {\n            filter.cm = $(this).val();\n            initializeDatatable();\n        });\n\n        // Observer group change.\n        $('body').on('change', SELECTOR.GROUP, function() {\n            filter.group = $(this).val();\n            // Fetching summary card data here\n            PROMISE.GET_SUMMARY_CARD_DATA(filter)\n                .done(function(response) {\n                    response = JSON.parse(response);\n                    common.refreshSummarycard('group', response, SELECTOR.SUMMARY, function() {\n                        //     InitializeDatatable();\n                    });\n                });\n\n            initializeDatatable();\n        });\n\n        // Search in table.\n        $('body').on('input', SELECTOR.SEARCH, function() {\n            dataTable.columns(0).search(this.value).draw();\n        });\n\n        // Observer length change.\n        $('body').on('change', SELECTOR.LENGTH, function() {\n            if (dataTable === null) {\n                initializeDatatable();\n                return;\n            }\n            dataTable.page.len(this.value).draw();\n        });\n\n        initializeDatatable();\n        common.handleSearchInput();\n\n        // Handle report page capability manager.\n        common.handleReportCapability();\n    }\n\n    return {\n        init: function() {\n            $(document).ready(function() {\n                init();\n            });\n        }\n    };\n\n});\n"],"file":"courseactivitycompletion.min.js"}