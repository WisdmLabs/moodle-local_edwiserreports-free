/**
 * Course Activity Completion report page.
 *
 * @package     local_edwiserreports
 * @author      Yogesh Shirsath
 * @copyright   2022 Wisdmlabs <support@wisdmlabs.com>
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/ define("local_edwiserreports/reports/courseactivitycompletion",["jquery","core/ajax","core/notification","local_edwiserreports/common","local_edwiserreports/defaultconfig","local_edwiserreports/select2","local_edwiserreports/flatpickr"],function(e,t,a,r,o){var n={PAGE:"#courseactivitycompletion",SEARCH:"#courseactivitycompletion .table-search-input input",LENGTH:"#courseactivitycompletion .length-select",COURSE:"#courseactivitycompletion .course-select",SUMMARY:"#courseactivitycompletion .summary-card",CM:"#courseactivitycompletion .cm-select",GROUP:"#courseactivitycompletion .group-select",TABLE:"#courseactivitycompletion table",FORMFILTER:'#courseactivitycompletion .download-links [name="filter"]',DATE:".edwiserreports-calendar",DATEMENU:".edwiserreports-calendar + .dropdown-menu",DATEITEM:".edwiserreports-calendar + .dropdown-menu .dropdown-item",DATEPICKER:".edwiserreports-calendar + .dropdown-menu .dropdown-calendar",DATEPICKERINPUT:".edwiserreports-calendar + .dropdown-menu .flatpickr"};let l=null;var i=null,s={course:null,cm:0,group:0,enrolment:"all"},c={GET_DATA:function(t){return e.ajax({url:o.requestUrl,type:o.requestType,dataType:o.requestDataType,data:{action:"get_courseactivitycompletion_data",secret:M.local_edwiserreports.secret,lang:e("html").attr("lang"),data:JSON.stringify(t)}})},GET_SUMMARY_CARD_DATA:function(e){return t.call([{methodname:"local_edwiserreports_get_summary_card_data",args:{report:"\\local_edwiserreports\\reports\\courseactivitycompletion",filters:JSON.stringify(e)}}],!1)[0]}};function d(){r.loader.show(n.PAGE),e(n.FORMFILTER).val(JSON.stringify(s));let t=[`<span class="danger-tag">${M.util.get_string("notyetstarted","core_completion")}</span>`,`<span class="success-tag">${M.util.get_string("completed","core_completion")}</span>`,`<span class="warning-tag">${M.util.get_string("inprogress","core_completion")}</span>`];c.GET_DATA(s).done(function(a){null!==i&&(i.destroy(),i=null),(i=e(n.TABLE).DataTable({data:a,paging:!0,deferRendering:!0,columnDefs:[{className:"fixed-column",targets:0},{className:"text-left",targets:[0,1,2]},{className:"text-right",targets:"_all"}],columns:[{data:"learner",width:"4rem"},{data:"email"},{data:"status",render:function(e){return t[e]},width:"4rem"},{data:"completedon",width:"10rem"},{data:"grade"},{data:"gradedon",width:"10rem"},{data:"firstaccess",width:"10rem"},{data:"lastaccess",width:"10rem"},{data:"visits"},{data:"timespent"}],dom:'<"edwiserreports-table"i<t><"table-pagination"p>>',language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("emptytable","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:" ",next:" "}},drawCallback:function(){r.stylePaginationButton(this),r.loader.hide(n.PAGE)}})).columns(0).search(e(n.SEARCH).val()),i.page.len(e(n.LENGTH).val()).draw()}).fail(function(e){a.exception(e),r.loader.hide(n.PAGE)})}return{init:function(){e(document).ready(function(){s=JSON.parse(e(n.FORMFILTER).val()),r.updateTimeLabel("all"),e(n.COURSE).select2({templateResult:function(t){return t.id?e('<span class="pl-3 d-block">'+t.text+"</span>"):t.text}}),e(n.PAGE).find(".singleselect").not(n.COURSE).select2(),l=e(n.DATEPICKERINPUT).flatpickr({mode:"range",altInput:!0,altFormat:"d M Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:e(n.DATEPICKER).get(0),onOpen:function(){e(n.DATEMENU).addClass("withcalendar"),setTimeout(function(){e(n.DATEMENU).offset().left<e(n.PAGE).parent().offset().left&&e(n.DATEMENU).css("left",e(n.DATEMENU).closest(".filter-selector").css("padding-left"))},500)},onChange:function(){e(n.DATEMENU).offset().left<e(n.PAGE).parent().offset().left&&e(n.DATEMENU).css("left",e(n.DATEMENU).closest(".filter-selector").css("padding-left"))},onClose:function(){e(n.DATEMENU).removeClass("withcalendar"),function t(){let a=e(n.DATEPICKERINPUT).val(),o=e(n.DATEPICKERINPUT).next().val().replace("to","-");if(e(n.DATEPICKERINPUT).next().val(o),!a.includes(" to ")){l.clear();return}e(n.DATEITEM).removeClass("active"),e(n.DATEITEM+".custom").addClass("active"),e(n.DATE).html(o),s.enrolment=a,d(),r.updateTimeLabel(a)}()}}),e("body").on("click",n.DATEITEM+":not(.custom)",function(){e(n.DATEITEM).removeClass("active"),e(this).addClass("active"),e(n.DATE).html(e(this).text()),l.clear(),s.enrolment=e(this).data("value"),d(),r.updateTimeLabel(s.enrolment)}),e("body").on("change",n.COURSE,function(){var t,a;s.course=e(this).val(),c.GET_SUMMARY_CARD_DATA(s).done(function(e){e=JSON.parse(e),r.refreshSummarycard("group",e,n.SUMMARY,function(){})}),s.group=0,t=["cm","group"],a=s.course,r.loader.show(n.PAGE),r.reloadFilter(n.PAGE,t,0,a,0,function(){setTimeout(function(){s.cm=e(n.CM).find("option:first").attr("value"),d()},500)})}),e("body").on("change",n.CM,function(){s.cm=e(this).val(),d()}),e("body").on("change",n.GROUP,function(){s.group=e(this).val(),c.GET_SUMMARY_CARD_DATA(s).done(function(e){e=JSON.parse(e),r.refreshSummarycard("group",e,n.SUMMARY,function(){})}),d()}),e("body").on("input",n.SEARCH,function(){i.columns(0).search(this.value).draw()}),e("body").on("change",n.LENGTH,function(){if(null===i){d();return}i.page.len(this.value).draw()}),d(),r.handleSearchInput(),r.handleReportCapability()})}}});
