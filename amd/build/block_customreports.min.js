/**
 * Plugin administration pages are defined here.
 *
 * @copyright   2021 wisdmlabs <support@wisdmlabs.com>
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/ define(["jquery","./defaultconfig","./variables","./common","./flatpickr","./jquery.dataTables","./dataTables.bootstrap4"],function(e,t,r,a){var o=null,n=t.getPanel("#customReportBlock"),l="courses",s=e(n).find("#customReportDrodown"),i=e(n).find("#customReportsForm"),d="local_edwiserreports";let c="rtl"==e("html").attr("dir")?1:0;e(n).find('.download-links [name="rtl"]').val(c);var p=function(e){return n+" "+e+" input[name^=customReportSelect-]"},u=function(t,r,a){if(t[0]){if(e("#wdmCustomReportEnrolStart").is(a.element)){var o=t[0].getTime();i.find("input[name=enrolstartdate]").val(o/1e3)}else if(e("#wdmCustomReportEnrolEnd").is(a.element)){var n=t[0].getTime();i.find("input[name=enrolenddate]").val(n/1e3)}}},m=function(t,l){o&&o.destroy(),e(n+" .enrol-selector").show(),e(n+' input[name="selectAllCustom"]').prop("checked",!1);var s,i=e(n).find(".customReportSelectors"),d=e(n).find(".rootContainer"),c=JSON.stringify({type:t}),p=r.requestUrl+"?action=get_customreport_selectors_ajax&secret="+M.local_edwiserreports.secret+"&filter="+c;d.show();var u="lps"==(s=t)?{columns:[{data:"select"},{data:"fullname"},{data:"shortname"},{data:"startdate"},{data:"enddate"},{data:"duration"}],language:{searchPlaceholder:"Search Learning Programs",emptyTable:"There are no learning programs"}}:{columns:[{data:"select"},{data:"fullname"},{data:"shortname"},{data:"category"},{data:"startdate"},{data:"enddate"}],language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nocourses","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:" ",next:" "}}};o=i.find(l).show().DataTable({ajax:p,dom:'<"edwiserreports-table"<"table-filter d-flex"f><t><"table-pagination"p>>',columns:u.columns,language:u.language,responsive:!0,scrollY:"380px",scroller:{loadingIndicator:!0},scrollCollapse:!0,scrollX:!0,paging:!1,bInfo:!1,bSort:!1,drawCallback:function(){a.stylePaginationButton(this),setTimeout(function(){e(".edwiserreports-table .page-item.next a").empty(),e(".edwiserreports-table .page-item.previous a").empty();var t=e("html").attr("dir");void 0!==t&&!1!==t&&"rtl"==t&&(e(".edwiserreports-table .page-item.next a:before").css({"border-left":"11px solid transparent","border-bottom":"6px solid transparent","border-top":"6px solid transparent","border-left-color":"#ccc","border-right-width":"0px"}),e(".edwiserreports-table .page-item.previous a:before").css({"border-bottom":"6px solid transparent","border-top":"6px solid transparent","border-right":" 10px solid transparent","border-right-color":"#ccc","border-left-width":"0px"}))},1e3),setTimeout(function(){},2e3)}}).columns.adjust(),setTimeout(function(){e(".edwiserreports-table .page-item.next a").empty(),e(".edwiserreports-table .page-item.previous a").empty()},3e3)},f=function(){var e=i.find('input[name="enrolstartdate"]').val(),t=i.find('input[name="enrolenddate"]').val();return""==t&&""==e||!(t<e)};e(n).find(".custom-flatpicker").flatpickr({altInput:!0,altFormat:"d/m/Y",dateFormat:"Y-m-d",maxDate:"today",onClose:u}),e(document).on("click",".custom-flatpicker ~ button.input-search-close",function(){e(".custom-flatpicker ~ input.form-control").val(""),i.find("input[name=enrolstartdate]").val(""),i.find("input[name=enrolenddate]").val("")}),e(document).on("change",n+' input[name="selectAllCustom"]',function(t){var r=".course-table";"lps"==l&&(r=".lp-table");var a=p(r);e(t.target).is(":checked")?e(a).prop("checked",!0):e(a).prop("checked",!1)}),e(document).on("click",n+" .dropdown-menu .dropdown-item",function(t){l=e(t.target).data("val"),s.html(e(t.target).html()),s.data("val",l);var r=".course-table";"lps"==l&&(r=".lp-table"),e(n).find(".table").hide(),i.find("input[name=reporttype]").val(l),m(l,r)}),e(document).on("click",n+" #customReportDownload",function(){if(!f())return e(n).find("#errorMsg").html(M.util.get_string("customreportdatefailed",d)).addClass("show").removeClass("hide"),setTimeout(function(){e(n).find("#errorMsg").addClass("hide").removeClass("show")},5e3),!1;var t=".course-table";"lps"==l&&(t=".lp-table");var r=p(t);if(!e(r+":checked").length)return e(n).find("#errorMsg").html(M.util.get_string("customreportselectfailed",d)).addClass("show").removeClass("hide"),setTimeout(function(){e(n).find("#errorMsg").addClass("hide").removeClass("show")},5e3),!1;var a=[];return e(r+":checked").each(function(t,r){a.push(e(r).data("id"))}),i.find("input[name=filters]").val(a.join(",")),!0})});
