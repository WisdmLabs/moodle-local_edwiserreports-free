"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","./variables","./selectors","./jspdf","./select2","./jquery.dataTables","./dataTables.bootstrap4"],function(e,t,a,o,n,i,r,s,l,d){var c=null,u="#scheduletab",f=u+" .dropdown a.dropdown-item",p="button.dropdown-toggle",m=u+" .dropdown.duration-dropdown a.dropdown-item",g=u+" input#esr-sendduration",h=u+" .dropdown:not(.duration-dropdown)",b=h+" button.dropdown-toggle",v=h+" a.dropdown-item",y=u+" .dropdown.daily-dropdown button.dropdown-toggle",w=u+" .dropdown.weekly-dropdown button.dropdown-toggle",k=u+" .dropdown.monthly-dropdown button.dropdown-toggle",_=u+" input#esr-sendtime",x="#listemailstab .esr-email-sched-setting",C="#listemailstab .esr-email-sched-delete",T="#listemailstab .esr-switch",N=M.util.get_string("scheduleerrormsg","local_edwiserreports"),A=M.util.get_string("schedulesuccessmsg","local_edwiserreports"),I=M.util.get_string("deletesuccessmsg","local_edwiserreports"),O=M.util.get_string("deleteerrormsg","local_edwiserreports"),S=M.util.get_string("emptyerrormsg","local_edwiserreports"),j=M.util.get_string("emailinvaliderrormsg","local_edwiserreports"),E='[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',P='[aria-controls="scheduletab"], #scheduletab',R='<div id="cover-spin"></div>',q=/^[a-zA-Z0-9]+[a-zA-Z0-9+_.-]+[a-zA-Z0-9]+@[a-zA-Z0-9]+[a-zA-Z0-9.-]*\.[a-zA-Z]{2,}$/,z={TABLE:".edwiserreports-table",FILTER:".table-filter",SEARCHTABLE:".table-search-input input",PAGINATION:".table-pagination",PAGINATIONITEM:".paginate_button"};i.render("local_edwiserreports/insight-placeholder",{}),i.render("local_edwiserreports/insight",{});var G={show:function(t,a){var o;null==t?(t="body",o="position-fixed"):o="position-absolute",null!=a&&(o=a),e(t).append('\n            <div class="edwiserreports-loader '.concat(o,'">\n                <div class="animation-wrapper">\n                    <div class="fa-animation">\n                        <i class="fa fa-cog fa-lg fa-spin"></i>\n                        <i class="fa fa-cog fa-md fa-spin spin-reverse"></i>\n                        <i class="fa fa-cog fa-sm fa-spin spin-reverse"></i>\n                    </div>\n                    ').concat(M.util.get_string("loading","moodle"),"\n                </div>\n            </div>\n            "))},hide:function(t){null==t&&(t="body"),e(t+" > .edwiserreports-loader").remove()}};function J(t){var a,o=!0,n=e('[name="esrrecepient"]').get(0),i=[];return t.replaceAll(" ","").replaceAll(";",",").split(",").forEach(function(e){null!=i[e]&&(a=!0),i[e]=!0,o&=q.test(e)}),a?(n.setCustomValidity("Invalid email"),e(n).next().text(M.util.get_string("duplicateemail","local_edwiserreports")),!1):o?(n.setCustomValidity(""),!0):(n.setCustomValidity("Invalid email"),e(n).next().text(M.util.get_string("invalidemail","local_edwiserreports")),!1)}function F(t){t.modal.find(".comparisontable .switch-capability").on("click",function(t){var a=e(t.currentTarget).find("input[type=radio]"),o=a.filter(":checked"),n=a.eq(a.index(o)+1);0===n.length&&(n=a.eq(0)),n.prop("checked",!0);var i=n.data("strpermission"),r=n.data("permissionclass");e(t.currentTarget).removeClass("inherit allow prevent prohibit"),e(t.currentTarget).addClass(r),e(t.currentTarget).find("label").html(i)})}function U(t,a){var o=a.getRoot().find("#esr-shceduled-emails");return e(document).on("click",'[aria-controls="listemailstab"]',function(){e(window).resize()}),o.DataTable({ajax:{url:s.requestUrl+"?sesskey="+t.sesskey,type:s.requestType,data:{action:"get_scheduled_emails_ajax",data:JSON.stringify({blockname:t.block,region:t.region})}},dom:'<"edwiserreports-table"i<t><"table-pagination"p>>',language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("noscheduleemails","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),sClass:"text-center",paginate:{previous:M.util.get_string("previous","moodle"),next:M.util.get_string("next","moodle")}},drawCallback:function(){B(this)},order:[[2,"asc"]],columns:[{data:"esrname",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,lengthChange:!1})}function B(t){var a=e(t).closest(z.TABLE).find(z.PAGINATION);a.find(z.PAGINATIONITEM).length<4?a.addClass("d-none"):(a.removeClass("d-none"),a.find(z.PAGINATIONITEM).addClass(s.datatableClasses.buttonSpacing),a.find(z.PAGINATIONITEM+" a").addClass(s.datatableClasses.buttonSize),a.find(z.PAGINATIONITEM+".active a").addClass(s.datatableClasses.buttonActive),a.find(z.PAGINATIONITEM+":not(.active) a").addClass(s.datatableClasses.buttonInactive),a.find(z.PAGINATIONITEM+".previous a").addClass(s.datatableClasses.prevNextSpacing),a.find(z.PAGINATIONITEM+".next a").addClass(s.datatableClasses.prevNextSpacing),a.find(z.PAGINATIONITEM+".previous").removeClass(s.datatableClasses.buttonsSpacing).addClass("mx-4"),a.find(z.PAGINATIONITEM+".next").removeClass(s.datatableClasses.buttonsSpacing).addClass("mx-4"))}return e(document).ready(function(){e(document).on("click",['.download-links button[value="csv"][type="button"]','.download-links button[value="excel"][type="button"]'].join(", "),function(){var t=e(this);o.create({title:"",type:o.types.default,body:a.loadFragment("local_edwiserreports","export_data_warning",1,{warning:"csv"==t.val()?"csvprowarning":"excelprowarning"})}).done(function(e){var a=e.getRoot();a.find(".modal-header").addClass("d-none"),a.find(".modal-dialog").addClass("export-notice-modal"),a.on(n.hidden,function(){e.destroy()}),a.on("click",'[data-action="download"]',function(){t.attr("type","submit"),t.click(),t.attr("type","button"),e.hide()}),e.show()})}),e(document).on("input",'[name="esrname"], [name="esrrecepient"], [name="esrsubject"]',function(){var t=""==e('[name="esrname"]').val(),a=!J(e('[name="esrrecepient"]').val()),o=""==e('[name="esrsubject"]').val(),n=t||a||o;e(".modal-footer.schedule-email").find('[data-action="save"], [data-action="send"]').prop("disabled",n),e("#scheduletab .date-filters").toggleClass("disabled",n),a?e(this).get(0).setCustomValidity("Please enter valid email address"):e(this).get(0).setCustomValidity("")}),e(document).on("click",'.download-links button[value="pdf"]',function(){var t=e(this).closest("form");G.show("body","position-fixed"),e.ajax({url:t.attr("action"),type:"POST",data:{type:e(this).val(),block:t.find('input[name="block"]').val(),filter:t.find('input[name="filter"]').val(),cohortid:t.find('input[name="cohortid"]').val(),region:t.find('input[name="region"]').val()}}).done(function(e){try{e=JSON.parse(e);var t="p",a="a4";null!=e.options&&(null!=e.options.orientation&&(t=e.options.orientation),null!=e.options.format&&(a=e.options.format));var o=d(t,"pt",a),n={top:40,bottom:30,left:10,width:"100%"};o.setFontSize(10);o.fromHTML(e.data.html,n.left,n.top,{width:n.width,elementHandlers:{"#bypassme":function(e,t){return!0}}},function(t){o.save(e.data.filename)},n)}catch(e){G.hide("body")}}).always(function(){G.hide("body")})}),e(document).on("click",'.download-links button[value="email"]',function(){var i=s.getScheduledEmailFormContext(),l=e(this).closest("form").serializeArray();e(l).each(function(e,t){i[t.name]=t.value});var d=M.util.get_string("scheduleemailfor","local_edwiserreports");i.block.includes("customreportsblock")?d+=" "+e("#"+i.block).data("blockname"):d+=" "+M.util.get_string(i.block+"exportheader","local_edwiserreports"),o.create({title:d,body:a.loadFragment("local_edwiserreports","email_schedule_tabs",1,{data:JSON.stringify(i)})}).done(function(a){var o=a.getRoot();o.find(".modal-header").addClass("border-bottom-0"),o.find(".modal-title").addClass("h4 font-weight-600"),a.modal.addClass("modal-lg"),o.on(n.bodyRendered,function(){o.find("#esr-blockname").val(i.blockname),o.find("#esr-region").val(i.region),o.find("#esr-sesskey").val(i.sesskey),c=U(i,a)}),o.on(n.hidden,function(){a.destroy()}),function(a,o,n){o.on("click",f,function(){var t,a,o,n;a=e(t=this).data("value"),o=e(t).text(),(n=e(t).closest(".dropdown").find(p)).text(o),n.data("value",a)}),o.on("click",m,function(){!function(t,a){var o=e(t).data("value");a.find(g).val(o),e(b).hide();var n=null;switch(o){case 1:n=e(w);break;case 2:n=e(k);break;default:n=e(y)}n.show();var i=n.data("value");e(_).val(i)}(this,o)}),o.on("click",v,function(){o.find(_).val(e(this).data("value"))}),o.on("click",x,function(){!function(t,a){var o=e(t).data("id"),n=e(t).data("blockname"),i=e(t).data("region");e.ajax({url:s.requestUrl,type:s.requestType,sesskey:e(t).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:e(t).data("sesskey"),data:JSON.stringify({id:o,blockname:n,region:i})}}).done(function(t){(t=JSON.parse(t)).error?console.log(t):(!function(t,a,o){var n=null,i=null;e.each(t.data,function(t,a){if("object"===_typeof(a))o.find("#esr-blockname").val(a.blockname),o.find("#esr-region").val(a.region);else if("esrduration"===t){var r='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+a+'"]';n=a,o.find(r).click()}else if("esrtime"===t)i=a;else if("esremailenable"===t){var s=e('input[name="'+t+'"]');a?s.prop("checked",!0):s.prop("checked",!1)}else e('[name="'+t+'"]').val(a),e('input[name="'+t+'"].form-control').length&&e('input[name="'+t+'"].form-control').trigger("input")});var r='.dropdown-item[data-value="'+i+'"]',s=null;switch(n){case"1":s=e(".weekly-dropdown");break;case"2":s=e(".monthly-dropdown");break;default:s=e(".daily-dropdown")}s.find(r).click()}(t,0,a),a.find(E).removeClass("active show"),a.find(P).addClass("active show"))}).fail(function(e){console.log(e)})}(this,o)}),o.on("click",C,function(i){a.id=e(this).data("id"),r.get_strings([{key:"confirmemailremovaltitle",component:"local_edwiserreports"},{key:"confirmemailremovalquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(r){t.confirm(r[0],r[1],r[2],r[3],e.proxy(function(){!function(t,a,o){var n=t.id,i=t.block,r=t.region,l=a.find(".esr-form-error");l.html(G).show(),e.ajax({url:s.requestUrl,type:s.requestType,sesskey:t.sesskey,data:{action:"delete_scheduled_email_ajax",sesskey:t.sesskey,data:JSON.stringify({id:n,blockname:i,region:r})}}).done(function(e){e.error?l.html(O):(c&&c.destroy(),c=U(t,o),l.html(I))}).fail(function(e){l.html(O),console.log(e)}).always(function(){l.delay(3e3).fadeOut("slow")})}(a,o,n)},i.currentTarget))})}),o.on("click",T,function(){a.id=e(this).data("id"),function(t,a,o){var n=t.id,i=t.block,r=t.region,l=t.sesskey,d=a.find(".esr-form-error");e.ajax({url:s.requestUrl,type:s.requestType,data:{action:"change_scheduled_email_status_ajax",sesskey:l,data:JSON.stringify({id:n,blockname:i,region:r})}}).done(function(e){var o=a.find('.esr-manage-scheduled-emails .esr-switch[data-id="'+t.id+'"]');e=JSON.parse(e),"0"==o.attr("data-value")?o.attr("data-value","on"):o.attr("data-value","0"),e.error?(d.html(e.errormsg),d.show(),d.delay(3e3).fadeOut("slow")):(d.html(e.successmsg),d.show(),d.delay(3e3).fadeOut("slow"))})}(a,o)}),o.on("click",'[data-action="send"]',function(){!function(t,a,o){var n=t.filter,i=t.cohortid,r=t.block,s=o.find(".esr-form-error");s.html("").show(),e(document).find("#cover-spin")&&e("body").append(R);e(document).find("#cover-spin").show(0),e.ajax({url:M.cfg.wwwroot+"/local/edwiserreports/download.php?type=email&filter="+n+"&cohortid="+i+"&block="+r,type:"POST",data:o.find("form").serialize()}).done(function(t){(t=e.parseJSON(t)).error?s.html('<div class="alert alert-danger"><b>ERROR:</b>'+t.errormsg+"</div>"):s.html('<div class="alert alert-success"><b>Success:</b>'+t.errormsg+"</div>")}).fail(function(e){s.html('<div class="alert alert-danger"><b>ERROR:</b>'+e.errormsg+"</div>")}).always(function(){s.delay(3e3).fadeOut("slow"),e(document).find("#cover-spin").hide()})}(a,0,o)}),function(t,a,o){a.on("click",'[data-action="save"]',function(){var n=a.find(".esr-form-error");if(n.html(G).show(),function(e,t){var a=e.find('[name="esrname"]').val(),o=e.find('[name="esrsubject"]').val(),n=!0;""!=a&&""!=o||(t.html(S).show(),n=!1);J(e.find('[name="esrrecepient"]').val())||(n=!1,t.html(j).show());return n}(a.find("form"),n)){var i=t.filter,r=t.cohortid,s=t.block,l=M.cfg.wwwroot+"/local/edwiserreports/download.php?type=emailscheduled&filter="+i+"&cohortid="+r+"&block="+s;e.ajax({url:l,type:"POST",data:a.find("form").serialize()}).done(function(a){(a=e.parseJSON(a)).error?(n.html(N),console.log(a.error)):(c&&c.destroy(),c=U(t,o),n.html(A))}).fail(function(e){n.html(N),console.log(e)}).always(function(){n.delay(3e3).fadeOut("slow")})}}),a.on("click",'[data-action="cancel"]',function(){a.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val("").each(function(t,a){e(a).trigger("input")}),a.find("#esr-id").val(-1)})}(a,o,n)}(i,o,a),a.show()})}),e(document).on("input","#listemailstab .table-search-input input",function(){c.search(this.value).draw()}),e("#wdm-edwiserreports").removeClass("d-none"),e(document).on("click",l.blockSettingsBtn,function(r){r.preventDefault();var l=e(r.currentTarget).data("contextid"),d=e(r.currentTarget).data("blockname"),c=e(r.currentTarget).data("action");if("edit"==c)o.create({title:M.util.get_string("editblocksetting","local_edwiserreports"),body:a.loadFragment("local_edwiserreports","get_blocksetting_form",l,{blockname:d})}).done(function(a){var o=a.getRoot();a.modal.addClass("modal-dialog-centered"),o.on(n.bodyRendered,function(){var o=a.modal.find(".block-settings-form");a.modal.find(".save-block-settings").on("click",function(a){a.preventDefault();var n=o.serializeArray(),i={};e(n).each(function(e,t){i[t.name]=t.value}),function(a,o){o.blockname=a,o=JSON.stringify(o);var n=e("#"+a).data("sesskey");e.ajax({url:s.requestUrl,type:"GET",data:{action:"set_block_preferences_ajax",sesskey:n,data:o}}).fail(function(e){console.log(e),t.addNotification({message:e,type:"error"})}).always(function(){location.reload()})}(d,i)})}),o.on(n.hidden,function(){a.destroy()}),a.show()});else if("hide"==c){var u=e(this).data("hidden"),f=e(this);e.ajax({url:s.requestUrl,type:"GET",data:{action:"toggle_hide_block_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({blockname:d,hidden:u})}}).done(function(e){(e=JSON.parse(e)).success&&(u?(f.closest(".edwiserReport-block").removeClass("block-hidden"),f.data("hidden",0),f.html(M.util.get_string("hide","local_edwiserreports"))):(f.closest(".edwiserReport-block").addClass("block-hidden"),f.data("hidden",1),f.html(M.util.get_string("unhide","local_edwiserreports"))))})}else"editcap"==c&&o.create({title:M.util.get_string("editblockcapabilities","local_edwiserreports"),body:a.loadFragment("local_edwiserreports","get_blockscap_form",l,{blockname:d})}).done(function(o){var r=o.getRoot();o.modal.addClass("modal-dialog-centered modal-lg"),r.on(n.bodyRendered,function(){var n=o.modal.find(".block-cap-form");o.modal.find("#menucapabilities").on("change",function(t){t.preventDefault();var r=n.serializeArray(),s={};e(r).each(function(e,t){s[t.name]=t.value}),a.loadFragment("local_edwiserreports","block_overview_display",l,{capvalue:s.capabilities}).done(function(e,t,a){i.replaceNodeContents(o.modal.find(".cap-overview"),e,t),F(o)})}),F(o),n=o.modal.find(".block-cap-form"),o.modal.find(".save-block-caps").on("click",function(a){a.preventDefault();var i=n.serializeArray(),r={};e(i).each(function(e,t){r[t.name]=t.value}),function(a,o,n){o.blockname=a,o=JSON.stringify(o);var i=e("#"+a).data("sesskey");e.ajax({url:s.requestUrl,type:"GET",data:{action:"set_block_capability_ajax",sesskey:i,data:o}}).done(function(e){(e=JSON.parse(e)).success?(n(),location.reload()):t.addNotification({message:"Error",type:"error"})}).fail(function(e){console.log(e),t.addNotification({message:e,type:"error"})}).always(function(){n(),location.reload()})}(d,r,function(){o.hide()})})}),r.on(n.hidden,function(){o.destroy()}),o.show()})}),function(t){var a,o='<div id="editing-btn" class="d-flex flex-wrap">';o+='<div class="ml-auto d-flex">',t?(t=0,a="Stop Customising this page",o+='<div class="singlebutton">',o+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',o+='<input type="hidden" name="reset" value="1">',o+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',o+='<button type="submit" class="btn btn-secondary" title="">Reset Page to Default</button>',o+="</form>",o+="</div>"):(t=1,a="Customise this page");o+='<div class="singlebutton">',o+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',o+='<input type="hidden" name="edit" value="'+t+'">',o+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',o+='<button type="submit" class="btn btn-secondary" title="">'+a+"</button>",o+="</form>",o+="</div>",o+="</div></div>",e("#page-local-edwiserreports-index #page-header .card-body").append(o)}(e("#wdm-edwiserreports").data("editing"))}),{loader:G,toPrecision:function(e,t){return e%1==0?e:e.toPrecision(t)},insight:function(a,o){o.insight.title=M.util.get_string(o.insight.title,"local_edwiserreports"),void 0!==o.details&&void 0!==o.details.data&&o.details.data.forEach(function(e,t){o.details.data[t].title=M.util.get_string(e.title,"local_edwiserreports")}),i.render("local_edwiserreports/insight-placeholder",{}).done(function(n,r){i.replaceNodeContents(a,n,r),i.render("local_edwiserreports/insight",o).done(function(e,t){i.replaceNodeContents(a,e,t)}).fail(function(o){t.exception(o),e(a).remove()})})},timeFormatter:function(e,t){e=Number(e);var a=Math.floor(e/3600),o=Math.floor(e%3600/60),n=Math.floor(e%3600%60);if("object"==_typeof(t)&&void 0!==t.dataPointIndex&&-1!==t.dataPointIndex){var i=[],r=void 0!==t.short&&t.short;return a>0&&(r?i.push(a+" h."):i.push(a+" "+(1==a?M.util.get_string("hour","local_edwiserreports"):M.util.get_string("hours","local_edwiserreports")))),o>0&&(r?i.push(o+" min."):i.push(o+" "+(1==o?M.util.get_string("minute","local_edwiserreports"):M.util.get_string("minutes","local_edwiserreports")))),n>0&&(r?0===i.length&&i.push(n+" sec."):i.push(n+" "+(1==n?M.util.get_string("second","local_edwiserreports"):M.util.get_string("seconds","local_edwiserreports")))),0==i.length&&i.push(0),i.join(", ")}return function(e,t,a){return(e=e>0?e<10?"0"+e:e:"00")+":"+(t=t>0?t<10?"0"+t:t:"00")+":"+(a=a>0?a<10?"0"+a:a:"00")}(a,o,n)},dateChange:function(t){e(document).on("edwiserreport:datechange",function(e){t(e.detail.date)})},stylePaginationButton:B,handleSearchInput:function(){e("body").on("input",z.SEARCHTABLE,function(){e(this).toggleClass("empty",""===e(this).val())})}}});
//# sourceMappingURL=common.min.js.map
