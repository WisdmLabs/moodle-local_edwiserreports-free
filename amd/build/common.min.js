"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["jquery","core/notification","core/fragment","core/modal_factory","core/modal_events","core/templates","core/str","./variables","./selectors","./templateselector","./jspdf","./select2","./jquery.dataTables","./dataTables.bootstrap4"],function(e,t,a,o,n,i,r,s,l,d,c){var u=null,f="#scheduletab",p=f+" .dropdown a.dropdown-item",m="button.dropdown-toggle",g=f+" .dropdown.duration-dropdown a.dropdown-item",h=f+" input#esr-sendduration",b=f+" .dropdown:not(.duration-dropdown)",v=b+" button.dropdown-toggle",y=b+" a.dropdown-item",w=f+" .dropdown.daily-dropdown button.dropdown-toggle",k=f+" .dropdown.weekly-dropdown button.dropdown-toggle",_=f+" .dropdown.monthly-dropdown button.dropdown-toggle",T=f+" input#esr-sendtime",x="#listemailstab .esr-email-sched-setting",C="#listemailstab .esr-email-sched-delete",N="#listemailstab .esr-switch",S=M.util.get_string("scheduleerrormsg","local_edwiserreports"),A=M.util.get_string("schedulesuccessmsg","local_edwiserreports"),O=M.util.get_string("deletesuccessmsg","local_edwiserreports"),j=M.util.get_string("deleteerrormsg","local_edwiserreports"),I=M.util.get_string("emptyerrormsg","local_edwiserreports"),E=M.util.get_string("emailinvaliderrormsg","local_edwiserreports"),R='[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',q='[aria-controls="scheduletab"], #scheduletab',z='<div id="cover-spin"></div>',J=/^[a-zA-Z0-9]+[a-zA-Z0-9+_.-]+[a-zA-Z0-9]+@[a-zA-Z0-9]+[a-zA-Z0-9.-]*\.[a-zA-Z]{2,}$/,P={TABLE:".edwiserreports-table",FILTER:".table-filter",SEARCHTABLE:".table-search-input input",PAGINATION:".table-pagination",PAGINATIONITEM:".paginate_button"};i.render("local_edwiserreports/insight-placeholder",{}),i.render("local_edwiserreports/insight",{});var G={show:function(t){var a;null==t?(t="body",a="position-fixed"):a="position-absolute",e(t).append('\n            <div class="edwiserreports-loader '.concat(a,'">\n                <div class="animation-wrapper">\n                    <div class="fa-animation">\n                        <i class="fa fa-cog fa-lg fa-spin"></i>\n                        <i class="fa fa-cog fa-md fa-spin spin-reverse"></i>\n                        <i class="fa fa-cog fa-sm fa-spin spin-reverse"></i>\n                    </div>\n                    ').concat(M.util.get_string("loading","moodle"),"\n                </div>\n            </div>\n            "))},hide:function(t){null==t&&(t="body"),e(t+" > .edwiserreports-loader").remove()}};function F(e){var t=!0;return(e=e.replaceAll(" ","").split(",")).forEach(function(e){t&=J.test(e)}),t}function B(t){t.modal.find(".comparisontable .switch-capability").on("click",function(t){var a=e(t.currentTarget).find("input[type=radio]"),o=a.filter(":checked"),n=a.eq(a.index(o)+1);0===n.length&&(n=a.eq(0)),n.prop("checked",!0);var i=n.data("strpermission"),r=n.data("permissionclass");e(t.currentTarget).removeClass("inherit allow prevent prohibit"),e(t.currentTarget).addClass(r),e(t.currentTarget).find("label").html(i)})}function D(t,a){var o=a.getRoot().find("#esr-shceduled-emails");return e(document).on("click",'[aria-controls="listemailstab"]',function(){e(window).resize()}),o.DataTable({ajax:{url:s.requestUrl+"?sesskey="+t.sesskey,type:s.requestType,data:{action:"get_scheduled_emails_ajax",data:JSON.stringify({blockname:t.block,region:t.region})}},dom:'<"edwiserreports-table"i<t><"table-pagination"p>>',language:{emptyTable:"There is no scheduled emails",sClass:"text-center"},drawCallback:function(){U(this)},order:[[2,"asc"]],columns:[{data:"esrname",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,lengthChange:!1})}function U(t){var a=e(t).closest(P.TABLE).find(P.PAGINATION);a.find(P.PAGINATIONITEM).addClass(s.datatableClasses.buttonSpacing),a.find(P.PAGINATIONITEM+" a").addClass(s.datatableClasses.buttonSize),a.find(P.PAGINATIONITEM+".active a").addClass(s.datatableClasses.buttonActive),a.find(P.PAGINATIONITEM+":not(.active) a").addClass(s.datatableClasses.buttonInactive)}return e(document).ready(function(){e(document).on("click",['.download-links button[value="csv"][type="button"]','.download-links button[value="excel"][type="button"]'].join(", "),function(){var t=e(this);o.create({title:"",type:o.types.default,body:a.loadFragment("local_edwiserreports","export_data_warning",1,{warning:"csv"==t.val()?"csvprowarning":"excelprowarning"})}).done(function(e){var a=e.getRoot();a.find(".modal-header").addClass("d-none"),a.find(".modal-dialog").addClass("export-notice-modal"),a.on(n.hidden,function(){e.destroy()}),a.on("click",'[data-action="download"]',function(){t.attr("type","submit"),t.click(),t.attr("type","button"),e.hide()}),e.show()})}),e(document).on("input",'[name="esrname"], [name="esrrecepient"], [name="esrsubject"]',function(){var t=""==e('[name="esrname"]').val(),a=!F(e('[name="esrrecepient"]').val()),o=""==e('[name="esrsubject"]').val(),n=t||a||o;e(".modal-footer.schedule-email").find('[data-action="save"], [data-action="send"]').prop("disabled",n),e("#scheduletab .date-filters").toggleClass("disabled",n),a?e(this).get(0).setCustomValidity("Please enter valid email address"):e(this).get(0).setCustomValidity("")}),e(document).on("click",'.download-links button[value="pdf"]',function(t){t.preventDefault();var a=e(this).closest("form");e.ajax({url:a.attr("action"),type:"POST",data:{type:e(this).val(),block:a.find('input[name="block"]').val(),filter:a.find('input[name="filter"]').val(),cohortid:a.find('input[name="cohortid"]').val(),region:a.find('input[name="region"]').val()}}).done(function(e){e=JSON.parse(e);var t=c("p","pt","a4"),a={top:40,bottom:30,left:10,width:"100%"};t.setFontSize(10);t.fromHTML(e.data.html,a.left,a.top,{width:a.width,elementHandlers:{"#bypassme":function(e,t){return!0}}},function(a){t.save(e.data.filename)},a)}).always(function(){e(document).find("#cover-spin").hide()})}),e(document).on("click",'.download-links button[value="email"]',function(i){var l=s.getScheduledEmailFormContext(),d=e(this).closest("form").serializeArray();e(d).each(function(e,t){l[t.name]=t.value});var c=M.util.get_string("scheduleemailfor","local_edwiserreports");l.block.includes("customreportsblock")?c+=" "+e("#"+l.block).data("blockname"):c+=" "+M.util.get_string(l.block+"exportheader","local_edwiserreports"),o.create({title:c,body:a.loadFragment("local_edwiserreports","email_schedule_tabs",1,{data:JSON.stringify(l)})}).done(function(a){var o=a.getRoot();o.find(".modal-header").addClass("border-bottom-0"),o.find(".modal-title").addClass("h4 font-weight-600"),a.modal.addClass("modal-lg"),o.on(n.bodyRendered,function(){o.find("#esr-blockname").val(l.blockname),o.find("#esr-region").val(l.region),o.find("#esr-sesskey").val(l.sesskey),u=D(l,a)}),o.on(n.hidden,function(){a.destroy()}),function(a,o,n){o.on("click",p,function(){var t,a,o,n;a=e(t=this).data("value"),o=e(t).text(),(n=e(t).closest(".dropdown").find(m)).text(o),n.data("value",a)}),o.on("click",g,function(){!function(t,a){var o=e(t).data("value");a.find(h).val(o),e(v).hide();var n=null;switch(o){case 1:n=e(k);break;case 2:n=e(_);break;default:n=e(w)}n.show();var i=n.data("value");e(T).val(i)}(this,o)}),o.on("click",y,function(){o.find(T).val(e(this).data("value"))}),o.on("click",x,function(){!function(t,a){var o=e(t).data("id"),n=e(t).data("blockname"),i=e(t).data("region");e.ajax({url:s.requestUrl,type:s.requestType,sesskey:e(t).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:e(t).data("sesskey"),data:JSON.stringify({id:o,blockname:n,region:i})}}).done(function(t){(t=JSON.parse(t)).error?console.log(t):(!function(t,a,o){var n=null,i=null;e.each(t.data,function(t,a){if("object"===_typeof(a))o.find("#esr-blockname").val(a.blockname),o.find("#esr-region").val(a.region);else if("esrduration"===t){var r='[aria-labelledby="durationcount"] .dropdown-item[data-value="'+a+'"]';n=a,o.find(r).click()}else if("esrtime"===t)i=a;else if("esremailenable"===t){var s=e('input[name="'+t+'"]');a?s.prop("checked",!0):s.prop("checked",!1)}else e('[name="'+t+'"]').val(a),e('input[name="'+t+'"].form-control').length&&e('input[name="'+t+'"].form-control').trigger("input")});var r='.dropdown-item[data-value="'+i+'"]',s=null;switch(n){case"1":s=e(".weekly-dropdown");break;case"2":s=e(".monthly-dropdown");break;default:s=e(".daily-dropdown")}s.find(r).click()}(t,0,a),a.find(R).removeClass("active show"),a.find(q).addClass("active show"))}).fail(function(e){console.log(e)})}(this,o)}),o.on("click",C,function(i){a.id=e(this).data("id"),r.get_strings([{key:"confirmemailremovaltitle",component:"local_edwiserreports"},{key:"confirmemailremovalquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(r){t.confirm(r[0],r[1],r[2],r[3],e.proxy(function(){!function(t,a,o){var n=t.id,i=t.block,r=t.region,l=a.find(".esr-form-error");l.html(G).show(),e.ajax({url:s.requestUrl,type:s.requestType,sesskey:t.sesskey,data:{action:"delete_scheduled_email_ajax",sesskey:t.sesskey,data:JSON.stringify({id:n,blockname:i,region:r})}}).done(function(e){e.error?l.html(j):(u&&u.destroy(),u=D(t,o),l.html(O))}).fail(function(e){l.html(j),console.log(e)}).always(function(){l.delay(3e3).fadeOut("slow")})}(a,o,n)},i.currentTarget))})}),o.on("click",N,function(){a.id=e(this).data("id"),function(t,a,o){var n=t.id,i=t.block,r=t.region,l=t.sesskey,d=a.find(".esr-form-error");e.ajax({url:s.requestUrl,type:s.requestType,data:{action:"change_scheduled_email_status_ajax",sesskey:l,data:JSON.stringify({id:n,blockname:i,region:r})}}).done(function(e){var o=a.find('.esr-manage-scheduled-emails .esr-switch[data-id="'+t.id+'"]');e=JSON.parse(e),"0"==o.attr("data-value")?o.attr("data-value","on"):o.attr("data-value","0"),e.error?(d.html(e.errormsg),d.show(),d.delay(3e3).fadeOut("slow")):(d.html(e.successmsg),d.show(),d.delay(3e3).fadeOut("slow"))})}(a,o)}),o.on("click",'[data-action="send"]',function(){!function(t,a,o){var n=t.filter,i=t.cohortid,r=t.block,s=o.find(".esr-form-error");s.html("").show(),e(document).find("#cover-spin")&&e("body").append(z);e(document).find("#cover-spin").show(0),e.ajax({url:M.cfg.wwwroot+"/local/edwiserreports/download.php?type=email&filter="+n+"&cohortid="+i+"&block="+r,type:"POST",data:o.find("form").serialize()}).done(function(t){(t=e.parseJSON(t)).error?s.html('<div class="alert alert-danger"><b>ERROR:</b>'+t.errormsg+"</div>"):s.html('<div class="alert alert-success"><b>Success:</b>'+t.errormsg+"</div>")}).fail(function(e){s.html('<div class="alert alert-danger"><b>ERROR:</b>'+e.errormsg+"</div>")}).always(function(){s.delay(3e3).fadeOut("slow"),e(document).find("#cover-spin").hide()})}(a,0,o)}),function(t,a,o){a.on("click",'[data-action="save"]',function(){var n=a.find(".esr-form-error");if(n.html(G).show(),function(e,t){var a=e.find('[name="esrname"]').val(),o=e.find('[name="esrsubject"]').val(),n=!0;""!=a&&""!=o||(t.html(I).show(),n=!1);F(e.find('[name="esrrecepient"]').val())||(n=!1,t.html(E).show());return n}(a.find("form"),n)){var i=t.filter,r=t.cohortid,s=t.block,l=M.cfg.wwwroot+"/local/edwiserreports/download.php?type=emailscheduled&filter="+i+"&cohortid="+r+"&block="+s;e.ajax({url:l,type:"POST",data:a.find("form").serialize()}).done(function(a){(a=e.parseJSON(a)).error?(n.html(S),console.log(a.error)):(u&&u.destroy(),u=D(t,o),n.html(A))}).fail(function(e){n.html(S),console.log(e)}).always(function(){n.delay(3e3).fadeOut("slow")})}}),a.on("click",'[data-action="cancel"]',function(){a.find('[name^=esr]:not(.d-none):not([id="esr-toggle-"])').val("").each(function(t,a){e(a).trigger("input")}),a.find("#esr-id").val(-1)})}(a,o,n)}(l,o,a),a.show()})}),e(document).on("input","#listemailstab .table-search-input input",function(){u.search(this.value).draw()}),e("#wdm-edwiserreports").removeClass("d-none"),e(document).on("click",l.blockSettingsBtn,function(i){i.preventDefault();var r=e(i.currentTarget).data("contextid"),l=e(i.currentTarget).data("blockname"),d=e(i.currentTarget).data("action");if("edit"==d)o.create({title:"Edit Block Setting",body:a.loadFragment("local_edwiserreports","get_blocksetting_form",r,{blockname:l})}).done(function(a){var o=a.getRoot();a.modal.addClass("modal-dialog-centered"),o.on(n.bodyRendered,function(){var o=a.modal.find(".block-settings-form");a.modal.find(".save-block-settings").on("click",function(a){a.preventDefault();var n=o.serializeArray(),i={};e(n).each(function(e,t){i[t.name]=t.value}),function(a,o){o.blockname=a,o=JSON.stringify(o);var n=e("#"+a).data("sesskey");e.ajax({url:s.requestUrl,type:"GET",data:{action:"set_block_preferences_ajax",sesskey:n,data:o}}).fail(function(e){console.log(e),t.addNotification({message:e,type:"error"})}).always(function(){location.reload()})}(l,i)})}),o.on(n.hidden,function(){a.destroy()}),a.show()});else if("hide"==d){var c=e(this).data("hidden"),u=e(this);e.ajax({url:s.requestUrl,type:"GET",data:{action:"toggle_hide_block_ajax",sesskey:M.cfg.sesskey,data:JSON.stringify({blockname:l,hidden:c})}}).done(function(e){(e=JSON.parse(e)).success&&(c?(u.closest(".edwiserReport-block").removeClass("block-hidden"),u.data("hidden",0),u.html(M.util.get_string("hide","local_edwiserreports"))):(u.closest(".edwiserReport-block").addClass("block-hidden"),u.data("hidden",1),u.html(M.util.get_string("unhide","local_edwiserreports"))))})}else"editcap"==d&&o.create({title:"Edit Block Capabilities",body:a.loadFragment("local_edwiserreports","get_blockscap_form",r,{blockname:l})}).done(function(o){var i=o.getRoot();o.modal.addClass("modal-dialog-centered modal-lg"),i.on(n.bodyRendered,function(){var n=o.modal.find(".block-cap-form");o.modal.find("#menucapabilities").on("change",function(t){t.preventDefault();var i=n.serializeArray(),s={};e(i).each(function(e,t){s[t.name]=t.value}),a.loadFragment("local_edwiserreports","block_overview_display",r,{capvalue:s.capabilities}).done(function(e,t,a){o.modal.find(".cap-overview").html(e),B(o)})}),B(o),n=o.modal.find(".block-cap-form"),o.modal.find(".save-block-caps").on("click",function(a){a.preventDefault();var i=n.serializeArray(),r={};e(i).each(function(e,t){r[t.name]=t.value}),function(a,o,n){o.blockname=a,o=JSON.stringify(o);var i=e("#"+a).data("sesskey");e.ajax({url:s.requestUrl,type:"GET",data:{action:"set_block_capability_ajax",sesskey:i,data:o}}).done(function(e){(e=JSON.parse(e)).success?(n(),location.reload()):t.addNotification({message:"Error",type:"error"})}).fail(function(e){console.log(e),t.addNotification({message:e,type:"error"})}).always(function(){n(),location.reload()})}(l,r,function(){o.hide()})})}),i.on(n.hidden,function(){o.destroy()}),o.show()})}),function(t){var a,o='<div id="editing-btn" class="d-flex flex-wrap">';o+='<div class="ml-auto d-flex">',t?(t=0,a="Stop Customising this page",o+='<div class="singlebutton">',o+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',o+='<input type="hidden" name="reset" value="1">',o+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',o+='<button type="submit" class="btn btn-secondary" title="">Reset Page to Default</button>',o+="</form>",o+="</div>"):(t=1,a="Customise this page");o+='<div class="singlebutton">',o+='<form method="post" action="'+M.cfg.wwwroot+'/local/edwiserreports/index.php">',o+='<input type="hidden" name="edit" value="'+t+'">',o+='<input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'">',o+='<button type="submit" class="btn btn-secondary" title="">'+a+"</button>",o+="</form>",o+="</div>",o+="</div></div>",e("#page-local-edwiserreports-index #page-header .card-body").append(o)}(e("#wdm-edwiserreports").data("editing"))}),{loader:G,insight:function(t,a){i.render("local_edwiserreports/insight-placeholder",{}).done(function(o,n){i.replaceNodeContents(t,o,n),i.render("local_edwiserreports/insight",a).done(function(e,a){i.replaceNodeContents(t,e,a)}).fail(function(a){Notification.exception(a),e(t).remove()})})},timeFormatter:function(e,t){e=Number(e);var a=Math.floor(e/3600),o=Math.floor(e%3600/60),n=Math.floor(e%3600%60);if("object"==_typeof(t)&&void 0!==t.dataPointIndex&&-1!==t.dataPointIndex){var i=[],r=void 0!==t.short&&t.short;return a>0&&(r?i.push(a+" h."):i.push(a+" "+(1==a?"hour":"hours"))),o>0&&(r?i.push(o+" min."):i.push(o+" "+(1==o?"minute":"minutes"))),n>0&&(r?0===i.length&&i.push(n+" sec."):i.push(n+" "+(1==n?"second":"seconds"))),0==i.length&&i.push(0),i.join(", ")}return[a>0?a<10?"0"+a:a:"00",o>0?o<10?"0"+o:o:"00",n>0?n<10?"0"+n:n:"00"].join(":")},dateChange:function(t){e(document).on("edwiserreport:datechange",function(e){t(e.detail.date)})},stylePaginationButton:U,handleSearchInput:function(){e("body").on("input",P.SEARCHTABLE,function(){e(this).toggleClass("empty",""===e(this).val())})}}});
//# sourceMappingURL=common.min.js.map
