{"version":3,"sources":["block_activeusers.js"],"names":["define","$","Chart","defaultConfig","V","common","cfg","activeUsersGraph","panel","getPanel","panelBody","panelTitle","panelFooter","dropdownMenu","dropdownItem","dropdownToggle","flatpickrCalender","chart","loader","dropdownButton","refreshBtn","exportUrlLink","filter","dropdownInput","listner","init","notifyListner","getActiveUsersBlockData","hide","show","ajax","url","requestUrl","data","action","sesskey","JSON","stringify","done","response","parse","graph","labels","fail","error","console","log","always","destroy","defaults","global","defaultFontFamily","fontFamily","defaultFontStyle","fontStyle","ctx","type","datasets","label","labelName","activeUsers","backgroundColor","borderColor","pointBorderColor","pointBackgroundColor","pointStyle","enrolments","completionRate","options","find","val","html","setInterval","inceamentUpdateTime","removeClass","fadeIn","parseInt","text","document","ready","getActiveUsersBlock","on","addClass","placeholder","attr","click","e","target","hasClass","parents","length","this","flatpickr","mode","altInput","altFormat","dateFormat","maxDate","appendTo","getElementById","onOpen","onClose","date","includes","changeExportUrl","filterReplaceFlag","selectedCustomDate"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine([\n    'jquery',\n    'core/chartjs',\n    'local_edwiserreports/defaultconfig',\n    'local_edwiserreports/variables',\n    './common',\n    'local_edwiserreports/flatpickr'\n], function($, Chart, defaultConfig, V, common) {\n    /* Varible for active users block */\n    var cfg = null;\n    var activeUsersGraph = null;\n    var panel = defaultConfig.getPanel(\"#activeusersblock\");\n    var panelBody = defaultConfig.getPanel(\"#activeusersblock\", \"body\");\n    var panelTitle = defaultConfig.getPanel(\"#activeusersblock\", \"title\");\n    var panelFooter = defaultConfig.getPanel(\"#activeusersblock\", \"footer\");\n    var dropdownMenu = panel + \" .dropdown-menu[aria-labelledby='filter-dropdown']:not('custom')\";\n    var dropdownItem = dropdownMenu + \" .dropdown-item\";\n    var dropdownToggle = panel + \" #filter-dropdown.dropdown-toggle\";\n    var flatpickrCalender = panel + \" #flatpickrCalender\";\n    var chart = panelBody + \" .ct-chart\";\n    var loader = panelBody + \" .loader\";\n    var dropdownButton = panel + \" button#filter-dropdown\";\n    var refreshBtn = panelTitle + \" .refresh\";\n    var exportUrlLink = panel + V.exportUrlLink;\n    var filter = null;\n    var dropdownInput = panelTitle + \" input.form-control.input\";\n    var listner = null;\n\n    /**\n     * Initialize\n     * @param {Function} notifyListner Callback function\n     */\n    function init(notifyListner) {\n        listner = notifyListner;\n\n        /* Custom Dropdown hide and show */\n        $(document).ready(function() {\n            cfg = defaultConfig.getActiveUsersBlock();\n\n            // If course progress block is there\n            if (cfg) {\n                /* Show custom dropdown */\n                $(dropdownToggle).on(\"click\", function() {\n                    $(dropdownMenu).addClass(\"show\");\n                });\n\n                /* Added Custom Value in Dropdown */\n                $(dropdownInput).ready(function() {\n                    var placeholder = $(dropdownInput).attr(\"placeholder\");\n                    $(dropdownInput).val(placeholder);\n                });\n\n                /* Hide dropdown when click anywhere in the screen */\n                $(document).click(function(e) {\n                    if (!($(e.target).hasClass(\"dropdown-menu\") ||\n                        $(e.target).parents(\".dropdown-menu\").length)) {\n                        $(dropdownMenu).removeClass('show');\n                    }\n                });\n\n                /* Select filter for active users block */\n                $(dropdownItem + \":not(.custom)\").on('click', function() {\n                    filter = $(this).attr('value');\n                    $(dropdownMenu).removeClass('show');\n                    $(dropdownButton).html($(this).text());\n                    getActiveUsersBlockData(filter);\n                    $(flatpickrCalender).val(\"Custom\");\n                    $(dropdownInput).val(\"Custom\");\n                });\n\n                /* Refresh when click on the refresh button */\n                $(refreshBtn).on('click', function() {\n                    $(this).addClass(\"refresh-spin\");\n                    getActiveUsersBlockData(filter);\n                });\n\n                createDropdownCalendar();\n            } else {\n                /* Notify that this event is completed */\n                listner(\"activeUsers\");\n            }\n        });\n\n        /**\n         * Create Calender in dropdown tp select range.\n         */\n        function createDropdownCalendar() {\n            /* Call function to initialize the active users block graph */\n            activeUsersGraph = getActiveUsersBlockData();\n\n            $(flatpickrCalender).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d/m/Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: document.getElementById(\"activeUser-calendar\"),\n                onOpen: function() {\n                    $(dropdownMenu).addClass('withcalendar');\n                },\n                onClose: function() {\n                    $(dropdownMenu).removeClass('withcalendar');\n                    $(dropdownMenu).removeClass('show');\n                    selectedCustomDate();\n                }\n            });\n        }\n\n        /**\n         * After Select Custom date get active users details.\n         */\n        function selectedCustomDate() {\n            filter = $(flatpickrCalender).val();\n            var date = $(dropdownInput).val();\n\n            /* If correct date is not selected then return false */\n            if (!filter.includes(\"to\")) {\n                return;\n            }\n\n            defaultConfig.changeExportUrl(filter, exportUrlLink, V.filterReplaceFlag);\n            $(dropdownButton).html(date);\n            $(flatpickrCalender).val(\"\");\n            getActiveUsersBlockData(filter);\n        }\n\n        /**\n         * Get data for active users block.\n         * @param {String} filter Filter string\n         */\n        function getActiveUsersBlockData(filter) {\n            $(chart).hide();\n            $(loader).show();\n\n            /* If filter is not set then select all */\n            if (!filter) {\n                filter = \"weekly\";\n            }\n\n            // Show loader.\n            common.loader.show('#activeusersblock');\n\n            $.ajax({\n                url: defaultConfig.requestUrl,\n                data: {\n                    action: 'get_activeusers_graph_data_ajax',\n                    sesskey: $(panel).data(\"sesskey\"),\n                    data: JSON.stringify({\n                        filter: filter\n                    })\n                },\n            }).done(function(response) {\n                response = JSON.parse(response);\n                cfg.graph.data = response.data;\n                cfg.graph.labels = response.labels;\n            }).fail(function(error) {\n                console.log(error);\n            }).always(function() {\n                activeUsersGraph = generateActiveUsersGraph();\n                // V.changeExportUrl(filter, exportUrlLink, V.filterReplaceFlag);\n                $(panelFooter).find('.download-links input[name=\"filter\"]').val(filter);\n\n                // Change graph variables\n                resetUpdateTime();\n                setInterval(inceamentUpdateTime, 1000 * 60);\n                $(refreshBtn).removeClass('refresh-spin');\n                $(loader).hide();\n                $(chart).fadeIn(\"slow\");\n\n                /* Notify that this event is completed */\n                listner(\"activeUsers\");\n\n                // Hide loader.\n                common.loader.hide('#activeusersblock');\n            });\n        }\n\n        /**\n         * Reset Update time in panel header.\n         */\n        function resetUpdateTime() {\n            $(panelTitle + \" #updated-time > span.minute\").html(0);\n        }\n\n        /**\n         * Increament update time in panel header.\n         */\n        function inceamentUpdateTime() {\n            $(panelTitle + \" #updated-time > span.minute\")\n            .html(parseInt($(panelTitle + \" #updated-time > span.minute\").text()) + 1);\n        }\n\n        /**\n         * Generate Active Users graph.\n         * @returns {Object} Active users graph\n         */\n        function generateActiveUsersGraph() {\n            if (activeUsersGraph) {\n                activeUsersGraph.destroy();\n            }\n\n            Chart.defaults.global.defaultFontFamily = cfg.graph.fontFamily;\n            Chart.defaults.global.defaultFontStyle = cfg.graph.fontStyle;\n            activeUsersGraph = new Chart(cfg.ctx, {\n                type: cfg.graph.type,\n                data: getGraphData(),\n                options: cfg.graph.options\n            });\n            return activeUsersGraph;\n        }\n\n        /**\n         * Get graph data.\n         * @return {Object}\n         */\n        function getGraphData() {\n            return {\n                labels: cfg.graph.labels,\n                datasets: [{\n                    label: cfg.graph.labelName.activeUsers,\n                    data: cfg.graph.data.activeUsers,\n                    backgroundColor: cfg.graph.backgroundColor.activeUsers,\n                    borderColor: cfg.graph.borderColor.activeUsers,\n                    pointBorderColor: cfg.graph.borderColor.activeUsers,\n                    pointBackgroundColor: cfg.graph.borderColor.activeUsers,\n                    pointStyle: cfg.graph.pointStyle\n                },\n                {\n                    label: cfg.graph.labelName.enrolments,\n                    data: cfg.graph.data.enrolments,\n                    backgroundColor: cfg.graph.backgroundColor.enrolments,\n                    borderColor: cfg.graph.borderColor.enrolments,\n                    pointBorderColor: cfg.graph.borderColor.enrolments,\n                    pointBackgroundColor: cfg.graph.borderColor.enrolments,\n                    pointStyle: cfg.graph.pointStyle\n                },\n                {\n                    label: cfg.graph.labelName.completionRate,\n                    data: cfg.graph.data.completionRate,\n                    backgroundColor: cfg.graph.backgroundColor.completionRate,\n                    borderColor: cfg.graph.borderColor.completionRate,\n                    pointBorderColor: cfg.graph.borderColor.completionRate,\n                    pointBackgroundColor: cfg.graph.borderColor.completionRate,\n                    pointStyle: cfg.graph.pointStyle\n                }]\n            };\n        }\n    }\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});\n"],"file":"block_activeusers.min.js"}