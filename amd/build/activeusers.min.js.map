{"version":3,"sources":["activeusers.js"],"names":["define","$","ModalFactory","ModalEvents","Notification","Fragment","Templates","V","common","init","CONTEXTID","PageId","ActiveUsersTable","loader","ModalTrigger","dropdownToggle","dropdownMenu","dropdownItem","flatpickrCalender","dropdownButton","cohortFilter","filter","cohortId","dropdownInput","sesskey","DataTable","createModalOfUsersList","document","on","title","action","this","data","ModalRoot","titleDate","formatDate","Date","eval","M","util","get_string","component","date","create","body","loadFragment","page","cohortid","then","modal","getRoot","find","addClass","setTitle","show","hidden","destroy","bodyRendered","ModalTable","hasClass","empty","dom","language","searchPlaceholder","emptyTable","drawCallback","stylePaginationButton","bInfo","fail","exception","createDropdownCalendar","flatpickr","mode","altInput","altFormat","dateFormat","maxDate","appendTo","getElementById","onOpen","onClose","removeClass","selectedCustomDate","val","includes","html","createActiveUsersTable","hide","ajax","url","requestUrl","JSON","stringify","done","response","ActiveUsers","parse","each","labels","idx","parseInt","getTime","activeusers","activeUsers","courseenrolment","enrolments","coursecompletion","completionRate","context","render","js","replaceNode","ex","console","log","always","responsive","order","columnDefs","targets","className","error","select2","ready","placeholder","attr","click","e","target","parents","length","text"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine([\n    'jquery',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/notification',\n    'core/fragment',\n    'core/templates',\n    './variables',\n    './common',\n    './jquery.dataTables',\n    './dataTables.bootstrap4',\n    './flatpickr'\n], function($, ModalFactory, ModalEvents, Notification, Fragment, Templates, V, common) {\n    /**\n     * Initialize\n     * @param {integer} CONTEXTID Current page context id\n     */\n    function init(CONTEXTID) {\n        var PageId = \"#wdm-activeusers-individual\";\n        var ActiveUsersTable = PageId + \" .table\";\n        var loader = PageId + \" .loader\";\n        var ModalTrigger = ActiveUsersTable + \" a\";\n        var dropdownToggle = \"#filter-dropdown.dropdown-toggle\";\n        var dropdownMenu = \".dropdown-menu[aria-labelledby='filter-dropdown']\";\n        var dropdownItem = dropdownMenu + \" .dropdown-item\";\n        var flatpickrCalender = \"#flatpickrCalender\";\n        var dropdownButton = \"button#filter-dropdown\";\n        var cohortFilter = '.cohort-select';\n        var filter = 'weekly';\n        var cohortId = 0;\n        var dropdownInput = \"#wdm-userfilter input.form-control.input\";\n        var sesskey = null;\n        var DataTable = null;\n\n        // Initialize select2.\n        $(PageId).find('.singleselect').select2();\n\n        $(PageId).find('.download-links input[name=\"cohortid\"]').val(cohortId);\n        $(PageId).find('.download-links input[name=\"filter\"]').val(filter);\n\n        // Var tableDom = '<\"row\"f><\"row\"t><\"row\"<\"d-none\"i><p>>';\n        $(document).ready(function() {\n            /* Show custom dropdown */\n            $(dropdownToggle).on(\"click\", function() {\n                $(dropdownMenu).addClass(\"show\");\n            });\n\n            /* Added Custom Value in Dropdown */\n            $(dropdownInput).ready(function() {\n                var placeholder = $(dropdownInput).attr(\"placeholder\");\n                $(dropdownInput).val(placeholder);\n            });\n\n            /* Hide dropdown when click anywhere in the screen */\n            $(document).click(function(e) {\n                if (!($(e.target).hasClass(\"dropdown-menu\") ||\n                        $(e.target).parents(\".dropdown-menu\").length)) {\n                    $(dropdownMenu).removeClass('show');\n                }\n            });\n\n            /* Select filter for active users block */\n            $(dropdownItem + \":not(.custom)\").on('click', function() {\n                filter = $(this).attr('value');\n                $(PageId).find('.download-links input[name=\"filter\"]').val(filter);\n                $(dropdownMenu).removeClass('show');\n                $(dropdownButton).html($(this).text());\n                createActiveUsersTable(filter, cohortId);\n                $(flatpickrCalender).val(\"Custom\");\n                $(dropdownInput).val(\"Custom\");\n            });\n\n            // Cohort filter.w\n            $(PageId + \" \" + cohortFilter).on('change', function() {\n                cohortId = $(this).val();\n                $(PageId).find('.download-links input[name=\"cohortid\"]').val(cohortId);\n                createActiveUsersTable(filter, cohortId);\n            })\n\n            createActiveUsersTable(filter, cohortId);\n            createModalOfUsersList();\n            createDropdownCalendar();\n        });\n\n        /**\n         * Create modal of Users list\n         */\n        function createModalOfUsersList() {\n            $(document).on('click', ModalTrigger, function() {\n                var title = \"\";\n                var action = $(this).data(\"action\");\n                var filter = $(this).data(\"filter\");\n                var ModalRoot = null;\n\n                // eslint-disable-next-line no-eval\n                var titleDate = V.formatDate(new Date(eval(filter * 1000)), \"d MMM yyyy\");\n\n                if (action == \"activeusers\") {\n                    title = M.util.get_string('activeusersmodaltitle', V.component, {\n                        \"date\": titleDate\n                    });\n                } else if (action == \"enrolments\") {\n                    title = M.util.get_string('enrolmentsmodaltitle', V.component, {\n                        \"date\": titleDate\n                    });\n                } else if (action == \"completions\") {\n                    title = M.util.get_string('completionsmodaltitle', V.component, {\n                        \"date\": titleDate\n                    });\n                }\n\n                ModalFactory.create({\n                    body: Fragment.loadFragment(\n                        'local_edwiserreports',\n                        'userslist',\n                        CONTEXTID, {\n                            page: 'activeusers',\n                            filter: filter,\n                            cohortid: cohortId,\n                            action: action\n                        }\n                    )\n                }).then(function(modal) {\n                    ModalRoot = modal.getRoot();\n                    ModalRoot.find('.modal-dialog').addClass('modal-lg');\n                    modal.setTitle(title);\n                    modal.show();\n                    ModalRoot.on(ModalEvents.hidden, function() {\n                        modal.destroy();\n                    });\n\n                    ModalRoot.on(ModalEvents.bodyRendered, function() {\n                        var ModalTable = ModalRoot.find(\".modal-table\");\n\n                        // If empty then remove colspan\n                        if (ModalTable.find(\"tbody\").hasClass(\"empty\")) {\n                            ModalTable.find(\"tbody\").empty();\n                        }\n\n                        // Create dataTable for userslist\n                        ModalRoot.find(\".modal-table\").DataTable({\n                            dom: '<\"edwiserreports-table\"<\"table-filter d-flex\"f><t><\"table-pagination\"p>>',\n                            language: {\n                                searchPlaceholder: \"Search User\",\n                                emptyTable: \"There are no users\"\n                            },\n                            drawCallback: function() {\n                                common.stylePaginationButton(this);\n                            },\n                            bInfo: false\n                        });\n                    });\n                    return;\n                }).fail(Notification.exception);\n            });\n        }\n\n        /**\n         * Create Calender in dropdown tp select range.\n         */\n        function createDropdownCalendar() {\n            $(flatpickrCalender).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d/m/Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: document.getElementById(\"activeUser-calendar\"),\n                onOpen: function() {\n                    $(dropdownMenu).addClass('withcalendar');\n                },\n                onClose: function() {\n                    $(dropdownMenu).removeClass('withcalendar');\n                    $(dropdownMenu).removeClass('show');\n                    selectedCustomDate();\n                }\n            });\n        }\n\n        /**\n         * After Select Custom date get active users details.\n         */\n        function selectedCustomDate() {\n            filter = $(flatpickrCalender).val();\n            var date = $(dropdownInput).val();\n\n            /* If correct date is not selected then return false */\n            if (!filter.includes(\"to\")) {\n                return;\n            }\n\n            $(dropdownButton).html(date);\n            $(flatpickrCalender).val(\"\");\n            $(PageId).find('.download-links input[name=\"filter\"]').val(filter);\n            createActiveUsersTable(filter, cohortId);\n        }\n\n        /**\n         * Create Active Users Table.\n         * @param {string} filter Filter string.\n         * @param {integer} cohortId Integer string.\n         */\n        function createActiveUsersTable(filter, cohortId) {\n            sesskey = $(PageId).data(\"sesskey\");\n\n            /* If datatable is already created then destroy the table */\n            if (DataTable) {\n                DataTable.destroy();\n                $(ActiveUsersTable).hide();\n                $(loader).show();\n            }\n\n            // Show loader.\n            common.loader.show(\"#wdm-activeusers-individual\");\n\n            $.ajax({\n                url: V.requestUrl,\n                data: {\n                    action: 'get_activeusers_graph_data_ajax',\n                    sesskey: sesskey,\n                    data: JSON.stringify({\n                        filter: filter,\n                        cohortid: cohortId\n                    })\n                },\n            }).done(function(response) {\n                var ActiveUsers = [];\n                response = JSON.parse(response);\n\n                $.each(response.labels, function(idx, val) {\n                    ActiveUsers[idx] = {\n                        date: val,\n                        filter: parseInt((new Date(val).getTime() / 1000)),\n                        activeusers: response.data.activeUsers[idx],\n                        courseenrolment: response.data.enrolments[idx],\n                        coursecompletion: response.data.completionRate[idx]\n                    };\n                });\n\n                var context = {\n                    activeusers: ActiveUsers,\n                    sesskey: sesskey\n                };\n\n                // eslint-disable-next-line promise/catch-or-return\n                Templates.render('local_edwiserreports/activeuserstable', context)\n                    .then(function(html, js) {\n                        Templates.replaceNode(ActiveUsersTable, html, js);\n                        return;\n                    }).fail(function(ex) {\n                        console.log(ex);\n                    }).always(function() {\n                        DataTable = $(ActiveUsersTable).DataTable({\n                            responsive: true,\n                            dom: '<\"edwiserreports-table\"<\"table-filter d-flex\"fl><\"p-2\"i><t><\"table-pagination\"p>>',\n                            order: [\n                                [0, 'desc']\n                            ],\n                            language: {\n                                searchPlaceholder: \"Search Date\",\n                                emptyTable: \"There are no active users\"\n                            },\n                            columnDefs: [{\n                                    \"targets\": 0,\n                                    \"className\": \"text-left\"\n                                },\n                                {\n                                    \"targets\": \"_all\",\n                                    \"className\": \"text-center\",\n                                }\n                            ],\n                            drawCallback: function() {\n                                common.stylePaginationButton(this);\n                            }\n                        });\n                        $(ActiveUsersTable).show();\n                        $(loader).hide();\n\n                        // Hide loader.\n                        common.loader.hide(\"#wdm-activeusers-individual\");\n                    });\n            }).fail(function(error) {\n                console.log(error);\n                // Hide loader.\n                common.loader.hide(\"#wdm-activeusers-individual\");\n            });\n        }\n    }\n    return {\n        init: init\n    };\n\n});"],"file":"activeusers.min.js"}