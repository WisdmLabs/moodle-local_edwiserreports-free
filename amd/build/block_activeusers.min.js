/**
 * Plugin administration pages are defined here.
 *
 * @copyright   2021 wisdmlabs <support@wisdmlabs.com>
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */ define(["jquery","./chart/apexcharts","core/notification","./defaultconfig","./common","./flatpickr"],function(e,a,t,r,s){var o=null,i=null,l=r.getPanel("#activeusersblock","body"),n=r.getPanel("#activeusersblock","footer"),c=l+" .ct-chart",d=l+" .loader",p=l+" .refresh",h="last7days",f=null;let g={series:[],chart:{type:"line",height:350,dropShadow:{enabled:!0,color:"#000",top:18,left:7,blur:10,opacity:.2},toolbar:{show:!1,tools:{download:!1,reset:'<i class="fa fa-refresh"></i>'}},zoom:{enabled:!1}},markers:{size:0},tooltip:{enabled:!0,enabledOnSeries:void 0,shared:!0,followCursor:!1,intersect:!1,inverseOrder:!1,fillSeriesColor:!1,onDatasetHover:{highlightDataSeries:!1},y:{formatter:void 0,title:{}},items:{display:"flex"},fixed:{enabled:!1,position:"topRight",offsetX:0,offsetY:0},custom:function({series:e,seriesIndex:a,dataPointIndex:t,w:r}){let o=`
 <div class="apexcharts-tooltip-title" style="font-family: Helvetica, Arial, sans-serif; font-size: 12px;">
 ${s.formatDate(new Date(r.config.xaxis.categories[t]),"d MMM yyyy")}
</div>`;for(let i=0;i<r.config.series.length;i++){let l=r.config.series[i];0!=l.data.length&&(o+=`<div class="apexcharts-tooltip-series-group apexcharts-active" style="order: ${i}; display: flex;">
     <span class="apexcharts-tooltip-marker" style="background-color: ${r.config.colors[i]};"></span>
     <div class="apexcharts-tooltip-text" style="font-family: Helvetica, Arial, sans-serif; font-size: 12px;">
         <div class="apexcharts-tooltip-y-group">
             <span class="apexcharts-tooltip-text-y-label">${r.config.series[i].name}: </span>
             <span class="apexcharts-tooltip-text-y-value">${r.config.series[i].data[t]}</span>
         </div>
     </div>
 </div>`)}return o+`
 <span style="color: black; font-size: 0.871rem; order: 4; padding: 0px 15px;">${M.util.get_string("clickondatapoint","local_edwiserreports")}</span>
`}},stroke:{curve:"smooth",width:2,lineCap:"round"},grid:{borderColor:"#e7e7e7"},xaxis:{categories:null,type:"datetime",labels:{hideOverlappingLabels:!0,datetimeFormatter:{year:"yyyy",month:"MMM 'yy",day:"dd MMM",hour:""}},tooltip:{enabled:!1}},yaxis:{labels:{formatter:function(e,a){return void 0===e?e:e.toFixed(0)}}},legend:{position:"top",horizontalAlign:"left",offsetY:"-20",itemMargin:{horizontal:10,vertical:0}},colors:r.getColorTheme(),dataLabels:{enabled:!1}};return{init:function u(m){function y(){e(c).hide(),e(d).show(),s.loader.show("#activeusersblock"),e.ajax({url:r.requestUrl,type:r.requestType,dataType:r.requestDataType,data:{action:"get_activeusers_graph_data_ajax",secret:M.local_edwiserreports.secret,lang:e("html").attr("lang"),data:JSON.stringify({precalculated:-1!==["weekly","monthly","yearly"].indexOf(h),filter:h,graphajax:!0})}}).done(function(e){if(!0===e.error&&"invalidsecretkey"===e.exception.errorcode){m("activeusersblock",e);return}o.graph.data=e.data,o.graph.labels=e.dates.map(e=>864e5*e),s.insight("#activeusersblock .insight",e.insight)}).fail(function(e){t.exception(e)}).always(function(){i=(i&&i.destroy(),(i=new a(e("#apex-chart-active-users").get(0),function e(){let a=Object.assign({},g);try{a.series=[{name:o.graph.labelName.activeUsers,data:o.graph.data.activeUsers},{name:o.graph.labelName.enrolments,data:o.graph.data.enrolments},{name:o.graph.labelName.completionRate,data:o.graph.data.completionRate}],a.xaxis.categories=o.graph.labels,a.chart.toolbar.show=o.graph.labels.length>30,a.chart.zoom.enabled=o.graph.labels.length>30}catch(t){a.series=[],a.xaxis.categories=[],a.chart.toolbar.show=!1,a.chart.zoom.enabled=!1}return a}())).render(),i),e(n).find('.download-links input[name="filter"]').val(h),e(l+" #updated-time > span.minute").html(0),clearInterval(f),f=setInterval($,6e4),e(p).removeClass("refresh-spin"),e(d).hide(),e(c).fadeIn("slow"),s.loader.hide("#activeusersblock")})}function $(){e(l+" #updated-time > span.minute").html(parseInt(e(l+" #updated-time > span.minute").text())+1)}(o=r.getActiveUsersBlock())&&(e(p).on("click",function(){e(this).addClass("refresh-spin"),y()}),s.dateChange(function(a){h=a,e("#activeusersblock").find('.download-links [name="filter"]').val(h),y()}),y())}}});
