"use strict";define(["jquery","core/modal_factory","core/modal_events","core/notification","core/fragment","core/templates","./variables","./common","./jquery.dataTables","./dataTables.bootstrap4","./flatpickr"],function($,ModalFactory,ModalEvents,Notification,Fragment,Templates,V,common){var filter="last7days";function init(CONTEXTID){var PageId="#wdm-activeusers-individual",ActiveUsersTable=PageId+" .table",loader=PageId+" .loader",ModalTrigger=ActiveUsersTable+" a",dropdownToggle="#filter-dropdown.dropdown-toggle",dropdownMenu=".dropdown-menu[aria-labelledby='filter-dropdown']",dropdownItem=dropdownMenu+" .dropdown-item",cohortFilter=".cohort-select",cohortId=0,dropdownInput="#userfilter input.form-control.input",sesskey=null,DataTable=null,modalTable=null,searchTable=PageId+" .table-search-input input",lengthSelect=PageId+" .table-length-input select",flatpickr=null,SELECTOR={DATESELECTED:".selected-period",DATE:".edwiserreports-calendar",DATEMENU:".edwiserreports-calendar + .dropdown-menu",DATEITEM:".edwiserreports-calendar + .dropdown-menu .dropdown-item",DATEPICKER:".edwiserreports-calendar + .dropdown-menu .dropdown-calendar",DATEPICKERINPUT:".edwiserreports-calendar + .dropdown-menu .flatpickr"};function createModalOfUsersList(){$(document).on("click",ModalTrigger,function(){var title="",action=$(this).data("action"),modalFilter=$(this).data("filter"),ModalRoot=null,titleDate=V.formatDate(new Date(eval(86400*modalFilter*1e3)),"d MMM yyyy");"activeusers"==action?title=M.util.get_string("activeusersmodaltitle",V.component,{date:titleDate}):"enrolments"==action?title=M.util.get_string("enrolmentsmodaltitle",V.component,{date:titleDate}):"completions"==action&&(title=M.util.get_string("completionsmodaltitle",V.component,{date:titleDate})),ModalFactory.create({body:Fragment.loadFragment("local_edwiserreports","userslist",CONTEXTID,{page:"activeusers",filter:modalFilter,cohortid:cohortId,action:action})}).then(function(e){(ModalRoot=e.getRoot()).find(".modal-dialog").addClass("modal-lg"),e.setTitle(title),e.show(),ModalRoot.on(ModalEvents.hidden,function(){e.destroy()}),ModalRoot.on(ModalEvents.bodyRendered,function(){var e=ModalRoot.find(".modal-table");e.find("tbody").hasClass("empty")&&e.find("tbody").empty(),modalTable=ModalRoot.find(".modal-table").DataTable({dom:'<"edwiserreports-table"<"p-2"i><t><"table-pagination"p>>',language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nousers","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:M.util.get_string("previous","moodle"),next:M.util.get_string("next","moodle")}},drawCallback:function(){common.stylePaginationButton(this)}}),ModalRoot.find(".table-search-input input").on("input",function(){modalTable.search(this.value).draw()})})}).fail(Notification.exception)})}function createDropdownCalendar(){flatpickr=$(SELECTOR.DATEPICKERINPUT).flatpickr({mode:"range",altInput:!0,altFormat:"d M Y",dateFormat:"Y-m-d",maxDate:"today",appendTo:$(SELECTOR.DATEPICKER).get(0),onOpen:function(){$(SELECTOR.DATEMENU).addClass("withcalendar"),$(SELECTOR.DATE).dropdown("update")},onClose:function(){$(SELECTOR.DATEMENU).removeClass("withcalendar"),selectedCustomDate()}})}function selectedCustomDate(){var e=$(SELECTOR.DATEPICKERINPUT).val(),t=$(SELECTOR.DATEPICKERINPUT).next().val().replace("to","-");$(SELECTOR.DATEPICKERINPUT).next().val(t),e.includes(" to ")?($(SELECTOR.DATEITEM).removeClass("active"),$(SELECTOR.DATEITEM+".custom").addClass("active"),$(SELECTOR.DATE).html(t),filter=e,$(SELECTOR.DATEMENU).removeClass("show"),createActiveUsersTable(cohortId)):flatpickr.clear()}function createActiveUsersTable(e){var t,a,o,r;$(PageId).find('.download-links input[name="filter"]').val(filter);var l=[M.util.get_string("january","local_edwiserreports"),M.util.get_string("february","local_edwiserreports"),M.util.get_string("march","local_edwiserreports"),M.util.get_string("april","local_edwiserreports"),M.util.get_string("may","local_edwiserreports"),M.util.get_string("june","local_edwiserreports"),M.util.get_string("july","local_edwiserreports"),M.util.get_string("august","local_edwiserreports"),M.util.get_string("september","local_edwiserreports"),M.util.get_string("october","local_edwiserreports"),M.util.get_string("november","local_edwiserreports"),M.util.get_string("december","local_edwiserreports")];sesskey=$(PageId).data("sesskey"),DataTable&&(DataTable.destroy(),$(ActiveUsersTable).hide(),$(loader).show()),common.loader.show("#wdm-activeusers-individual"),$.ajax({url:V.requestUrl,data:{action:"get_activeusers_graph_data_ajax",sesskey:sesskey,data:JSON.stringify({filter:filter,cohortid:e})}}).done(function(e){var i=[];e=JSON.parse(e),$.each(e.dates,function(n,s){t=new Date(86400*s*1e3),a=t.getDate(),o=l[t.getMonth()],r=t.getFullYear(),i[n]={date:"".concat(a<10?"0"+a:a," ").concat(o," ").concat(r),filter:e.dates[n],activeusers:e.data.activeUsers[n],courseenrolment:e.data.enrolments[n],coursecompletion:e.data.completionRate[n]}});var n={activeusers:i,sesskey:sesskey};Templates.render("local_edwiserreports/activeuserstable",n).then(function(e,t){Templates.replaceNode(ActiveUsersTable,e,t)}).fail(function(e){Notification.exception(e)}).always(function(){(DataTable=$(ActiveUsersTable).DataTable({responsive:!0,dom:'<"edwiserreports-table"<"p-2"i><t><"table-pagination"p>>',order:[[0,"desc"]],language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("noactiveusers","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:M.util.get_string("previous","moodle"),next:M.util.get_string("next","moodle")}},columnDefs:[{targets:0,className:"text-left"},{targets:"_all",className:"text-center"}],drawCallback:function(){common.stylePaginationButton(this)}})).page.len($(lengthSelect).val()),DataTable.column(0).search($(searchTable).val()).draw(),$(ActiveUsersTable).show(),$(loader).hide(),common.loader.hide("#wdm-activeusers-individual")})}).fail(function(e){Notification.exception(e),common.loader.hide("#wdm-activeusers-individual")})}$(PageId).find(".singleselect").select2(),$(PageId).find('.download-links input[name="cohortid"]').val(cohortId),$(PageId).find('.download-links input[name="filter"]').val(filter),$(document).ready(function(){common.handleSearchInput(),$(dropdownToggle).on("click",function(){$(dropdownMenu).addClass("show")}),$(dropdownInput).ready(function(){var e=$(dropdownInput).attr("placeholder");$(dropdownInput).val(e)}),$(document).click(function(e){$(e.target).hasClass("dropdown-menu")||$(e.target).parents(".dropdown-menu").length||$(dropdownMenu).removeClass("show")}),$(dropdownItem+":not(.custom)").on("click",function(){filter=$(this).data("value"),$(SELECTOR.DATEITEM).removeClass("active"),$(this).addClass("active"),$(SELECTOR.DATE).html($(this).text()),$(SELECTOR.DATEMENU).removeClass("show"),flatpickr.clear(),createActiveUsersTable(cohortId)}),$(PageId+" "+cohortFilter).on("change",function(){cohortId=$(this).val(),$(PageId).find('.download-links input[name="cohortid"]').val(cohortId),createActiveUsersTable(cohortId)}),createActiveUsersTable(cohortId),createModalOfUsersList(),createDropdownCalendar()}),$(lengthSelect).on("change",function(){DataTable.page.len(this.value).draw()}),$(searchTable).on("input",function(){DataTable.column(0).search(this.value).draw()})}return{init:init}});
//# sourceMappingURL=activeusers.min.js.map
