{"version":3,"sources":["main.js"],"names":["define","$","common","insights","CFG","siteAccess","activeCourses","activeUsers","courseProgress","courseEngagement","inactiveUsers","realTimeUsers","todaysActivity","grade","visitsonsite","timespentonsite","timespentoncourse","courseactivitystatus","learnercourseprogress","learnertimespentonsite","PROMISE","GET_TIMEPERIOD_LABEL","timeperiod","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","SELECTOR","ROOT","DATESELECTED","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","blocks","flatpickr","validateUser","blockid","response","concat","html","exception","message","showTimeLabel","date","done","startdate","Date","enddate","startDay","getDate","endDay","toLocaleString","month","getFullYear","fail","ex","Notification","throwDateEvent","label","dateChangeEvent","CustomEvent","detail","document","dispatchEvent","init","ready","text","handleSearchInput","each","index","select","val","find","forEach","block","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","addClass","dropdown","onClose","dateAlternate","removeClass","next","replace","includes","clear","on","this"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    './common',\n    './insights',\n    './defaultconfig',\n    './block_siteaccess',\n    './block_activecourses',\n    './block_activeusers',\n    './block_courseprogress',\n    './block_courseengagement',\n    './block_inactiveusers',\n    './block_realtimeusers',\n    './block_todaysactivity',\n    './block_grade',\n    './block_visitsonsite',\n    './block_timespentonsite',\n    './block_timespentoncourse',\n    './block_courseactivitystatus',\n    './block_learnercourseprogress',\n    './block_learnertimespentonsite'\n], function(\n    $,\n    common,\n    insights,\n    CFG,\n    siteAccess,\n    activeCourses,\n    activeUsers,\n    courseProgress,\n    courseEngagement,\n    inactiveUsers,\n    realTimeUsers,\n    todaysActivity,\n    grade,\n    visitsonsite,\n    timespentonsite,\n    timespentoncourse,\n    courseactivitystatus,\n    learnercourseprogress,\n    learnertimespentonsite\n) {\n\n    /**\n     * Promises.\n     */\n    var PROMISE = {\n        /**\n         * Get time period label to show in the header.\n         * @param {String} timeperiod Time period.\n         * @returns {Promise}\n         */\n        GET_TIMEPERIOD_LABEL: function(timeperiod) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_timeperiod_label_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: timeperiod\n                }\n            });\n        },\n    };\n\n    /**\n     * Selector list.\n     */\n    var SELECTOR = {\n        ROOT: '#wdm-edwiserreports',\n        DATESELECTED: '.selected-period',\n        DATE: '.edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Blocks list.\n     */\n    var blocks = [\n        siteAccess,\n        activeCourses,\n        activeUsers,\n        courseProgress,\n        courseEngagement,\n        inactiveUsers,\n        realTimeUsers,\n        todaysActivity,\n        grade,\n        visitsonsite,\n        timespentonsite,\n        timespentoncourse,\n        courseactivitystatus,\n        learnercourseprogress,\n        learnertimespentonsite\n    ];\n\n    /**\n     * Flat picker custom date.\n     */\n    let flatpickr = null;\n\n    /**\n     * This function will show validation error in block card.\n     * @param {String} blockid Block id\n     * @param {Object} response User validation response\n     */\n    function validateUser(blockid, response) {\n        $(`#${blockid} .panel-body`).html(response.exception.message);\n    }\n\n    /**\n     * Show time duration in header.\n     * @param {String} date Time period.\n     */\n    function showTimeLabel(date) {\n        PROMISE.GET_TIMEPERIOD_LABEL(date).done(function(response) {\n            let startdate = new Date(response.startdate * 86400000);\n            let enddate = new Date(response.enddate * 86400000);\n            let startDay = startdate.getDate();\n            startDay = startDay < 10 ? '0' + startDay : startDay;\n            let endDay = enddate.getDate();\n            endDay = endDay < 10 ? '0' + endDay : endDay;\n            $(SELECTOR.DATESELECTED).html(`\n            ${startDay} ${startdate.toLocaleString('default', {\n                month: 'long'\n            })} ${startdate.getFullYear()} -\n            ${endDay} ${enddate.toLocaleString('default', {\n                month: 'long'\n            })} ${enddate.getFullYear()}`);\n        }).fail(function(ex) {\n            Notification.exception(ex);\n        });\n    }\n\n    /**\n     * Throw an event with date change data.\n     * @param {String} date  Date\n     * @param {String} label Date label\n     */\n    function throwDateEvent(date, label) {\n        let dateChangeEvent = new CustomEvent('edwiserreport:datechange', {\n            detail: {\n                date: date\n            }\n        });\n        document.dispatchEvent(dateChangeEvent);\n        showTimeLabel(date, label);\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function customDateSelected() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // Date d M Y format.\n        $(SELECTOR.DATEPICKERINPUT).next().val(dateAlternate);\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        // Throw date change event.\n        throwDateEvent(date, dateAlternate);\n    }\n\n    /**\n     * Init main.js\n     */\n    var init = function() {\n        $(document).ready(function() {\n\n            insights.init();\n\n            let currentDate = $(SELECTOR.DATEITEM + '.active').data('value');\n\n            // Show time period in header.\n            showTimeLabel(\n                currentDate,\n                $(SELECTOR.DATEITEM + '.active').text()\n            );\n\n            common.handleSearchInput();\n\n            // Forcefully applying first option to select dropdown element.\n            $('.singleselect').each(function(index, select) {\n                $(select).val($(select).find('option:nth-child(1)').val());\n            });\n\n            blocks.forEach(block => {\n                block.init(validateUser);\n            });\n\n            flatpickr = $(SELECTOR.DATEPICKERINPUT).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d M Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: $(SELECTOR.DATEPICKER).get(0),\n                onOpen: function() {\n                    $(SELECTOR.DATEMENU).addClass('withcalendar');\n                    $(SELECTOR.DATE).dropdown('update');\n                },\n                onClose: function() {\n                    $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                    customDateSelected();\n                }\n            });\n\n            /* Date selector listener */\n            $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n                // Set custom selected item as active.\n                $(SELECTOR.DATEITEM).removeClass('active');\n                $(this).addClass('active');\n\n                // Show selected item on dropdown button.\n                $(SELECTOR.DATE).html($(this).text());\n\n                // Clear custom date.\n                flatpickr.clear();\n\n                // Throw date change event.\n                throwDateEvent($(this).data('value'), $(this).text());\n            });\n        });\n    };\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});"],"file":"main.min.js"}