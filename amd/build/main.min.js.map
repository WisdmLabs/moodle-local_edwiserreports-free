{"version":3,"sources":["main.js"],"names":["define","$","common","insights","CFG","siteAccess","activeCourses","activeUsers","courseProgress","courseEngagement","inactiveUsers","realTimeUsers","todaysActivity","grade","visitsonsite","timespentonsite","timespentoncourse","courseactivitystatus","learnercourseprogress","learnertimespentonsite","PROMISE","GET_TIMEPERIOD_LABEL","timeperiod","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","SELECTOR","ROOT","DATESELECTED","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","blocks","flatpickr","validateUser","blockid","response","html","exception","message","showTimeLabel","date","done","startdate","Date","enddate","startDay","getDate","endDay","customdate","toLocaleString","month","getFullYear","css","direction","text-align","fail","ex","Notification","throwDateEvent","label","dateChangeEvent","CustomEvent","detail","document","dispatchEvent","init","ready","text","handleSearchInput","each","index","select","val","find","forEach","block","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","addClass","dropdown","onClose","removeClass","dateAlternate","next","replace","dirattr","stringarr","split","includes","clear","customDateSelected","on","this"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'local_edwiserreports/jquery',\n    './common',\n    './insights',\n    './defaultconfig',\n    './block_siteaccess',\n    './block_activecourses',\n    './block_activeusers',\n    './block_courseprogress',\n    './block_courseengagement',\n    './block_inactiveusers',\n    './block_realtimeusers',\n    './block_todaysactivity',\n    './block_grade',\n    './block_visitsonsite',\n    './block_timespentonsite',\n    './block_timespentoncourse',\n    './block_courseactivitystatus',\n    './block_learnercourseprogress',\n    './block_learnertimespentonsite'\n], function(\n    $,\n    common,\n    insights,\n    CFG,\n    siteAccess,\n    activeCourses,\n    activeUsers,\n    courseProgress,\n    courseEngagement,\n    inactiveUsers,\n    realTimeUsers,\n    todaysActivity,\n    grade,\n    visitsonsite,\n    timespentonsite,\n    timespentoncourse,\n    courseactivitystatus,\n    learnercourseprogress,\n    learnertimespentonsite,\n) {\n\n    /**\n     * Promises.\n     */\n    var PROMISE = {\n        /**\n         * Get time period label to show in the header.\n         * @param {String} timeperiod Time period.\n         * @returns {Promise}\n         */\n        GET_TIMEPERIOD_LABEL: function(timeperiod) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_timeperiod_label_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: timeperiod\n                }\n            });\n        },\n    };\n\n    /**\n     * Selector list.\n     */\n    var SELECTOR = {\n        ROOT: '#wdm-edwiserreports',\n        DATESELECTED: '.selected-period',\n        DATE: '.edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Blocks list.\n     */\n    var blocks = [\n        siteAccess,\n        activeCourses,\n        activeUsers,\n        courseProgress,\n        courseEngagement,\n        inactiveUsers,\n        realTimeUsers,\n        todaysActivity,\n        grade,\n        visitsonsite,\n        timespentonsite,\n        timespentoncourse,\n        courseactivitystatus,\n        learnercourseprogress,\n        learnertimespentonsite\n    ];\n\n    /**\n     * Flat picker custom date.\n     */\n    let flatpickr = null;\n\n    /**\n     * This function will show validation error in block card.\n     * @param {String} blockid Block id\n     * @param {Object} response User validation response\n     */\n    function validateUser(blockid, response) {\n        $(`#${blockid} .panel-body`).html(response.exception.message);\n    }\n\n    /**\n     * Show time duration in header.\n     * @param {String} date Time period.\n     */\n    function showTimeLabel(date) {\n        PROMISE.GET_TIMEPERIOD_LABEL(date).done(function(response) {\n            let startdate = new Date(response.startdate * 86400000);\n            let enddate = new Date(response.enddate * 86400000);\n            let startDay = startdate.getDate();\n            startDay = startDay < 10 ? '0' + startDay : startDay;\n            let endDay = enddate.getDate();\n            endDay = endDay < 10 ? '0' + endDay : endDay;\n\n            // $(SELECTOR.DATESELECTED).html(`\n            // ${startDay} ${startdate.toLocaleString('default', {\n            //     month: 'long'\n            // })} ${startdate.getFullYear()} -\n            // ${endDay} ${enddate.toLocaleString('default', {\n            //     month: 'long'\n            // })} ${enddate.getFullYear()}`);\n\n            let customdate = `${startDay} ${startdate.toLocaleString('default', { month: 'long' })} ${startdate.getFullYear()}` + ' - ' +\n            `${endDay} ${enddate.toLocaleString('default', { month: 'long' })} ${enddate.getFullYear()}`;\n            // RTL support\n            let dirattr = $('html').attr('dir');\n            // Formating date for rtl\n            if(dirattr == 'rtl'){\n                // format for rtl : yyyy mm dd\n                startdate = startdate.getFullYear() + ' ' + startdate.toLocaleString('default', { month: 'long' }) + ' ' + startDay;\n                enddate = enddate.getFullYear() + ' ' + enddate.toLocaleString('default', { month: 'long' }) + ' ' + endDay;\n                customdate = enddate + '-' + startdate;\n\n                // Making direction ltr for date selector and aligning text to right\n                $(SELECTOR.DATE).css({'direction':'ltr','text-align': 'right'});\n                $(SELECTOR.DATEPICKERINPUT).css({'direction':'ltr','text-align': 'right'});\n            }\n\n            $(SELECTOR.DATESELECTED).html(customdate);\n\n        }).fail(function(ex) {\n            Notification.exception(ex);\n        });\n    }\n\n    /**\n     * Throw an event with date change data.\n     * @param {String} date  Date\n     * @param {String} label Date label\n     */\n    function throwDateEvent(date, label) {\n        let dateChangeEvent = new CustomEvent('edwiserreport:datechange', {\n            detail: {\n                date: date\n            }\n        });\n        document.dispatchEvent(dateChangeEvent);\n        showTimeLabel(date, label);\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function customDateSelected() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // Date d M Y format.\n\n        // RTL support\n        let dirattr = $('html').attr('dir');\n        // Split string in 2 parts\n        let stringarr = dateAlternate.split('-');\n        // Formating date for rtl\n        if(dirattr == 'rtl'){\n            // format for rtl : yyyy mm dd\n            let startdate = stringarr[0].split(' ');\n            let enddate = stringarr[1].split(' ');\n\n            startdate = startdate[2] + ' ' + startdate[1] + ' ' + startdate[0];\n            enddate = enddate[3] + ' ' + enddate[2] + ' ' + enddate[1];\n            dateAlternate = enddate + '-' + startdate;\n\n            // Making direction ltr for date selector and aligning text to right\n            $(SELECTOR.DATE).css({'direction':'ltr','text-align': 'right'});\n            $(SELECTOR.DATEPICKERINPUT).css({'direction':'ltr','text-align': 'right'});\n        }\n\n\n        $(SELECTOR.DATEPICKERINPUT).next().val(dateAlternate);\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        // Throw date change event.\n        throwDateEvent(date, dateAlternate);\n    }\n\n    /**\n     * Init main.js\n     */\n    var init = function() {\n        $(document).ready(function() {\n\n            insights.init();\n\n            let currentDate = $(SELECTOR.DATEITEM + '.active').data('value');\n\n            // Show time period in header.\n            showTimeLabel(\n                currentDate,\n                $(SELECTOR.DATEITEM + '.active').text()\n            );\n\n            common.handleSearchInput();\n\n            // Forcefully applying first option to select dropdown element.\n            $('.singleselect').each(function(index, select) {\n                $(select).val($(select).find('option:nth-child(1)').val());\n            });\n\n            blocks.forEach(block => {\n                block.init(validateUser);\n            });\n\n            flatpickr = $(SELECTOR.DATEPICKERINPUT).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d M Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: $(SELECTOR.DATEPICKER).get(0),\n                onOpen: function() {\n                    $(SELECTOR.DATEMENU).addClass('withcalendar');\n                    $(SELECTOR.DATE).dropdown('update');\n                },\n                onClose: function() {\n                    $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                    customDateSelected();\n                }\n            });\n\n            /* Date selector listener */\n            $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n                // Set custom selected item as active.\n                $(SELECTOR.DATEITEM).removeClass('active');\n                $(this).addClass('active');\n\n                // Show selected item on dropdown button.\n                $(SELECTOR.DATE).html($(this).text());\n\n                // Clear custom date.\n                flatpickr.clear();\n\n                // Throw date change event.\n                throwDateEvent($(this).data('value'), $(this).text());\n            });\n        });\n    };\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});\n"],"file":"main.min.js"}