{"version":3,"sources":["block_timespentoncourse.js"],"names":["define","$","ApexCharts","common","CFG","SELECTOR","PANEL","INSIGHT","FORMFILTER","GRAPH","STUDENT","COURSE","PROMISE","GET_TIMESPENTONCOURSE","filter","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","JSON","stringify","date","course","student","chart","lineChartDefault","series","height","dropShadow","enabled","color","top","left","blur","opacity","toolbar","show","tools","download","reset","zoom","tooltip","enabledOnSeries","undefined","shared","followCursor","intersect","inverseOrder","fillSeriesColor","onDatasetHover","highlightDataSeries","y","formatter","title","items","display","fixed","position","offsetX","offsetY","stroke","curve","grid","borderColor","markers","size","xaxis","categories","labels","hideOverlappingLabels","datetimeFormatter","year","month","day","hour","legend","floating","dataLabels","colors","getColorPalette","noData","text","util","get_string","barChartDefault","selection","zoomin","zoomout","pan","marker","plotOptions","bar","columnWidth","trim","tickPlacement","loadGraph","invalidUser","loader","exportFilter","Object","keys","map","key","join","find","val","done","response","assign","name","timespent","yaxis","timeFormatter","length","insight","value","dataPointIndex","short","replaceAll","details","graph","destroy","get","render","setTimeout","hide","renderGraph","fail","exception","init","dateChange","on","concat","parseInt","this","flatpickr","DATEPICKERINPUT","mode","altInput","altFormat","dateFormat","maxDate","appendTo","DATEPICKER","onOpen","DATEMENU","addClass","onClose","removeClass","customDateSelected","select2"],"mappings":"AAAA,aA0BAA,OAAO,CAAC,SAAU,qBAAsB,WAAY,mBAAoB,SAAUC,EAAGC,EAAYC,EAAQC,GAIvG,IAAIC,EAAW,CACbC,MAAO,0BACPC,QAAS,mCACTC,WAAY,kCACZC,MAAO,sCACPC,QAAS,oCACTC,OAAQ,oCAENC,EAAU,CAMZC,sBAAuB,SAA+BC,GACpD,OAAOb,EAAEc,KAAK,CACZC,IAAKZ,EAAIa,WACTC,KAAMd,EAAIe,YACVC,SAAUhB,EAAIiB,gBACdC,KAAM,CACJC,OAAQ,wCACRC,OAAQC,EAAEC,qBAAqBF,OAC/BF,KAAMK,KAAKC,UAAU,CACnBd,OAAQA,SAUdA,EAAS,CACXe,KAAM,SACNC,OAAQ,EACRC,QAAS,GAMPC,EAAQ,KAKRC,EAAmB,CACrBC,OAAQ,GACRF,MAAO,CACLd,KAAM,OACNiB,OAAQ,IACRC,WAAY,CACVC,SAAS,EACTC,MAAO,OACPC,IAAK,GACLC,KAAM,EACNC,KAAM,GACNC,QAAS,IAEXC,QAAS,CACPC,MAAM,EACNC,MAAO,CACLC,UAAU,EACVC,MAAO,kCAGXC,KAAM,CACJX,SAAS,IAGbY,QAAS,CACPZ,SAAS,EACTa,qBAAiBC,EACjBC,QAAQ,EACRC,cAAc,EACdC,WAAW,EACXC,cAAc,EACdC,iBAAiB,EACjBC,eAAgB,CACdC,qBAAqB,GAEvBC,EAAG,CACDC,eAAWT,EACXU,MAAO,IAETC,MAAO,CACLC,QAAS,QAEXC,MAAO,CACL3B,SAAS,EACT4B,SAAU,WACVC,QAAS,EACTC,QAAS,IAGbC,OAAQ,CACNC,MAAO,UAETC,KAAM,CACJC,YAAa,WAEfC,QAAS,CACPC,KAAM,GAERC,MAAO,CACLC,WAAY,KACZzD,KAAM,WACN0D,OAAQ,CACNC,uBAAuB,EACvBC,kBAAmB,CACjBC,KAAM,OACNC,MAAO,UACPC,IAAK,SACLC,KAAM,KAGVjC,QAAS,CACPZ,SAAS,IAGb8C,OAAQ,CACNlB,SAAU,MACVmB,UAAU,GAEZC,WAAY,CACVhD,SAAS,GAEXiD,OAAQ,CAAClF,EAAImF,kBAAkB,IAC/BC,OAAQ,CACNC,KAAMhE,EAAEiE,KAAKC,WAAW,cAAe,0BAOvCC,EAAkB,CACpB1D,OAAQ,GACRF,MAAO,CACLd,KAAM,MACNiB,OAAQ,IACRQ,QAAS,CACPC,MAAM,EACNC,MAAO,CACLC,UAAU,EACV+C,WAAW,EACX7C,MAAM,EACN8C,QAAQ,EACRC,SAAS,EACTC,KAAK,EACLjD,MAAO,mCAIbE,QAAS,CACPZ,SAAS,EACTa,qBAAiBC,EACjBC,QAAQ,EACRC,cAAc,EACdC,WAAW,EACXC,cAAc,EACdC,iBAAiB,EACjBC,eAAgB,CACdC,qBAAqB,GAEvBC,EAAG,CACDC,eAAWT,EACXU,MAAO,IAEToC,OAAQ,CACNrD,MAAM,GAERkB,MAAO,CACLC,QAAS,QAEXC,MAAO,CACL3B,SAAS,EACT4B,SAAU,WACVC,QAAS,EACTC,QAAS,IAGb+B,YAAa,CACXC,IAAK,CACHC,YAAa,QAGjB9B,KAAM,CACJC,YAAa,WAEfc,WAAY,CACVhD,SAAS,GAEXqC,MAAO,CACLC,WAAY,KACZC,OAAQ,CACNC,uBAAuB,EACvBwB,MAAM,GAERC,cAAe,MAEjBhB,OAAQ,CAAClF,EAAImF,kBAAkB,IAC/BC,OAAQ,CACNC,KAAMhE,EAAEiE,KAAKC,WAAW,cAAe,0BAO3C,SAASY,EAAUC,GACjBrG,EAAOsG,OAAO7D,KAAKvC,EAASC,OAE5B,IAAIoG,EAAeC,OAAOC,KAAK9F,GAAQ+F,IAAI,SAAUC,GACnD,OAAOhG,EAAOgG,KACbC,KAAK,KACR9G,EAAEI,EAASC,OAAO0G,KAAK3G,EAASG,YAAYyG,IAAIP,GAmBhD9F,EAAQC,sBAAsBC,GAAQoG,KAAK,SAAUC,GACnD,IAAI7F,GAGFA,EADmB,GAAjBR,EAAOgB,OACF6E,OAAOS,OAAO,GAAIxB,GAElBe,OAAOS,OAAO,GAAInF,IAGtBC,OAAS,CAAC,CACbmF,KAAM5F,EAAEiE,KAAKC,WAAW,oBAAqB,wBAC7CrE,KAAM6F,EAASG,YAEjBhG,EAAKoD,MAAMC,WAAawC,EAASvC,OACjCtD,EAAKiG,MAAQ,CACX3C,OAAQ,CACNhB,UAAWzD,EAAOqH,gBAGtBlG,EAAKU,MAAMW,QAAQC,KAAOuE,EAASvC,OAAO6C,OAAS,GACnDnG,EAAKU,MAAMgB,KAAO,CAChBX,QAAS8E,EAASvC,OAAO6C,OAAS,IAGpCnG,EAAK2B,QAAQU,EAAEE,MAAMD,UAAY,WAC/B,OAAOnC,EAAEiE,KAAKC,WAAW,OAAQ,wBAA0B,MAG7DwB,EAASO,QAAQA,QAAQC,MAAQxH,EAAOqH,cAAcL,EAASO,QAAQA,QAAQC,MAAO,CACpFC,eAAgB,EAChBC,OAAS,IACRC,WAAW,IAAK,QACnBX,EAASO,QAAQK,QAAQzG,KAAK,GAAGqG,MAAQxH,EAAOqH,cAAcL,EAASO,QAAQK,QAAQzG,KAAK,GAAGqG,MAAO,CACpGC,eAAgB,IAElBzH,EAAOuH,QAAQrH,EAASE,QAAS4G,EAASO,SA/C5C,SAAqBM,EAAO1G,GACZ,OAAVU,GACFA,EAAMiG,WAGRjG,EAAQ,IAAI9B,EAAW8H,EAAME,IAAI,GAAI5G,IAC/B6G,SACNC,WAAW,WACTjI,EAAOsG,OAAO4B,KAAKhI,EAASC,QAC3B,KAuCHgI,CAAYrI,EAAEI,EAASC,OAAO0G,KAAK3G,EAASI,OAAQa,KACnDiH,KAAK,SAAUC,GAChBrI,EAAOsG,OAAO4B,KAAKhI,EAASC,SA2DhC,MAAO,CACLmI,KA3BF,SAAcjC,GACPvG,EAAEI,EAASC,OAAOmH,SAIvBlB,IA5BApG,EAAOuI,WAAW,SAAU7G,GAC1Bf,EAAOe,KAAOA,EACd0E,MAGFtG,EAAE,QAAQ0I,GAAG,SAAU,GAAGC,OAAOvI,EAASC,MAAO,KAAKsI,OAAOvI,EAASK,SAAU,WAC9EI,EAAOiB,QAAU8G,SAAS5I,EAAE6I,MAAM7B,OAElCV,MAGFtG,EAAE,QAAQ0I,GAAG,SAAU,GAAGC,OAAOvI,EAASC,MAAO,KAAKsI,OAAOvI,EAASM,QAAS,WAC7EG,EAAOgB,OAAS+G,SAAS5I,EAAE6I,MAAM7B,OAEjCV,MAgBFwC,UAAY9I,EAAEI,EAASC,OAAO0G,KAAK3G,EAAS2I,iBAAiBD,UAAU,CACrEE,KAAM,QACNC,UAAU,EACVC,UAAW,QACXC,WAAY,QACZC,QAAS,QACTC,SAAUrJ,EAAEI,EAASC,OAAO0G,KAAK3G,EAASkJ,YAAYrB,IAAI,GAC1DsB,OAAQ,WACNvJ,EAAEI,EAASC,OAAO0G,KAAK3G,EAASoJ,UAAUC,SAAS,iBAErDC,QAAS,WACP1J,EAAEI,EAASC,OAAO0G,KAAK3G,EAASoJ,UAAUG,YAAY,gBACtDC,wBAGJ5J,EAAEI,EAASC,OAAO0G,KAAK,iBAAiB8C","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Block service call and rendering defined in this file.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine([\n    'jquery',\n    './chart/apexcharts',\n    './common',\n    './defaultconfig'\n], function(\n    $,\n    ApexCharts,\n    common,\n    CFG\n) {\n\n    /**\n     * DOM element selectors list.\n     */\n    let SELECTOR = {\n        PANEL: '#timespentoncourseblock',\n        INSIGHT: '#timespentoncourseblock .insight',\n        FORMFILTER: '.download-links [name=\"filter\"]',\n        GRAPH: '#apex-chart-timespentoncourse-block',\n        STUDENT: '#timespentoncourse-student-select',\n        COURSE: '#timespentoncourse-course-select'\n    };\n\n    let PROMISE = {\n        /**\n         * Get timespent on site using filters.\n         * @param {Object} filter Filter data\n         * @returns {PROMISE}\n         */\n        GET_TIMESPENTONCOURSE: function(filter) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_timespentoncourse_graph_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    data: JSON.stringify({\n                        filter: filter\n                    })\n                },\n            });\n        }\n    };\n\n    /**\n     * Filter for ajax.\n     */\n    let filter = {\n        date: 'weekly',\n        course: 0,\n        student: 0\n    };\n\n    /**\n     * Chart object.\n     */\n    let chart = null;\n\n    /**\n     * Line chart default config.\n     */\n    const lineChartDefault = {\n        series: [],\n        chart: {\n            type: 'area',\n            height: 350,\n            dropShadow: {\n                enabled: true,\n                color: '#000',\n                top: 18,\n                left: 7,\n                blur: 10,\n                opacity: 0.2\n            },\n            toolbar: {\n                show: false,\n                tools: {\n                    download: false,\n                    reset: '<i class=\"fa fa-refresh\"></i>'\n                }\n            },\n            zoom: {\n                enabled: false\n            }\n        },\n        tooltip: {\n            enabled: true,\n            enabledOnSeries: undefined,\n            shared: true,\n            followCursor: false,\n            intersect: false,\n            inverseOrder: false,\n            fillSeriesColor: false,\n            onDatasetHover: {\n                highlightDataSeries: false,\n            },\n            y: {\n                formatter: undefined,\n                title: {},\n            },\n            items: {\n                display: 'flex'\n            },\n            fixed: {\n                enabled: false,\n                position: 'topRight',\n                offsetX: 0,\n                offsetY: 0,\n            },\n        },\n        stroke: {\n            curve: 'smooth'\n        },\n        grid: {\n            borderColor: '#e7e7e7'\n        },\n        markers: {\n            size: 1\n        },\n        xaxis: {\n            categories: null,\n            type: 'datetime',\n            labels: {\n                hideOverlappingLabels: true,\n                datetimeFormatter: {\n                    year: 'yyyy',\n                    month: 'MMM \\'yy',\n                    day: 'dd MMM',\n                    hour: ''\n                }\n            },\n            tooltip: {\n                enabled: false\n            }\n        },\n        legend: {\n            position: 'top',\n            floating: true\n        },\n        dataLabels: {\n            enabled: false\n        },\n        colors: [CFG.getColorPalette()[2]],\n        noData: {\n            text: M.util.get_string('nographdata', 'local_edwiserreports')\n        }\n    };\n\n    /**\n     * Bar chart default config.\n     */\n    const barChartDefault = {\n        series: [],\n        chart: {\n            type: 'bar',\n            height: 350,\n            toolbar: {\n                show: true,\n                tools: {\n                    download: false,\n                    selection: true,\n                    zoom: true,\n                    zoomin: true,\n                    zoomout: true,\n                    pan: true,\n                    reset: '<i class=\"fa fa-refresh\"></i>'\n                }\n            },\n        },\n        tooltip: {\n            enabled: true,\n            enabledOnSeries: undefined,\n            shared: true,\n            followCursor: false,\n            intersect: false,\n            inverseOrder: false,\n            fillSeriesColor: false,\n            onDatasetHover: {\n                highlightDataSeries: false,\n            },\n            y: {\n                formatter: undefined,\n                title: {},\n            },\n            marker: {\n                show: true\n            },\n            items: {\n                display: 'flex'\n            },\n            fixed: {\n                enabled: false,\n                position: 'topRight',\n                offsetX: 0,\n                offsetY: 0,\n            },\n        },\n        plotOptions: {\n            bar: {\n                columnWidth: '50%'\n            }\n        },\n        grid: {\n            borderColor: '#e7e7e7'\n        },\n        dataLabels: {\n            enabled: false\n        },\n        xaxis: {\n            categories: null,\n            labels: {\n                hideOverlappingLabels: true,\n                trim: true\n            },\n            tickPlacement: 'on'\n        },\n        colors: [CFG.getColorPalette()[2]],\n        noData: {\n            text: M.util.get_string('nographdata', 'local_edwiserreports')\n        }\n    };\n\n    /**\n     * Load graph\n     */\n    function loadGraph(invalidUser) {\n        common.loader.show(SELECTOR.PANEL);\n\n        // Set export filter to download link.\n        let exportFilter = Object.keys(filter).map(key => filter[key]).join(\"-\");\n        $(SELECTOR.PANEL).find(SELECTOR.FORMFILTER).val(exportFilter);\n\n        /**\n         * Render graph.\n         * @param {DOM} graph Graph element\n         * @param {Object} data Graph data\n         */\n        function renderGraph(graph, data) {\n            if (chart !== null) {\n                chart.destroy();\n            }\n            chart = new ApexCharts(graph.get(0), data);\n            chart.render();\n            setTimeout(function() {\n                common.loader.hide(SELECTOR.PANEL);\n            }, 1000);\n        }\n\n        PROMISE.GET_TIMESPENTONCOURSE(filter)\n            .done(function(response) {\n                let data;\n                if (filter.course == 0) {\n                    data = Object.assign({}, barChartDefault);\n                } else {\n                    data = Object.assign({}, lineChartDefault);\n                }\n                data.series = [{\n                    name: M.util.get_string('timespentoncourse', 'local_edwiserreports'),\n                    data: response.timespent,\n                }];\n                data.xaxis.categories = response.labels;\n                data.yaxis = {\n                    labels: {\n                        formatter: common.timeFormatter\n                    }\n                };\n                data.chart.toolbar.show = response.labels.length > 30;\n                data.chart.zoom = {\n                    enabled: response.labels.length > 30\n                };\n                data.tooltip.y.title.formatter = () => {\n                    return M.util.get_string('time', 'local_edwiserreports') + ': ';\n                }\n                response.insight.insight.value = common.timeFormatter(response.insight.insight.value, {\n                    dataPointIndex: 0,\n                    short: true\n                }).replaceAll(',', '<br>');\n                response.insight.details.data[0].value = common.timeFormatter(response.insight.details.data[0].value, {\n                    dataPointIndex: 0\n                });\n                common.insight(SELECTOR.INSIGHT, response.insight);\n                renderGraph($(SELECTOR.PANEL).find(SELECTOR.GRAPH), data);\n            }).fail(function(exception) {\n                common.loader.hide(SELECTOR.PANEL);\n            });\n    }\n\n    /**\n     * Initialize events.\n     */\n    function initEvents() {\n        // Date selector listener.\n        common.dateChange(function(date) {\n            filter.date = date;\n            loadGraph();\n        });\n\n        // Student selector listener.\n        $('body').on('change', `${SELECTOR.PANEL} ${SELECTOR.STUDENT}`, function() {\n            filter.student = parseInt($(this).val());\n\n            // Load graph data.\n            loadGraph();\n        });\n\n        // Course selector listener.\n        $('body').on('change', `${SELECTOR.PANEL} ${SELECTOR.COURSE}`, function() {\n            filter.course = parseInt($(this).val());\n\n            // Load graph data.\n            loadGraph();\n        });\n    }\n\n    /**\n     * Initialize\n     * @param {function} invalidUser Callback function\n     */\n    function init(invalidUser) {\n\n        if (!$(SELECTOR.PANEL).length) {\n            return;\n        }\n\n        loadGraph(invalidUser);\n\n        initEvents();\n\n        flatpickr = $(SELECTOR.PANEL).find(SELECTOR.DATEPICKERINPUT).flatpickr({\n            mode: 'range',\n            altInput: true,\n            altFormat: \"d/m/Y\",\n            dateFormat: \"Y-m-d\",\n            maxDate: \"today\",\n            appendTo: $(SELECTOR.PANEL).find(SELECTOR.DATEPICKER).get(0),\n            onOpen: function() {\n                $(SELECTOR.PANEL).find(SELECTOR.DATEMENU).addClass('withcalendar');\n            },\n            onClose: function() {\n                $(SELECTOR.PANEL).find(SELECTOR.DATEMENU).removeClass('withcalendar');\n                customDateSelected();\n            }\n        });\n\n        $(SELECTOR.PANEL).find('.singleselect').select2();\n    }\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});"],"file":"block_timespentoncourse.min.js"}