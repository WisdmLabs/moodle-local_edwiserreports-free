/**
 * Plugin administration pages are defined here.
 *
 * @copyright   2021 wisdmlabs <support@wisdmlabs.com>
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/ define(["jquery","core/ajax","core/modal_factory","core/modal_events","core/templates","core/notification","core/str","./common","./jquery.dataTables","./dataTables.bootstrap4"],function(e,t,r,o,s,a,l,i){"use strict";var n=".field .custom-field-checkbox",d="#wdm-custom-reports-save",c=null,p=null,m=M.util.get_string("savecustomreport","local_edwiserreports"),u=[],h=[],f=[],g=0,w=!0,b={downloadenable:!0},v={selector:".reports-preview-body .reports-preview-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},y={selector:".reports-preview-body .reports-preview-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),v.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),v.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),v.hide()}},C={selector:".reports-list-body .reports-list-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},$={selector:".reports-list-body .reports-list-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),C.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),C.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),C.hide()}};function x(){w&&(w=!1,u=[],f=e("#wdm-cohort-select").val(),h=e("#wdm-course-select").val(),e(n+":checked").each(function(){u.push(e(this).val())}),0==u.length&&(e(d).prop("disabled",!0),w=!0),i.loader.show("#wdm-customreports-edit"),t.call([{methodname:"local_edwiserreports_get_customreports_data",args:{params:JSON.stringify({fields:u,cohorts:f,courses:h})}}])[0].done(function(t){if(t.success){var r=JSON.parse(t.data);0==r.reportsdata.length?(y.empty(),e(d).prop("disabled",!0)):(c&&(c.clear().destroy(),e("#cr-preview-table").html("")),y.show(),c=e("#cr-preview-table").DataTable({columns:r.columns,dom:'<"edwiserreports-table"<"table-filter d-flex"f><t><"table-pagination"p>>',data:r.reportsdata,language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nodata","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:" ",next:" "}},bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e("#cr-preview-table").find("th").addClass("theme-3-bg text-white"),i.stylePaginationButton(this)}}),e(d).prop("disabled",!1)),setTimeout(function(){e(".edwiserreports-table .page-item.next a").empty(),e(".edwiserreports-table .page-item.previous a").empty();var t=e("html").attr("dir");void 0!==t&&!1!==t&&"rtl"==t&&(e(".edwiserreports-table .page-item.next a:before").css({"border-left":"11px solid transparent","border-bottom":"6px solid transparent","border-top":"6px solid transparent","border-left-color":"#ccc","border-right-width":"0px"}),e(".edwiserreports-table .page-item.previous a:before").css({"border-bottom":"6px solid transparent","border-top":"6px solid transparent","border-right":" 10px solid transparent","border-right-color":"#ccc","border-left-width":"0px"}))},1e3)}}).always(function(){w=!0,i.loader.hide("#wdm-customreports-edit")}))}function k(r,o){t.call([{methodname:"local_edwiserreports_save_customreports_data",args:{params:JSON.stringify(r)}}])[0].done(function(t){t.success?(o&&(b=JSON.parse(t.reportsdata),e(".reports-preview-header .rp-header").html(b.reportname),e(d).html(M.util.get_string("updatereports","local_edwiserreports"))),e("#user-notifications .close").click(),a.addNotification({message:M.util.get_string("reportssavesuccess","local_edwiserreports"),type:"success"})):(e("#user-notifications .close").click(),a.addNotification({message:t.errormsg,type:"error"})),o&&(e("html, body").animate({scrollTop:0},"slow"),_(),o.hide())})}function _(){t.call([{methodname:"local_edwiserreports_get_customreports_list",args:{params:JSON.stringify({})}}])[0].done(function(t){var r=JSON.parse(t.data);t.success&&(0==r.length?$.empty():(p&&p.clear().destroy(),p=e("#cr-list-table").DataTable({columns:[{data:"fullname",title:M.util.get_string("title","local_edwiserreports")},{data:"createdby",title:M.util.get_string("createdby","local_edwiserreports")},{data:"datecreated",title:M.util.get_string("datecreated","local_edwiserreports")},{data:"datemodified",title:M.util.get_string("datemodified","local_edwiserreports")},{data:"managehtml",title:M.util.get_string("manage","local_edwiserreports"),orderable:!1}],dom:'<"edwiserreports-table"<t><"table-pagination"p>>',language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("nodata","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),paginate:{previous:" ",next:" "}},order:[[0,"asc"]],data:r,bInfo:!1,lengthChange:!1,drawCallback:function(){e("#cr-list-table").find("th").addClass("theme-3-bg text-white"),i.stylePaginationButton(this)}}),$.show()))})}return{init:function(){e(document).ready(function(){e(document).on("click",".field-group",function(){var t=this.id;e(this).toggleClass("open"),e("[aria-control='"+t+"']").toggleClass("show")}),e(document).on("click",function(t){let r=e(t.target).closest(".field-group-wrap");if(0===r.length){e(".field-group-wrap .field-group").removeClass("open"),e(".field-group-wrap .field").removeClass("show");return}let o="user"===r.data("key")?"course":"user";e(`.field-group-wrap[data-key='${o}'] .field-group`).removeClass("open"),e(`.field-group-wrap[data-key='${o}'] .field`).removeClass("show")}),e(n).on("change",function(){x()}),e(".reports-filter-body .custom-field-select").on("change",function(){x()}),e(d).on("click",function(){r.create({title:m,type:r.types.SAVE_CANCEL,body:s.render("local_edwiserreports/custom_reports_save_form",b)}).done(function(t){var r=t.getRoot();r.find(".modal-dialog").addClass("modal-lg"),t.getFooter().find('[data-action="save"]').removeClass("btn-primary").addClass("theme-primary-bg text-white"),t.show(),r.on(o.hidden,function(){t.destroy()}),r.on(o.save,function(o){o.preventDefault(),r.find("input").on("input",function(){e('[id^="id_error_crb"]').html("")});var s,a,l=e("#wdm-customreports-save-form").serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});a=!0,""==(s=l).reportname&&(e("#id_error_crb_reportname").html(M.util.get_string("emptyfullname","local_edwiserreports")).show(),a=!1),""==s.reportshortname&&(e("#id_error_crb_reportshortname").html(M.util.get_string("emptyshortname","local_edwiserreports")).show(),a=!1),/[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/.test(s.reportshortname)&&(e("#id_error_crb_reportshortname").html(M.util.get_string("nospecialchar","local_edwiserreports")).show(),a=!1),a&&(l.querydata={selectedfield:u,cohorts:f,courses:h},k(l,t))})})}),_(),e(document).on("change",'[id^="wdm-desktopenable-"]',function(){var t=!1;e(this).is(":checked")&&(t=!0),k({reportsid:e(this).data("reportsid"),enabledesktop:t,action:"enabledesktop"},!1)}),e(document).on("click",'#cr-list-table a[data-action="delete"]',function(r){r.preventDefault();var o=e(this).data("reportsid");l.get_strings([{key:"deletecustomreportstitle",component:"local_edwiserreports"},{key:"deletecustomreportsquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(s){a.confirm(s[0],s[1],s[2],s[3],e.proxy(function(){!function r(o){t.call([{methodname:"local_edwiserreports_delete_custom_report",args:{params:JSON.stringify({reportsid:o})}}])[0].done(function(e){e.success?a.addNotification({message:e.message,type:"success"}):a.addNotification({message:e.message,type:"error"})}).always(function(){e("html, body").animate({scrollTop:0},"slow"),_()})}(o)},r.currentTarget))})}),e(document).on("click",'#cr-list-table a[data-action="hide"]',function(t){t.preventDefault();var r=e(this).data("target");e(this).data("value")?(e(this).attr("title",e(this).data("titlehide")),e(this).attr("data-original-title",e(this).data("titlehide")),e(this).data("value",0),e(this).attr("data-value",0)):(e(this).attr("title",e(this).data("titleshow")),e(this).attr("data-original-title",e(this).data("titleshow")),e(this).data("value",1),e(this).attr("data-value",1)),e(this).find(".icon").toggleClass("fa-eye"),e(this).find(".icon").toggleClass("fa-eye-slash"),e(r).trigger("click")}),e("body").on("input",".customreports-block-section .table-search-input input",function(){p.column(0).search(this.value).draw()}),i.handleSearchInput(),0!==(g=e("#wdm_custom_reports_id").val())&&(b.reportsid=g,b.reportname=e("#wdm_custom_reports_fullname").val(),b.reportshortname=e("#wdm_custom_reports_shortname").val(),0!=e("#wdm_custom_reports_downloadenable").val()?b.downloadenable=!0:b.downloadenable=!1,0!=e("#wdm_custom_reports_desktopenable").val()?b.enabledesktop=!0:b.enabledesktop=!1,x())})}}});
