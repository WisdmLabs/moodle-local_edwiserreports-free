"use strict";define(["jquery","core/ajax","core/modal_factory","core/modal_events","core/templates","core/notification","core/str","./variables","./common","./jquery.dataTables","./dataTables.bootstrap4"],function(e,t,o,s,r,a,l,i,n){var d=".field .custom-field-checkbox",c=".reports-filter-body .custom-field-select",p="#wdm-cohort-select",m="#wdm-course-select",u="#wdm-custom-reports-save",h="#wdm-customreports-save-form",f='[id^="wdm-desktopenable-"]',g='#cr-list-table a[data-action="delete"]',w='#cr-list-table a[data-action="hide"]',_=".reports-preview-header .rp-header",v=null,y=null,b=M.util.get_string("savecustomreport","local_edwiserreports"),C=[],k=[],x=[],N=0,S=!0,T={downloadenable:!0},J={selector:".reports-preview-body .reports-preview-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},O={selector:".reports-preview-body .reports-preview-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),J.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),J.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),J.hide()}},D={selector:".reports-list-body .reports-list-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},q={selector:".reports-list-body .reports-list-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),D.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),D.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),D.hide()}};function j(){S&&(S=!1,C=[],x=e(p).val(),k=e(m).val(),e(d+":checked").each(function(){C.push(e(this).val())}),0==C.length?(e(u).prop("disabled",!0),S=!0):(n.loader.show("#wdm-customreports-edit"),t.call([{methodname:"local_edwiserreports_get_customreports_data",args:{params:JSON.stringify({fields:C,cohorts:x,courses:k})}}])[0].done(function(t){if(t.success){var o=JSON.parse(t.data);0==o.reportsdata.length?(O.empty(),e(u).prop("disabled",!0)):(v&&(v.clear().destroy(),e("#cr-preview-table").html("")),O.show(),v=e("#cr-preview-table").DataTable({columns:o.columns,dom:'<"edwiserreports-table"<"table-filter d-flex"f><t><"table-pagination"p>>',data:o.reportsdata,bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e("#cr-preview-table").find("th").addClass("theme-3-bg text-white"),n.stylePaginationButton(this)}}),e(u).prop("disabled",!1))}}).always(function(){S=!0,n.loader.hide("#wdm-customreports-edit")})))}function A(){o.create({title:b,type:o.types.SAVE_CANCEL,body:r.render("local_edwiserreports/custom_reports_save_form",T)}).done(function(t){var o=t.getRoot();o.find(".modal-dialog").addClass("modal-lg"),t.getFooter().find('[data-action="save"]').removeClass("btn-primary").addClass("theme-primary-bg text-white"),t.show(),o.on(s.hidden,function(){t.destroy()}),o.on(s.save,function(s){s.preventDefault(),o.find("input").on("input",function(){e('[id^="id_error_crb"]').html("")});var r=e(h).serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});(function(t){var o=!0;return""==t.reportname&&(e("#id_error_crb_reportname").html(M.util.get_string("emptyfullname","local_edwiserreports")).show(),o=!1),""==t.reportshortname&&(e("#id_error_crb_reportshortname").html(M.util.get_string("emptyshortname","local_edwiserreports")).show(),o=!1),/[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/.test(t.reportshortname)&&(e("#id_error_crb_reportshortname").html(M.util.get_string("nospecialchar","local_edwiserreports")).show(),o=!1),o})(r)&&(r.querydata={selectedfield:C,cohorts:x,courses:k},I(r,t))})})}function I(o,s){t.call([{methodname:"local_edwiserreports_save_customreports_data",args:{params:JSON.stringify(o)}}])[0].done(function(t){t.success?(s&&(T=JSON.parse(t.reportsdata),e(_).html(T.reportname),e(u).html(M.util.get_string("updatereports","local_edwiserreports"))),e("#user-notifications .close").click(),a.addNotification({message:M.util.get_string("reportssavesuccess","local_edwiserreports"),type:"success"})):(e("#user-notifications .close").click(),a.addNotification({message:t.errormsg,type:"error"})),s&&(e("html, body").animate({scrollTop:0},"slow"),P(),s.hide())})}function P(){t.call([{methodname:"local_edwiserreports_get_customreports_list",args:{params:JSON.stringify({})}}])[0].done(function(t){var o=JSON.parse(t.data);t.success&&(0==o.length?q.empty():(y&&y.clear().destroy(),y=e("#cr-list-table").DataTable({columns:[{data:"fullname",title:M.util.get_string("title","local_edwiserreports")},{data:"createdby",title:M.util.get_string("createdby","local_edwiserreports")},{data:"datecreated",title:M.util.get_string("datecreated","local_edwiserreports")},{data:"datemodified",title:M.util.get_string("datemodified","local_edwiserreports")},{data:"managehtml",title:M.util.get_string("manage","local_edwiserreports"),orderable:!1}],dom:'<"edwiserreports-table"<t><"table-pagination"p>>',language:{searchPlaceholder:M.util.get_string("searchreports","local_edwiserreports"),emptyTable:M.util.get_string("noresult","local_edwiserreports")},order:[[0,"asc"]],data:o,bInfo:!1,lengthChange:!1,drawCallback:function(){e("#cr-list-table").find("th").addClass("theme-3-bg text-white"),n.stylePaginationButton(this)}}),q.show()))})}function B(){e(d).on("change",function(){j()}),e(c).on("change",function(){j()}),e(u).on("click",function(){A()}),P(),e(document).on("change",f,function(){var t=!1;e(this).is(":checked")&&(t=!0),I({reportsid:e(this).data("reportsid"),enabledesktop:t,action:"enabledesktop"},!1)}),e(document).on("click",g,function(o){o.preventDefault();var s=e(this).data("reportsid");l.get_strings([{key:"deletecustomreportstitle",component:"local_edwiserreports"},{key:"deletecustomreportsquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(r){a.confirm(r[0],r[1],r[2],r[3],e.proxy(function(){var o;o=s,t.call([{methodname:"local_edwiserreports_delete_custom_report",args:{params:JSON.stringify({reportsid:o})}}])[0].done(function(e){e.success?a.addNotification({message:e.message,type:"success"}):a.addNotification({message:e.message,type:"error"})}).always(function(){e("html, body").animate({scrollTop:0},"slow"),P()})},o.currentTarget))})}),e(document).on("click",w,function(t){t.preventDefault();var o=e(this).data("target");e(this).data("value")?(e(this).attr("title",e(this).data("titlehide")),e(this).attr("data-original-title",e(this).data("titlehide")),e(this).data("value",0),e(this).attr("data-value",0)):(e(this).attr("title",e(this).data("titleshow")),e(this).attr("data-original-title",e(this).data("titleshow")),e(this).data("value",1),e(this).attr("data-value",1)),e(this).find(".icon").toggleClass("fa-eye"),e(this).find(".icon").toggleClass("fa-eye-slash"),e(o).trigger("click")}),e("body").on("input",".customreports-block-section .table-search-input input",function(){y.column(0).search(this.value).draw()}),n.handleSearchInput()}return{init:function(){e(document).ready(function(){e(document).on("click",".field-group",function(){var t=this.id;e(this).toggleClass("open"),e("[aria-control='"+t+"']").toggleClass("show")}),e(document).on("click",function(t){var o=e(t.target).closest(".field-group-wrap");if(0===o.length)return e(".field-group-wrap .field-group").removeClass("open"),void e(".field-group-wrap .field").removeClass("show");var s="user"===o.data("key")?"course":"user";e(".field-group-wrap[data-key='".concat(s,"'] .field-group")).removeClass("open"),e(".field-group-wrap[data-key='".concat(s,"'] .field")).removeClass("show")}),B(),0!==(N=e("#wdm_custom_reports_id").val())&&(T.reportsid=N,T.reportname=e("#wdm_custom_reports_fullname").val(),T.reportshortname=e("#wdm_custom_reports_shortname").val(),0!=e("#wdm_custom_reports_downloadenable").val()?T.downloadenable=!0:T.downloadenable=!1,0!=e("#wdm_custom_reports_desktopenable").val()?T.enabledesktop=!0:T.enabledesktop=!1,j())})}}});
//# sourceMappingURL=customreportsblock.min.js.map
