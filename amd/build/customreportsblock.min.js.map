{"version":3,"sources":["customreportsblock.js"],"names":["define","$","ajax","modalFactory","modalEvents","templates","notif","str","V","common","cfCheckbox","cfSelect","cfCohort","cfCourse","cfSave","cfSaveForm","crDesktopEnableSwitch","crDeleteBtn","crHideBtn","cpHeader","cfPreviewTable","crListTable","customReportSaveTitle","M","util","get_string","selectedFields","courses","cohorts","reportsId","reportsDataLoaded","reportsData","downloadenable","cfPreviewLoader","selector","show","this","removeClass","addClass","hide","cfPreview","empty","crListLoader","crList","getCustomReportsData","val","each","push","length","prop","loader","call","methodname","args","params","JSON","stringify","fields","done","response","success","data","parse","reportsdata","clear","destroy","html","DataTable","columns","dom","bInfo","bFilter","searching","lengthChange","drawCallback","find","stylePaginationButton","always","saveCustomReportsData","create","title","type","types","SAVE_CANCEL","body","render","modal","root","getRoot","getFooter","on","hidden","save","e","preventDefault","serializeArray","reduce","obj","item","name","value","ret","reportname","reportshortname","test","validateCustomReprtsSaveData","querydata","selectedfield","saveCustomReportsDataService","click","addNotification","message","errormsg","animate","scrollTop","getCustomReportsList","orderable","language","searchPlaceholder","emptyTable","order","customReportServiceInit","document","enabledesktop","is","reportsid","action","reportId","get_strings","key","component","s","confirm","proxy","currentTarget","checkboxId","attr","toggleClass","trigger","column","search","draw","handleSearchInput","init","ready","id","wrap","target","closest","current","concat"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'core/notification',\n    'core/str',\n    './variables',\n    './common',\n    './jquery.dataTables',\n    './dataTables.bootstrap4'\n], function(\n    $,\n    ajax,\n    modalFactory,\n    modalEvents,\n    templates,\n    notif,\n    str,\n    V,\n    common\n) {\n    'use strict';\n\n    // Field group checkbox\n    var cfCheckbox = '.field .custom-field-checkbox';\n    var cfSelect = '.reports-filter-body .custom-field-select';\n    var cfCohort = '#wdm-cohort-select';\n    var cfCourse = '#wdm-course-select';\n    var cfSave = '#wdm-custom-reports-save';\n    var cfSaveForm = '#wdm-customreports-save-form';\n    var crPageId = '#wdm_custom_reports_id';\n    var crPageFullname = '#wdm_custom_reports_fullname';\n    var crPageShortname = '#wdm_custom_reports_shortname';\n    var crPageDownloadEnable = '#wdm_custom_reports_downloadenable';\n    var crPageDesktopEnable = '#wdm_custom_reports_desktopenable';\n    var crDesktopEnableSwitch = '[id^=\"wdm-desktopenable-\"]';\n    var crDeleteBtn = '#cr-list-table a[data-action=\"delete\"]';\n    var crHideBtn = '#cr-list-table a[data-action=\"hide\"]';\n    var cpHeader = '.reports-preview-header .rp-header';\n    var cfPreviewTable = null;\n    var crListTable = null;\n    var customReportSaveTitle = M.util.get_string('savecustomreport', 'local_edwiserreports');\n\n    var selectedFields = [];\n    var courses = [];\n    var cohorts = [];\n    var reportsId = 0;\n    var reportsDataLoaded = true;\n    var reportsData = {\n        downloadenable: true\n    };\n\n    var cfPreviewLoader = {\n        selector: '.reports-preview-body .reports-preview-content.loader',\n\n        show: function() {\n            $(this.selector).removeClass('d-none').addClass('d-flex');\n        },\n\n        hide: function() {\n            $(this.selector).removeClass('d-flex').addClass('d-none');\n        }\n    };\n\n    var cfPreview = {\n        selector: '.reports-preview-body .reports-preview-content',\n\n        show: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-none').addClass('d-flex');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.hide();\n        },\n\n        hide: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-flex').addClass('d-none');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.show();\n        },\n\n        empty: function() {\n            $(this.selector + '.empty').removeClass('d-none').addClass('d-flex');\n            $(this.selector + ':not(.empty)').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.hide();\n        }\n    };\n\n    var crListLoader = {\n        selector: '.reports-list-body .reports-list-content.loader',\n\n        show: function() {\n            $(this.selector).removeClass('d-none').addClass('d-flex');\n        },\n\n        hide: function() {\n            $(this.selector).removeClass('d-flex').addClass('d-none');\n        }\n    };\n\n    var crList = {\n        selector: '.reports-list-body .reports-list-content',\n\n        show: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-none').addClass('d-flex');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            crListLoader.hide();\n        },\n\n        hide: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-flex').addClass('d-none');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            crListLoader.show();\n        },\n\n        empty: function() {\n            $(this.selector + '.empty').removeClass('d-none').addClass('d-flex');\n            $(this.selector + ':not(.empty)').removeClass('d-flex').addClass('d-none');\n            crListLoader.hide();\n        }\n    };\n\n    /**\n     * Get custum reports data.\n     */\n    function getCustomReportsData() {\n        if (reportsDataLoaded) {\n            reportsDataLoaded = false;\n            selectedFields = [];\n            cohorts = $(cfCohort).val();\n            courses = $(cfCourse).val();\n            $(cfCheckbox + \":checked\").each(function() {\n                selectedFields.push($(this).val());\n            });\n\n            if (selectedFields.length == 0) {\n                $(cfSave).prop('disabled', true);\n                reportsDataLoaded = true;\n            } else {\n                common.loader.show('#wdm-customreports-edit');\n                var getCustomReportsDataAjax = ajax.call([{\n                    methodname: 'local_edwiserreports_get_customreports_data',\n                    args: {\n                        params: JSON.stringify({\n                            fields: selectedFields,\n                            cohorts: cohorts,\n                            courses: courses\n                        })\n                    }\n                }]);\n                getCustomReportsDataAjax[0].done(function(response) {\n                    if (response.success) {\n                        var data = JSON.parse(response.data);\n                        if (data.reportsdata.length == 0) {\n                            cfPreview.empty();\n                            $(cfSave).prop('disabled', true);\n                        } else {\n                            if (cfPreviewTable) {\n                                cfPreviewTable.clear().destroy();\n                                $('#cr-preview-table').html('');\n                            }\n                            cfPreview.show();\n                            cfPreviewTable = $('#cr-preview-table').DataTable({\n                                columns: data.columns,\n                                dom: '<\"edwiserreports-table\"<\"table-filter d-flex\"f><t><\"table-pagination\"p>>',\n                                data: data.reportsdata,\n                                bInfo: false,\n                                bFilter: false,\n                                searching: false,\n                                lengthChange: false,\n                                drawCallback: function() {\n                                    $('#cr-preview-table').find('th').addClass('theme-3-bg text-white');\n                                    common.stylePaginationButton(this);\n                                }\n                            });\n                            $(cfSave).prop('disabled', false);\n                        }\n                    }\n                }).always(function() {\n                    reportsDataLoaded = true;\n                    common.loader.hide('#wdm-customreports-edit');\n                });\n            }\n        }\n    }\n\n    /**\n     * Validate custom reports data to save.\n     * @param {Object} data Custom report data object\n     * @return {Boolean}\n     */\n    function validateCustomReprtsSaveData(data) {\n        var ret = true;\n        if (data.reportname == '') {\n            $('#id_error_crb_reportname')\n                .html(M.util.get_string('emptyfullname', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n\n        if (data.reportshortname == '') {\n            $('#id_error_crb_reportshortname')\n                .html(M.util.get_string('emptyshortname', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n\n        // eslint-disable-next-line no-useless-escape\n        var format = /[ `!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?~]/;\n        if (format.test(data.reportshortname)) {\n            $('#id_error_crb_reportshortname')\n                .html(M.util.get_string('nospecialchar', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n        return ret;\n    }\n\n    /**\n     * Save custom reports data confirmation module.\n     */\n    function saveCustomReportsData() {\n        modalFactory.create({\n            title: customReportSaveTitle,\n            type: modalFactory.types.SAVE_CANCEL,\n            body: templates.render('local_edwiserreports/custom_reports_save_form', reportsData)\n        }).done(function(modal) {\n            var root = modal.getRoot();\n            root.find('.modal-dialog').addClass('modal-lg');\n            modal.getFooter().find('[data-action=\"save\"]').removeClass('btn-primary').addClass('theme-primary-bg text-white');\n            modal.show();\n\n            // Destroying modal on hide event.\n            root.on(modalEvents.hidden, function() {\n                modal.destroy();\n            });\n\n            // Saving modal data.\n            root.on(modalEvents.save, function(e) {\n                // Stop the default save button behaviour which is to close the modal.\n                e.preventDefault();\n\n                // Remove all error on type\n                root.find('input').on('input', function() {\n                    $('[id^=\"id_error_crb\"]').html('');\n                });\n\n                var data = $(cfSaveForm).serializeArray().reduce(function(obj, item) {\n                    obj[item.name] = item.value;\n                    return obj;\n                }, {});\n\n                if (validateCustomReprtsSaveData(data)) {\n                    // Prepare query data\n                    data.querydata = {\n                        'selectedfield': selectedFields,\n                        'cohorts': cohorts,\n                        'courses': courses\n                    };\n\n                    saveCustomReportsDataService(data, modal);\n                }\n            });\n        });\n    }\n\n    /**\n     * Save customo report data to database.\n     * @param {Object} data Custom report data\n     * @param {Moodle_Factory} modal Modal object\n     */\n    function saveCustomReportsDataService(data, modal) {\n        var saveCustomReportsData = ajax.call([{\n            methodname: 'local_edwiserreports_save_customreports_data',\n            args: {\n                params: JSON.stringify(data)\n            }\n        }]);\n\n        saveCustomReportsData[0].done(function(response) {\n            if (response.success) {\n                if (modal) {\n                    reportsData = JSON.parse(response.reportsdata);\n                    $(cpHeader).html(reportsData.reportname);\n                    $(cfSave).html(M.util.get_string('updatereports', 'local_edwiserreports'));\n                }\n                $('#user-notifications .close').click();\n                notif.addNotification({\n                    message: M.util.get_string('reportssavesuccess', 'local_edwiserreports'),\n                    type: \"success\"\n                });\n            } else {\n                $('#user-notifications .close').click();\n                notif.addNotification({\n                    message: response.errormsg,\n                    type: \"error\"\n                });\n            }\n            if (modal) {\n                $(\"html, body\").animate({ scrollTop: 0 }, \"slow\");\n                getCustomReportsList();\n                modal.hide();\n            }\n        });\n    }\n\n    /**\n     * Get reports list of custom reports.\n     */\n    function getCustomReportsList() {\n        var getCustomReportsList = ajax.call([{\n            methodname: 'local_edwiserreports_get_customreports_list',\n            args: {\n                params: JSON.stringify({})\n            }\n        }]);\n        getCustomReportsList[0].done(function(response) {\n            var data = JSON.parse(response.data);\n            if (response.success) {\n                if (data.length == 0) {\n                    crList.empty();\n                } else {\n                    if (crListTable) {\n                        crListTable.clear().destroy();\n                    }\n\n                    crListTable = $('#cr-list-table').DataTable({\n                        columns: [{\n                                data: 'fullname',\n                                title: M.util.get_string('title', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'createdby',\n                                title: M.util.get_string('createdby', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'datecreated',\n                                title: M.util.get_string('datecreated', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'datemodified',\n                                title: M.util.get_string('datemodified', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'managehtml',\n                                title: M.util.get_string('manage', 'local_edwiserreports'),\n                                orderable: false\n                            }\n                        ],\n                        dom: '<\"edwiserreports-table\"<t><\"table-pagination\"p>>',\n                        language: {\n                            searchPlaceholder: M.util.get_string('searchreports', 'local_edwiserreports'),\n                            emptyTable: M.util.get_string('noresult', 'local_edwiserreports')\n                        },\n                        order: [\n                            [0, 'asc']\n                        ],\n                        data: data,\n                        bInfo: false,\n                        lengthChange: false,\n                        drawCallback: function() {\n                            $('#cr-list-table').find('th').addClass('theme-3-bg text-white');\n                            common.stylePaginationButton(this);\n                        }\n                    });\n                    crList.show();\n                }\n            }\n        });\n    }\n\n    /**\n     * Delete custom reports data.\n     * @param {Integer} reportsId Report id\n     */\n    function customReportDelete(reportsId) {\n        var deleteCustomReport = ajax.call([{\n            methodname: 'local_edwiserreports_delete_custom_report',\n            args: {\n                params: JSON.stringify({ reportsid: reportsId })\n            }\n        }]);\n        deleteCustomReport[0].done(function(response) {\n            if (response.success) {\n                notif.addNotification({\n                    message: response.message,\n                    type: \"success\"\n                });\n            } else {\n                notif.addNotification({\n                    message: response.message,\n                    type: \"error\"\n                });\n            }\n        }).always(function() {\n            $(\"html, body\").animate({ scrollTop: 0 }, \"slow\");\n            getCustomReportsList();\n        });\n    }\n\n    /**\n     * Initialise custom reports events.\n     */\n    function customReportServiceInit() {\n        $(cfCheckbox).on('change', function() {\n            getCustomReportsData();\n        });\n        $(cfSelect).on('change', function() {\n            getCustomReportsData();\n        });\n        $(cfSave).on('click', function() {\n            saveCustomReportsData();\n        });\n        getCustomReportsList();\n        $(document).on('change', crDesktopEnableSwitch, function() {\n            var enabledesktop = false;\n            if ($(this).is(\":checked\")) {\n                enabledesktop = true;\n            }\n            var updateData = {\n                reportsid: $(this).data('reportsid'),\n                enabledesktop: enabledesktop,\n                action: 'enabledesktop'\n            };\n\n            saveCustomReportsDataService(updateData, false);\n        });\n        $(document).on('click', crDeleteBtn, function(e) {\n            e.preventDefault();\n\n            var reportId = $(this).data('reportsid');\n            str.get_strings([{\n                    key: 'deletecustomreportstitle',\n                    component: 'local_edwiserreports'\n                },\n                {\n                    key: 'deletecustomreportsquestion',\n                    component: 'local_edwiserreports'\n                },\n                {\n                    key: 'yes',\n                    component: 'moodle'\n                },\n                {\n                    key: 'no',\n                    component: 'moodle'\n                }\n            ]).done(function(s) {\n                notif.confirm(s[0], s[1], s[2], s[3], $.proxy(function() {\n                    customReportDelete(reportId);\n                }, e.currentTarget));\n            });\n        });\n        $(document).on('click', crHideBtn, function(e) {\n            e.preventDefault();\n\n            var checkboxId = $(this).data('target');\n            if ($(this).data('value')) {\n                $(this).attr('title', $(this).data('titlehide'));\n                $(this).attr('data-original-title', $(this).data('titlehide'));\n                $(this).data('value', 0);\n                $(this).attr('data-value', 0);\n            } else {\n                $(this).attr('title', $(this).data('titleshow'));\n                $(this).attr('data-original-title', $(this).data('titleshow'));\n                $(this).data('value', 1);\n                $(this).attr('data-value', 1);\n            }\n            $(this).find('.icon').toggleClass('fa-eye');\n            $(this).find('.icon').toggleClass('fa-eye-slash');\n            $(checkboxId).trigger('click');\n        });\n\n\n        // Search in table.\n        $('body').on('input', '.customreports-block-section .table-search-input input', function() {\n            crListTable.column(0).search(this.value).draw();\n        });\n\n        common.handleSearchInput();\n    }\n\n    return {\n        init: function() {\n            $(document).ready(function() {\n\n                $(document).on('click', '.field-group', function() {\n                    var id = this.id;\n                    $(this).toggleClass('open');\n                    $(\"[aria-control='\" + id + \"']\").toggleClass('show');\n                });\n\n                $(document).on('click', function(e) {\n                    let wrap = $(e.target).closest(\".field-group-wrap\");\n                    if (wrap.length === 0) {\n                        $('.field-group-wrap .field-group').removeClass('open');\n                        $('.field-group-wrap .field').removeClass('show');\n                        return;\n                    }\n                    let current = wrap.data('key') === 'user' ? 'course' : 'user';\n                    $(`.field-group-wrap[data-key='${current}'] .field-group`).removeClass('open');\n                    $(`.field-group-wrap[data-key='${current}'] .field`).removeClass('show');\n                });\n\n                customReportServiceInit();\n                reportsId = $(crPageId).val();\n                if (reportsId !== 0) {\n                    reportsData.reportsid = reportsId;\n                    reportsData.reportname = $(crPageFullname).val();\n                    reportsData.reportshortname = $(crPageShortname).val();\n\n                    if ($(crPageDownloadEnable).val() != 0) {\n                        reportsData.downloadenable = true;\n                    } else {\n                        reportsData.downloadenable = false;\n                    }\n\n                    if ($(crPageDesktopEnable).val() != 0) {\n                        reportsData.enabledesktop = true;\n                    } else {\n                        reportsData.enabledesktop = false;\n                    }\n\n                    getCustomReportsData();\n                }\n            });\n        }\n    };\n});\n"],"file":"customreportsblock.min.js"}