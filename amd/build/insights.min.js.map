{"version":3,"sources":["insights.js"],"names":["define","$","Notification","Templates","common","CFG","SELECTOR","CONTAINER","INSIGHT","ONLYINSIGHT","INSIGHT_WRAP","MOVELEFT","MOVERIGHT","HIDE","INSIGHT_ADD_CARD","INSIGHT_DROPDOWNMENU","INSIGHT_ITEM","filter","PROMISE","GET_INSIGHT_CARD_CONTEXT","id","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","JSON","stringify","GET_INSIGHT_CARD_DATA","updateOrder","order","loader","show","each","index","insight","push","edwrnewpreferenceapply","require","UserRepository","setUserPreference","util","set_user_preference","hide","updateInsight","done","response","rtl","value","render","html","js","replaceNode","find","init","document","ready","dateChange","date","on","prev","this","closest","detach","insertBefore","next","insertAfter","prepend","text","remove","present","editing","before","runTemplateJS","fail","exception","removeClass"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Page top insight management js.\n *\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine([\n    'jquery',\n    'core/notification',\n    'core/templates',\n    './common',\n    './defaultconfig'\n], function(\n    $,\n    Notification,\n    Templates,\n    common,\n    CFG\n) {\n\n    /**\n     * Selector for the insights.\n     */\n    let SELECTOR = {\n        CONTAINER: '.top-insights',\n        INSIGHT: '.top-insights .insight',\n        ONLYINSIGHT: '.top-insights .insight:not(.add-insight)',\n        INSIGHT_WRAP: '.insight-wrap',\n        MOVELEFT: '.top-insights .card-editing .move-left',\n        MOVERIGHT: '.top-insights .card-editing .move-right',\n        HIDE: '.top-insights .card-editing .edit-hide',\n        INSIGHT_ADD_CARD: '.top-insights .insight.add-insight',\n        INSIGHT_DROPDOWNMENU: '.top-insights .add-new-insight .dropdown-menu',\n        INSIGHT_ITEM: '.top-insights .add-new-insight .dropdown-item'\n    };\n\n    /**\n     * Filter object.\n     */\n    let filter = 'weekly';\n\n    /**\n     * Promise list.\n     */\n    let PROMISE = {\n        /**\n         * Get insight card data to render insight card.\n         * @param {String} id Insight id\n         * @returns {Promise}\n         */\n        GET_INSIGHT_CARD_CONTEXT: function(id) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_insight_card_context_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify({\n                        id: id\n                    })\n                },\n            });\n        },\n\n        /**\n         * Get insight card data to render insight details.\n         * @param {String} id Insight id\n         * @return {Promise}\n         */\n        GET_INSIGHT_CARD_DATA: function(id) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_insight_card_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify({\n                        id: id,\n                        filter: filter\n                    })\n                },\n            });\n        }\n    };\n\n    /**\n     * Update insight order in the user preference.\n     */\n    function updateOrder() {\n        let order = [];\n        common.loader.show(SELECTOR.CONTAINER);\n        $(SELECTOR.ONLYINSIGHT).each(function(index, insight) {\n            order.push($(insight).data('id'));\n        });\n        // eslint-disable-next-line no-undef\n        if (edwrnewpreferenceapply) {\n            require(['core_user/repository'], function(UserRepository) {\n                UserRepository.setUserPreference('local_edwiserreports_insights_order', JSON.stringify(order));\n            });\n        } else {\n            M.util.set_user_preference('local_edwiserreports_insights_order', JSON.stringify(order));\n        }\n        common.loader.hide(SELECTOR.CONTAINER);\n    }\n\n    /**\n     * Update insight card details.\n     * @param {String} id Insight id\n     */\n    function updateInsight(id) {\n        common.loader.show(SELECTOR.CONTAINER + ' [data-id=\"' + id + '\"] .insight-wrapper');\n        PROMISE.GET_INSIGHT_CARD_DATA(id, filter)\n            .done(function(response) {\n                var rtl = $('html').attr('dir') == 'rtl' ? 1 : 0;\n                switch (id) {\n                    case 'timespentoncourses':\n                        response.value = rtl ? '4 h &#x202B; 48 min&#x202C; 20 s' : '4 h 48 min 20 s';\n\n                    case 'timespentonsite':\n                        // response.value = common.timeFormatter(response.value, {\n                        //     dataPointIndex: 0,\n                        //     'short': true\n                        // }, rtl).replaceAll(', ', ' ');\n\n                        response.value = rtl ? '3 h &#x202B; 38 min&#x202C; 20 s' : '3 h 38 min 20 s';\n\n                        break;\n                }\n                Templates.render('local_edwiserreports/insights/content', response)\n                    .done(function(html, js) {\n                        Templates.replaceNode($(SELECTOR.INSIGHT + '[data-id=\"' + id + '\"]')\n                            .find(SELECTOR.INSIGHT_WRAP), html, js);\n                        common.loader.hide(SELECTOR.CONTAINER + ' [data-id=\"' + id + '\"] .insight-wrapper');\n                    });\n            });\n    }\n\n    /**\n     * Initialize events.\n     */\n    function initEvents() {\n        // Date selector listener.\n        common.dateChange(function(date) {\n            filter = date;\n            $(SELECTOR.ONLYINSIGHT).each(function(index, insight) {\n                updateInsight($(insight).data('id'));\n            });\n        });\n\n        // Move left.\n        $('body').on('click', SELECTOR.MOVELEFT, function() {\n            let prev = $(this).closest(SELECTOR.INSIGHT).prev();\n            $(this).closest(SELECTOR.INSIGHT).detach().insertBefore(prev);\n            updateOrder();\n        });\n\n        // Move Right.\n        $('body').on('click', SELECTOR.MOVERIGHT, function() {\n            let next = $(this).closest(SELECTOR.INSIGHT).next();\n            $(this).closest(SELECTOR.INSIGHT).detach().insertAfter(next);\n            updateOrder();\n        });\n\n        // Hide insight.\n        $('body').on('click', SELECTOR.HIDE, function() {\n            let insight = $(this).closest(SELECTOR.INSIGHT);\n            $(SELECTOR.INSIGHT_DROPDOWNMENU)\n                .prepend(`<a class=\"dropdown-item\" href=\"#\" data-id=\"${\n                    insight.data('id')\n                }\">${insight.find('.insight-title').text()}</a>`);\n            insight.remove();\n            updateOrder();\n        });\n\n        // Add insight.\n        $('body').on('click', SELECTOR.INSIGHT_ITEM, function() {\n            let id = $(this).data('id');\n            common.loader.hide(SELECTOR.CONTAINER);\n            PROMISE.GET_INSIGHT_CARD_CONTEXT(id).done(function(response) {\n                if (response.present == true) {\n                    response.editing = true;\n                    Templates.render('local_edwiserreports/insights/insight', response).done(function(html, js) {\n                        $(SELECTOR.INSIGHT_ADD_CARD).before(html);\n                        Templates.runTemplateJS(js);\n                        $(SELECTOR.INSIGHT_ITEM + '[data-id=\"' + id + '\"]').remove();\n                        updateOrder();\n                        updateInsight(id);\n                    });\n                }\n            }).fail(Notification.exception);\n        });\n    }\n\n    /**\n     * Initialize.\n     */\n    function init() {\n        $(document).ready(function() {\n            initEvents();\n            $(SELECTOR.ONLYINSIGHT).each(function(index, insight) {\n                updateInsight($(insight).data('id'));\n            });\n            $(SELECTOR.CONTAINER).find('.overflow-hidden').removeClass('overflow-hidden');\n        });\n    }\n    return {\n        init: init\n    };\n});\n"],"file":"insights.min.js"}