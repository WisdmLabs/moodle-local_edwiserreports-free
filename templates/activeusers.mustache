{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    Edwiser RemUI
    @package   theme_remui
    @copyright (c) 2020 WisdmLabs (https://wisdmlabs.com/)
    @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later

}}
{{!
    @template theme_remui/activity_navigation

    Display the activity navigation for all activities in a course

    Context variables required for this template:

    Example context (json):
    {
    }
}}
{{> local_edwiserreports/navigation }}
{{> local_edwiserreports/report-page-header }}
<div id="wdm-activeusers-individual" data-sesskey="{{sesskey}}">
    <div id="userfilter" class="h-auto mt-2">
        <div class="row">
            <div class="filter-selector col-12 col-md-3 mb-1">
                <label>{{#str}} search, local_edwiserreports {{/str}}</label>
                {{> local_edwiserreports/datatable/search }}
            </div>
            {{# cohortfilters }}
                <div class="filter-selector col-12 col-md-2 mb-1">
                    <label>{{#str}} cohort, local_edwiserreports {{/str}}</label>
                    <select class="cohort-select form-control singleselect" name="cohort-select">
                        {{#values}}
                            <option value="{{id}}">{{name}}</option>
                        {{/values}}
                    </select>
                </div>
            {{/ cohortfilters }}
            <div class="filter-selector col-12 col-md-3 mb-1">
                <label>{{#str}} date, local_edwiserreports {{/str}}</label>
                <button type="button" class="btn dropdown-toggle edwiserreports-calendar" data-toggle="dropdown" data-bs-toggle="dropdown" id="filter-dropdown" aria-expanded="false">
                    {{# str }} last7days, local_edwiserreports {{/ str }}
                </button>
                <ul class="dropdown-menu dropdown-scrollable dropdown-menu-end" aria-labelledby="filter-dropdown" role="menu">
                    <li><div class="dropdown-calendar"></div></li>
                    <li><div class="dropdown-body">
                        <a class="dropdown-item active" role="menuitem" data-value="last7days" href="javascript:void(0)">{{#str}} last7days, local_edwiserreports {{/str}}</a>
                        <a class="dropdown-item" role="menuitem" data-value="weekly" href="javascript:void(0)">{{#str}} lastweek, local_edwiserreports {{/str}}</a>
                        <a class="dropdown-item" role="menuitem" data-value="monthly" href="javascript:void(0)">{{#str}} lastmonth, local_edwiserreports {{/str}}</a>
                        <a class="dropdown-item" role="menuitem" data-value="yearly" href="javascript:void(0)">{{#str}} lastyear, local_edwiserreports {{/str}}</a>
                        <a class="dropdown-item custom" role="menuitem" href="javascript:void(0)">
                            <input class="border-0 p-0 bg-transparent flatpickr form-control" placeholder="{{#str}} customdate, local_edwiserreports {{/str}}" 0="data-input" />
                        </a>
                    </div></li>
                </ul>
            </div>
            <div class="filter-selector col-12 table-length-input ml-auto mb-3">
                <label>{{#str}} show, local_edwiserreports {{/str}}</label>
                {{> local_edwiserreports/datatable/length }}
            </div>
        </div>
    </div>
    <div class="table-responsive">
        {{> local_edwiserreports/activeuserstable }}
    </div>
    {{# export }}
        <div class="pull-right float-end px-5">
            {{> local_edwiserreports/exportreports }}
        </div>
    {{/ export }}
</div>
{{#setactive}}
    {{> local_edwiserreports/setactivenav }}
{{/setactive}}

<script>
// Enhanced dropdown toggle with Moodle version compatibility
document.addEventListener('DOMContentLoaded', function() {
    // Get the dropdown button and menu
    var button = document.getElementById('filter-dropdown');
    var menu = button ? button.nextElementSibling : null;
    
    if (!button || !menu || !menu.classList.contains('dropdown-menu')) {
        return;
    }
    
    // Detect Moodle version and Bootstrap version
    var hasBootstrap5 = typeof bootstrap !== 'undefined' && bootstrap.Dropdown;
    var hasBootstrap4 = typeof $ !== 'undefined' && $.fn && $.fn.dropdown;
    
    // Function to show dropdown
    function showDropdown() {
        if (hasBootstrap5) {
            // Bootstrap 5 method
            var bsDropdown = new bootstrap.Dropdown(button);
            bsDropdown.show();
        } else if (hasBootstrap4) {
            // Bootstrap 4 method
            $(button).dropdown('show');
        } else {
            // Fallback: manual show
            menu.classList.add('show');
        }
    }
    
    // Function to hide dropdown
    function hideDropdown() {
        if (hasBootstrap5) {
            // Bootstrap 5 method
            var bsDropdown = bootstrap.Dropdown.getInstance(button);
            if (bsDropdown) {
                bsDropdown.hide();
            }
        } else if (hasBootstrap4) {
            // Bootstrap 4 method
            $(button).dropdown('hide');
        } else {
            // Fallback: manual hide
            menu.classList.remove('show');
        }
    }
    
    // Add click handler to the button
    button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Check if dropdown is currently visible
        var isVisible = menu.classList.contains('show') || 
                       button.getAttribute('aria-expanded') === 'true';
        
        if (isVisible) {
            hideDropdown();
        } else {
            showDropdown();
        }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-selector')) {
            hideDropdown();
        }
    });
    
    // Handle dropdown item clicks
    menu.addEventListener('click', function(e) {
        var item = e.target.closest('.dropdown-item');
        if (!item || item.classList.contains('custom')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        var value = item.dataset.value;
        var text = item.textContent;
        
        // Update button text
        button.innerHTML = text;
        
        // Update active state
        menu.querySelectorAll('.dropdown-item').forEach(function(el) {
            el.classList.remove('active');
        });
        item.classList.add('active');
        
        // Hide dropdown
        hideDropdown();
        
        // Try to trigger existing functionality
        if (typeof window.activeUsersFilterChange === 'function') {
            window.activeUsersFilterChange(value);
        }
    });
});
</script>